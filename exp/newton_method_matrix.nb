(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 11.0' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[     47545,       1300]
NotebookOptionsPosition[     46873,       1271]
NotebookOutlinePosition[     47233,       1287]
CellTagsIndexPosition[     47190,       1284]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{

Cell[CellGroupData[{
Cell["Newton Method Matrix form", "Title",
 CellChangeTimes->{{3.700571518173517*^9, 3.700571538199051*^9}}],

Cell[CellGroupData[{

Cell["Util", "Section",
 CellChangeTimes->{{3.700511269181332*^9, 3.7005112819271708`*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{
   "Change", " ", "TensorProduct", " ", "to", " ", "act", " ", "like", " ", 
    "Kronecker", " ", "product"}], " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"Unprotect", "[", "TensorProduct", "]"}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"TensorProduct", "=", "KroneckerProduct"}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Protect", "[", "TensorProduct", "]"}], ";"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"On", "[", "Assert", "]"}], ";"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{
     RowBox[{"column", " ", "vectorize"}], ",", " ", 
     RowBox[{"following", " ", "Magnus"}], ",", " ", "1999"}], " ", "*)"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"vec", "[", "W_", "]"}], ":=", 
     RowBox[{"Transpose", "@", 
      RowBox[{"{", 
       RowBox[{"Flatten", "@", 
        RowBox[{"Transpose", "[", "W", "]"}]}], "}"}]}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"unvec", "[", 
      RowBox[{"Wf_", ",", " ", "rows_"}], "]"}], ":=", 
     RowBox[{"Transpose", "[", 
      RowBox[{"Flatten", "/@", 
       RowBox[{"Partition", "[", 
        RowBox[{"Wf", ",", "rows"}], "]"}]}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"toscalar", "[", "v_", "]"}], ":=", 
     RowBox[{"Block", "[", 
      RowBox[{
       RowBox[{"{", "t", "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"t", "=", 
         RowBox[{"Flatten", "@", "v"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"Assert", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"Length", "[", "t", "]"}], "\[Equal]", "1"}], ",", " ", 
          "\"\<scalar assert\>\""}], "]"}], ";", "\[IndentingNewLine]", 
        RowBox[{"First", "@", "t"}]}]}], "\[IndentingNewLine]", "]"}]}], 
    ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"v2c", "[", "c_", "]"}], ":=", 
    RowBox[{"Transpose", "[", 
     RowBox[{"{", "c", "}"}], "]"}]}], " ", 
   RowBox[{"(*", " ", 
    RowBox[{"turns", " ", "vector", " ", "to", " ", "column", " ", "matrix"}],
     " ", "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"v2r", "[", "c_", "]"}], ":=", 
    RowBox[{"{", "c", "}"}]}], " ", 
   RowBox[{"(*", " ", 
    RowBox[{"turns", " ", "vector", " ", "to", " ", "row", " ", "matrix"}], 
    " ", "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"c2v", "[", "c_", "]"}], ":=", 
    RowBox[{"Flatten", "[", "c", "]"}]}], " ", 
   RowBox[{"(*", " ", 
    RowBox[{
    "turns", " ", "column", " ", "matrix", " ", "into", " ", "vector"}], " ", 
    "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{"Partitions", " ", "matrix", " ", "into", " ", "blocks", " ", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"axa", ",", "axb"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"bxa", ",", "bxb"}], "}"}]}], "}"}]}], " ", "*)"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"partitionMatrix", "[", 
      RowBox[{"mat_", ",", 
       RowBox[{"{", 
        RowBox[{"a_", ",", "b_"}], "}"}]}], "]"}], ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"Assert", "[", 
           RowBox[{
            RowBox[{"a", "+", "b"}], "\[Equal]", 
            RowBox[{"Length", "@", "mat"}]}], "]"}], ";", 
          "\[IndentingNewLine]", "Assert", ";"}], "[", 
         RowBox[{
          RowBox[{"a", "+", "b"}], "\[Equal]", 
          RowBox[{
           RowBox[{"Length", "@", "mat"}], "\[Transpose]"}]}], "]"}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"Internal`PartitionRagged", "[", 
         RowBox[{"mat", ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"a", ",", "b"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"a", ",", "b"}], "}"}]}], "}"}]}], "]"}]}]}], 
      "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{
     RowBox[{"Commutation", " ", "matrix", " ", "m"}], ",", "n"}], " ", 
    "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"Kmat", "[", 
      RowBox[{"m_", ",", "n_"}], "]"}], ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
        "x", ",", "X", ",", "before", ",", "after", ",", "positions", ",", 
         "matrix"}], "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"X", "=", 
         RowBox[{"Array", "[", 
          RowBox[{"x", ",", 
           RowBox[{"{", 
            RowBox[{"m", ",", "n"}], "}"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"before", "=", 
         RowBox[{"Flatten", "@", 
          RowBox[{"vec", "@", "X"}]}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"after", "=", 
         RowBox[{"Flatten", "@", 
          RowBox[{"vec", "@", 
           RowBox[{"Transpose", "[", "X", "]"}]}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"positions", "=", 
         RowBox[{"MapIndexed", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{"First", "@", "#2"}], ",", 
              RowBox[{"First", "@", 
               RowBox[{"Flatten", "@", 
                RowBox[{"Position", "[", 
                 RowBox[{"before", ",", "#"}], "]"}]}]}]}], "}"}], "&"}], ",",
            "after"}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"matrix", "=", 
         RowBox[{"SparseArray", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"#", "\[Rule]", "1"}], "&"}], "/@", "positions"}], 
          "]"}]}]}]}], "\[IndentingNewLine]", "]"}]}], ";"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"take1", "[", "x_", "]"}], ":=", 
     RowBox[{"First", "@", 
      RowBox[{"Flatten", "@", "x"}]}]}], ";"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"robustMin", "[", "x_", "]"}], ":=", 
     RowBox[{"Min", "[", 
      RowBox[{"Select", "[", 
       RowBox[{
        RowBox[{"Flatten", "@", "x"}], ",", 
        RowBox[{
         RowBox[{"#", ">", "1*^-10"}], "&"}]}], "]"}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{"Symmetric", " ", "square", " ", "root"}], " ", "*)"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"symsqrt", "[", "m_", "]"}], ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"U", ",", "S", ",", "W"}], "}"}], ",", "\[IndentingNewLine]", 
       
       RowBox[{
        RowBox[{
         RowBox[{"{", 
          RowBox[{"U", ",", "S", ",", "W"}], "}"}], "=", 
         RowBox[{"SingularValueDecomposition", "[", "m", "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"U", ".", 
         RowBox[{"Sqrt", "[", "S", "]"}], ".", 
         RowBox[{"Transpose", "[", "W", "]"}]}]}]}], "\[IndentingNewLine]", 
      "]"}]}], ";"}], "\n", "\n", 
   RowBox[{"(*", " ", 
    RowBox[{
    "divide", " ", "object", " ", "by", " ", "sum", " ", "of", " ", "its", 
     " ", "elements"}], " ", "*)"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"normalize", "[", "x_", "]"}], ":=", 
     RowBox[{"x", "/", 
      RowBox[{"Total", "[", 
       RowBox[{"x", ",", " ", "10"}], "]"}]}]}], ";"}], "\n", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{
    "Random", " ", "uniform", " ", "vector", " ", "normalized", " ", "to", 
     " ", "1"}], " ", "*)"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"randomD", "[", "f_", "]"}], ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", "temp", "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"temp", "=", 
         RowBox[{"RandomReal", "[", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"0", ",", "1"}], "}"}], ",", 
           RowBox[{"{", "f", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"temp", "/", 
         RowBox[{"Total", "[", "temp", "]"}]}]}]}], "\[IndentingNewLine]", 
      "]"}]}], ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{
    "centers", " ", "data", " ", "where", " ", "batch", " ", "dimension", " ",
      "is", " ", "1"}], " ", "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"centerData", "[", "X_", "]"}], ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", "Xc", "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Xc", "=", 
         RowBox[{"Mean", "@", 
          RowBox[{"Transpose", "@", "X"}]}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"Transpose", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"#", "-", "Xc"}], "&"}], "/@", 
          RowBox[{"Transpose", "[", "X", "]"}]}], "]"}]}]}], 
      "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", "\n", 
   RowBox[{
    RowBox[{"khatriRao", "[", 
     RowBox[{"A_", ",", "B_"}], "]"}], ":=", 
    RowBox[{
     RowBox[{"MapThread", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Flatten", "[", 
         RowBox[{
          RowBox[{"{", "#1", "}"}], "\[TensorProduct]", 
          RowBox[{"{", "#2", "}"}]}], "]"}], "&"}], ",", 
       RowBox[{"Transpose", "/@", 
        RowBox[{"{", 
         RowBox[{"A", ",", "B"}], "}"}]}]}], "]"}], "//", "Transpose"}]}], 
   "\n", "\n", 
   RowBox[{"(*", " ", 
    RowBox[{"takes", " ", 
     RowBox[{"sizes", " ", "[", 
      RowBox[{"s1", ",", "s2", ",", ".."}], "]"}], " ", "partitions", " ", 
     "vec", " ", "into", " ", "those", " ", "sizes"}], " ", "*)"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"listPartition", "[", 
      RowBox[{"list_", ",", "sizes_"}], "]"}], ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"offsets", ",", "offsetPairs"}], "}"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Assert", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"Length", "@", "list"}], "\[Equal]", 
           RowBox[{"Total", "@", "sizes"}]}], ",", " ", 
          "\"\<can't partition\>\""}], "]"}], ";", "\[IndentingNewLine]", 
        RowBox[{"offsets", "=", 
         RowBox[{
          RowBox[{"{", "0", "}"}], "~", "Join", "~", 
          RowBox[{"FoldList", "[", 
           RowBox[{"Plus", ",", "sizes"}], "]"}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"offsetPairs", "=", 
         RowBox[{"Partition", "[", 
          RowBox[{"offsets", ",", "2", ",", "1"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"list", "[", 
           RowBox[{"[", 
            RowBox[{
             RowBox[{
              RowBox[{"#", "[", 
               RowBox[{"[", "1", "]"}], "]"}], "+", "1"}], ";;", 
             RowBox[{"#", "[", 
              RowBox[{"[", "2", "]"}], "]"}]}], "]"}], "]"}], "&"}], "/@", 
         "offsetPairs"}]}]}], "\[IndentingNewLine]", "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Assert", "[", 
     RowBox[{
      RowBox[{"listPartition", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"1", ",", "2", ",", "3", ",", "4", ",", "5"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"3", ",", "2"}], "}"}]}], "]"}], "\[Equal]", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"1", ",", "2", ",", "3"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"4", ",", "5"}], "}"}]}], "}"}]}], "]"}], ";"}], "\n", "\n", 
   
   RowBox[{"(*", " ", 
    RowBox[{"approximate", " ", "equality", " ", "testing"}], " ", "*)"}], 
   "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"DotEqual", "[", 
      RowBox[{"a_", ",", "b_"}], "]"}], ":=", 
     RowBox[{
      RowBox[{"Norm", "[", 
       RowBox[{
        RowBox[{"Flatten", "[", 
         RowBox[{"{", "a", "}"}], "]"}], "-", 
        RowBox[{"Flatten", "[", 
         RowBox[{"{", "b", "}"}], "]"}]}], "]"}], "<", "1*^-10"}]}], ";"}], 
   "\[IndentingNewLine]", "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"nbTOC", "[", "nb_", "]"}], ":=", 
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{"Button", "[", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"Mouseover", "[", 
             RowBox[{"#", ",", 
              RowBox[{"Style", "[", 
               RowBox[{"#", ",", "\"\<HyperlinkActive\>\""}], "]"}]}], "]"}], 
            "&"}], "@", 
           RowBox[{"First", "@", 
            RowBox[{"NotebookRead", "@", "#"}]}]}], ",", 
          RowBox[{"SelectionMove", "[", 
           RowBox[{"#", ",", "All", ",", "CellContents"}], "]"}], ",", 
          RowBox[{"Appearance", "\[Rule]", "None"}], ",", 
          RowBox[{"BaseStyle", "\[Rule]", "\"\<Hyperlink\>\""}], ",", 
          RowBox[{"Alignment", "\[Rule]", "Left"}], ",", 
          RowBox[{"ImageSize", "\[Rule]", "100"}]}], "]"}], "&"}], "/@", 
       RowBox[{"Cells", "[", 
        RowBox[{"CellStyle", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{
          "\"\<Title\>\"", ",", "\"\<Chapter\>\"", ",", "\"\<Section\>\"", 
           ",", "\"\<Subsection\>\"", ",", "\"\<Subsubsection\>\""}], "}"}]}],
         "]"}]}], "//", 
      RowBox[{
       RowBox[{"CreatePalette", "[", 
        RowBox[{
         RowBox[{"Panel", "[", 
          RowBox[{
           RowBox[{"Column", "[", 
            RowBox[{"#", ",", 
             RowBox[{"Dividers", "\[Rule]", "Center"}]}], "]"}], ",", 
           RowBox[{"ImageSize", "\[Rule]", "100"}]}], "]"}], ",", 
         RowBox[{"FrontEnd`ClosingSaveDialog", "\[Rule]", "False"}], ",", 
         RowBox[{"WindowTitle", "\[Rule]", "\"\<Table of Contents\>\""}], ",", 
         RowBox[{"Magnification", "\[Rule]", "1.5"}]}], "]"}], "&"}]}]}], 
    ";"}], "\n", 
   RowBox[{
    RowBox[{"nbTOC", "[", 
     RowBox[{"Optional", "[", 
      RowBox[{"Automatic", ",", "Automatic"}], "]"}], "]"}], ":=", 
    RowBox[{"nbTOC", "@", 
     RowBox[{"EvaluationNotebook", "[", "]"}]}]}], "\[IndentingNewLine]", 
   "\n", "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{
    "Things", " ", "more", " ", "specific", " ", "to", " ", "natural", " ", 
     "gradient", " ", "stuff"}], " ", "*)"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{"partitions", " ", "matrix", " ", "into", " ", "blocks"}], " ", 
    "*)"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"partitionMatrix", "[", 
      RowBox[{"mat_", ",", "sizes_"}], "]"}], ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{"Internal`PartitionRagged", "[", 
        RowBox[{"mat", ",", 
         RowBox[{"{", 
          RowBox[{"sizes", ",", "sizes"}], "}"}]}], "]"}]}], 
      "\[IndentingNewLine]", "]"}]}], ";"}], "\n", "\n", 
   RowBox[{"(*", " ", 
    RowBox[{
     RowBox[{"extracts", " ", "i"}], ",", 
     RowBox[{
      RowBox[{"j", "'"}], "th", " ", "block"}], ",", " ", 
     RowBox[{"taking", " ", "sizes", " ", "from", " ", "fsizes"}]}], " ", 
    "*)"}], "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{"TODO", ":", " ", 
     RowBox[{"generalize", " ", "fs"}]}], " ", "*)"}], "\[IndentingNewLine]", 
   
   RowBox[{
    RowBox[{
     RowBox[{"matrixBlock", "[", 
      RowBox[{"i_", ",", "j_", ",", "mat_"}], "]"}], ":=", 
     RowBox[{"(", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"msizes", "=", 
        RowBox[{"Times", "@@@", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"Partition", "[", 
            RowBox[{"fs", ",", "2", ",", "1"}], "]"}], "//", "Rest"}], 
          ")"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"partitionMatrix", "[", 
         RowBox[{"mat", ",", "msizes"}], "]"}], "[", 
        RowBox[{"[", 
         RowBox[{"i", ",", "j"}], "]"}], "]"}]}], "\[IndentingNewLine]", 
      ")"}]}], ";"}], "\n", "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{"extracts", " ", 
     RowBox[{"i", "'"}], "th", " ", "block", " ", "from", " ", "vector"}], 
    " ", "*)"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"vectorBlock", "[", 
      RowBox[{"i_", ",", "vec_"}], "]"}], ":=", 
     RowBox[{"(", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"msizes", "=", 
        RowBox[{"Times", "@@@", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"Partition", "[", 
            RowBox[{"fs", ",", "2", ",", "1"}], "]"}], "//", "Rest"}], 
          ")"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"listPartition", "[", 
         RowBox[{"vec", ",", "msizes"}], "]"}], "[", 
        RowBox[{"[", "i", "]"}], "]"}]}], "\[IndentingNewLine]", ")"}]}], 
    ";"}], "\n", "\n", "\n", 
   RowBox[{"(*", " ", 
    RowBox[{
     RowBox[{"converts", " ", "bool", " ", "to", " ", "0"}], ",", "1"}], " ", 
    "*)"}], "\n", 
   RowBox[{
    RowBox[{"fromBool", "[", "x_", "]"}], ":=", 
    RowBox[{"If", "[", 
     RowBox[{"x", ",", "1", ",", "0"}], "]"}]}], "\n", 
   RowBox[{"SetAttributes", "[", 
    RowBox[{"fromBool", ",", " ", "Listable"}], "]"}], "\n", "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"flatten", "[", "Ws_", "]"}], ":=", 
     RowBox[{"c2v", "[", 
      RowBox[{"vec", "/@", "Ws"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"unflatten", "[", "Wf_", "]"}], ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"flatVars", ",", "sizes"}], "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"sizes", "=", 
         RowBox[{"Rest", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Times", "@@", "#"}], "&"}], "/@", 
           RowBox[{"Partition", "[", 
            RowBox[{"fs", ",", "2", ",", "1"}], "]"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"flatVars", "=", 
         RowBox[{"listPartition", "[", 
          RowBox[{"Wf", ",", "sizes"}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{"unvec", "[", 
           RowBox[{
            RowBox[{"flatVars", "[", 
             RowBox[{"[", "i", "]"}], "]"}], ",", 
            RowBox[{"fs", "[", 
             RowBox[{"[", 
              RowBox[{"i", "+", "2"}], "]"}], "]"}]}], "]"}], ",", 
          RowBox[{"{", 
           RowBox[{"i", ",", "1", ",", 
            RowBox[{"Length", "@", "sizes"}]}], "}"}]}], "]"}]}]}], 
      "\[IndentingNewLine]", "]"}]}], ";"}], "\n", "\n", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{"creates", " ", "column", " ", "of", " ", "ones"}], " ", "*)"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"oneCol", "[", "n_", "]"}], ":=", 
     RowBox[{"v2c", "@", 
      RowBox[{"Table", "[", 
       RowBox[{"1", ",", 
        RowBox[{"{", 
         RowBox[{"i", ",", "n"}], "}"}]}], "]"}]}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"oneRow", "[", "n_", "]"}], ":=", 
     RowBox[{"v2r", "@", 
      RowBox[{"Table", "[", 
       RowBox[{"1", ",", 
        RowBox[{"{", 
         RowBox[{"i", ",", "n"}], "}"}]}], "]"}]}]}], ";"}]}]}]], "Code",
 CellChangeTimes->{{3.699549275986102*^9, 3.699549339228649*^9}, {
   3.69954975851676*^9, 3.699549786585791*^9}, {3.699561457247508*^9, 
   3.699561462172862*^9}, {3.699561822851487*^9, 3.6995618491288643`*^9}, 
   3.699562247517115*^9, {3.699642980523972*^9, 3.69964299840254*^9}, {
   3.699644247442046*^9, 3.6996442478015223`*^9}, {3.699644437416765*^9, 
   3.699644439279387*^9}, {3.699644576378022*^9, 3.699644579002046*^9}, 
   3.6996447162861023`*^9, {3.699713696139348*^9, 3.699713810756341*^9}, {
   3.699713948671307*^9, 3.6997139545810328`*^9}, {3.699807236268237*^9, 
   3.699807257598522*^9}, {3.699914522898534*^9, 3.699914524151675*^9}, {
   3.699917185751142*^9, 3.6999171972468967`*^9}, {3.6999701127397823`*^9, 
   3.6999701331862917`*^9}, {3.699970892851284*^9, 3.699970894407498*^9}, {
   3.699981470677924*^9, 3.6999815023713007`*^9}, {3.699982800717115*^9, 
   3.6999828013169413`*^9}, {3.7003253038948174`*^9, 3.700325323290061*^9}, {
   3.7003348374800997`*^9, 3.700334845173471*^9}, {3.7004002920265636`*^9, 
   3.700400308205324*^9}, {3.700400342763562*^9, 3.700400375040761*^9}, {
   3.700400475010377*^9, 3.700400476181603*^9}, {3.70040080525524*^9, 
   3.700400821679696*^9}, 3.700404956189498*^9, {3.7004201525093603`*^9, 
   3.700420198954833*^9}, {3.700420234510708*^9, 3.700420237805414*^9}, {
   3.70042084544526*^9, 3.7004208532301483`*^9}, {3.700422054701887*^9, 
   3.700422075220457*^9}, {3.700423609457384*^9, 3.700423612955349*^9}, {
   3.7005180876775427`*^9, 3.700518096763232*^9}, {3.70057883811094*^9, 
   3.700578845749639*^9}, {3.700578877519827*^9, 3.700578901189155*^9}, {
   3.700578937212184*^9, 3.700578951325708*^9}, {3.700579227609962*^9, 
   3.700579227879118*^9}}],

Cell[BoxData[""], "Input",
 CellChangeTimes->{{3.700334917400063*^9, 3.7003349177753143`*^9}, {
  3.700400325991004*^9, 3.7004003383536777`*^9}}]
}, Open  ]],

Cell[CellGroupData[{

Cell["Main", "Section",
 CellChangeTimes->{{3.70057854386545*^9, 3.7005785505027*^9}}],

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Clear", "[", 
    RowBox[{
    "lossEq", ",", "n", ",", "dsize", ",", "W", ",", "U", ",", "makeW", ",", 
     "vars", ",", "allvars", ",", "A", ",", "B", ",", "Bn", ",", "hessBlock", 
     ",", "hess", ",", "gradBlock", ",", "grad", ",", "sub1", ",", "subr", 
     ",", "y", ",", "f"}], "]"}], ";"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{"Globals", ":", "\[IndentingNewLine]", "lossEq", ":", " ", 
     RowBox[{"equation", " ", "for", " ", "loss", "\[IndentingNewLine]", 
      RowBox[{"errEq", ":", " ", 
       RowBox[{"equation", " ", "for", " ", "error", "\n", "n"}], ":", " ", 
       RowBox[{"number", " ", "of", " ", "layers", "\n", 
        RowBox[{"dsize", ":", " ", 
         RowBox[{"number", " ", "of", " ", "datapoints"}]}]}]}]}]}], ",", " ", 
    RowBox[{"aka", " ", 
     RowBox[{"f", "[", 
      RowBox[{"-", "1"}], "]"}], "\n", 
     RowBox[{"fs", ":", " ", 
      RowBox[{"list", " ", "of", " ", "sizes", "\n", 
       RowBox[{"f", "[", "i", "]"}]}], ":", " ", 
      RowBox[{"gives", " ", "dims"}]}]}], ",", " ", 
    RowBox[{"f", "[", "i", "]"}], ",", 
    RowBox[{
     RowBox[{
      RowBox[{"f", "[", 
       RowBox[{"i", "-", "1"}], "]"}], " ", "is", " ", "dimension", " ", "of",
       " ", "layer", " ", "i", "\n", 
      RowBox[{"W", "[", 
       RowBox[{"i", ",", "j"}], "]"}]}], ":", " ", 
     RowBox[{
      RowBox[{
       RowBox[{"multiply", " ", 
        RowBox[{"W", "[", "i", "]"}], 
        RowBox[{"W", "[", 
         RowBox[{"i", "-", "1"}], "]"}]}], ".."}], 
      RowBox[{"W", "[", "j", "]"}], "\n", 
      RowBox[{"U", "[", 
       RowBox[{"i", ",", "j"}], "]"}]}], ":", " ", 
     RowBox[{
      RowBox[{
       RowBox[{"multiply", " ", 
        RowBox[{"U", "[", "i", "]"}], 
        RowBox[{"U", "[", 
         RowBox[{"i", "+", "1"}], "]"}]}], "..."}], 
      RowBox[{"U", "[", "j", "]"}], "\n", 
      RowBox[{"makeW", "[", "i", "]"}]}], ":", " ", 
     RowBox[{"creates", " ", "matrix", " ", "of", " ", "form", " ", 
      RowBox[{"{", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{
          RowBox[{"W", "[", "0", "]"}], "[", 
          RowBox[{"1", ",", "1"}], "]"}], ",", 
         RowBox[{
          RowBox[{"W", "[", "0", "]"}], "[", 
          RowBox[{"1", ",", "2"}], "]"}], ",", 
         RowBox[{"...", "\n", 
          RowBox[{"vars", ":", " ", 
           RowBox[{"contains", " ", "all", " ", 
            RowBox[{"W", "'"}], "s", " ", "except", " ", "W0", " ", 
            RowBox[{"(", 
             RowBox[{"same", " ", "as", " ", "X"}], ")"}], "\n", "allvars"}], 
           ":", " ", 
           RowBox[{"contains", " ", "all", " ", 
            RowBox[{"W", "'"}], "s", "\n", 
            RowBox[{"A", "[", "i", "]"}]}]}]}], ",", 
         RowBox[{"B", "[", "i", "]"}], ",", 
         RowBox[{
          RowBox[{
           RowBox[{"B", "[", "i", "]"}], ".", 
           RowBox[{
            RowBox[{"A", "[", "i", "]"}], "\[Transpose]"}]}], " ", "define", 
          " ", "activation"}], ",", " ", "backprop", ",", " ", 
         RowBox[{
          RowBox[{"gradient", " ", "for", " ", "layer", " ", "i", "\n", 
           RowBox[{"Bn", "[", "i", "]"}], " ", "truncated", " ", "backprop", 
           " ", "for", " ", 
           RowBox[{"Newton", "'"}], "s", " ", "method", "\n", 
           RowBox[{"hessBlock", "[", 
            RowBox[{"i", ",", "j"}], "]"}], " ", "gives", " ", "Hessian", " ",
            "of", " ", "layer", " ", "i", " ", "with", " ", "respect", " ", 
           "to", " ", "layer", " ", "j", "\n", 
           RowBox[{"hess", "[", 
            RowBox[{"i", ",", "j"}], "]"}], " ", "gives", " ", "Mathematica", 
           " ", "derived", " ", "Hessian", " ", "of", " ", "layer", " ", "i", 
           " ", "with", " ", "respect", " ", "to", " ", "layer", " ", "j", 
           "\n", 
           RowBox[{"gradBlock", "[", "i", "]"}], " ", "gives", " ", 
           "gradient", " ", "at", " ", "layer", " ", "i", "\n", 
           RowBox[{"grad", "[", "i", "]"}]}], ":", " ", 
          RowBox[{
          "gives", " ", "Mathematica", " ", "gradient", " ", "of", " ", 
           "layer", " ", "i", "\n", "sub1"}], ":", " ", 
          RowBox[{"replaces", " ", "all", " ", 
           RowBox[{"W", "'"}], "s", " ", "and", " ", 
           RowBox[{"Y", "'"}], "s", " ", "with", " ", 
           RowBox[{"1", "'"}], "s", "\n", 
           RowBox[{"subr", ":", " ", 
            RowBox[{
             RowBox[{"replaces", " ", "all", " ", 
              RowBox[{"W", "'"}], "s", " ", "and", " ", 
              RowBox[{"Y", "'"}], "s", " ", "with", " ", "fixed", " ", 
              "random"}], "-", 
             RowBox[{"looking", " ", "number"}]}]}]}]}]}], "\n"}]}]}]}]}], 
   "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{"Number", " ", "of", " ", "features", " ", "per", " ", "layer"}], 
   " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{"Number", " ", "of", " ", "layers"}], ",", " ", 
    RowBox[{"aka", " ", "number", " ", "of", " ", "matmuls"}]}], " ", "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{
     RowBox[{"f", "[", "i", "]"}], " ", "shorthand", " ", "for", " ", 
     "shape"}], ",", " ", 
    RowBox[{
     RowBox[{"W", "[", "i", "]"}], " ", "has", " ", "dimensions", " ", 
     RowBox[{"f", "[", "i", "]"}], 
     RowBox[{"xf", "[", 
      RowBox[{"i", "-", "1"}], "]"}]}]}], " ", "*)"}], "\[IndentingNewLine]", 
  
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{"f", "[", 
     RowBox[{"-", "1"}], "]"}], " ", "is", " ", "shorthand", " ", "for", " ", 
    "dsize"}], " ", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"fs", "=", 
   RowBox[{"{", 
    RowBox[{"10", ",", "2", ",", "2", ",", "2"}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"n", "=", 
   RowBox[{
    RowBox[{"Length", "[", "fs", "]"}], "-", "2"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Block", "[", 
   RowBox[{
    RowBox[{"{", "i", "}"}], ",", 
    RowBox[{"For", "[", 
     RowBox[{
      RowBox[{"i", "=", "1"}], ",", " ", 
      RowBox[{"i", "\[LessEqual]", 
       RowBox[{"Length", "[", "fs", "]"}]}], ",", 
      RowBox[{"i", "++"}], ",", 
      RowBox[{
       RowBox[{"f", "[", 
        RowBox[{"i", "-", "2"}], "]"}], "=", 
       RowBox[{"fs", "[", 
        RowBox[{"[", "i", "]"}], "]"}]}]}], "]"}]}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"dsize", "=", 
    RowBox[{"f", "[", 
     RowBox[{"-", "1"}], "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"makeW", "[", "k_", "]"}], ":=", 
   RowBox[{"Array", "[", 
    RowBox[{
     RowBox[{"W", "[", "k", "]"}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"f", "[", "k", "]"}], ",", 
       RowBox[{"f", "[", 
        RowBox[{"k", "-", "1"}], "]"}]}], "}"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"vars", "=", 
    RowBox[{"Table", "[", 
     RowBox[{
      RowBox[{"makeW", "[", "k", "]"}], ",", 
      RowBox[{"{", 
       RowBox[{"k", ",", "1", ",", "n"}], "}"}]}], "]"}]}], ";", " ", 
   RowBox[{"(*", " ", 
    RowBox[{"W1", ",", " ", "W2", ",", " ", "...", ",", " ", "Wn"}], " ", 
    "*)"}], "\[IndentingNewLine]", 
   RowBox[{"allvars", "=", 
    RowBox[{"Table", "[", 
     RowBox[{
      RowBox[{"makeW", "[", "k", "]"}], ",", 
      RowBox[{"{", 
       RowBox[{"k", ",", "0", ",", "n"}], "}"}]}], "]"}]}], ";", " ", 
   RowBox[{"(*", " ", 
    RowBox[{
    "W0", ",", " ", "W1", ",", " ", "W2", ",", " ", "...", ",", " ", "Wn"}], 
    " ", "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"Y", "=", 
    RowBox[{"Array", "[", 
     RowBox[{"y", ",", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"f", "[", "n", "]"}], ",", 
        RowBox[{"f", "[", 
         RowBox[{"-", "1"}], "]"}]}], "}"}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"errEq", "=", 
   RowBox[{"Y", "-", 
    RowBox[{"Fold", "[", 
     RowBox[{"Dot", ",", 
      RowBox[{"Reverse", "@", "allvars"}]}], "]"}]}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"lossEq", "=", 
    RowBox[{
     RowBox[{"1", "/", "2"}], 
     RowBox[{
      RowBox[{"Tr", "[", 
       RowBox[{
        RowBox[{"errEq", "\[Transpose]"}], ".", "errEq"}], "]"}], "/", 
      "dsize"}]}]}], ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{"Partial", " ", 
    RowBox[{"products", ".", " ", "Shorthand"}], " ", "notation", " ", "for", 
    " ", "doing", " ", "product", " ", "of", " ", "all", " ", "layers", " ", 
    "between", " ", "j", " ", "and", " ", "i", " ", 
    RowBox[{
     RowBox[{"(", "inclusive", ")"}], ".", " ", "W"}], " ", "refers", " ", 
    "to", " ", "original", " ", "sums", " ", "and", " ", "U", " ", "is", " ", 
    "transpose"}], " ", "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
  
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{"W", "[", 
     RowBox[{"i", ",", "j"}], "]"}], "=", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"W", "[", "j", "]"}], ".", 
       RowBox[{"W", "[", 
        RowBox[{"j", "-", "1"}], "]"}]}], "..."}], 
     RowBox[{"W", "[", "i", "]"}]}]}], " ", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"W", "[", 
    RowBox[{"bottom_", ",", "top_"}], "]"}], ":=", 
   RowBox[{
    RowBox[{"IdentityMatrix", "[", 
     RowBox[{"f", "[", "bottom", "]"}], "]"}], "/;", 
    RowBox[{"bottom", "<", "top"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"W", "[", 
     RowBox[{"bottom_", ",", "top_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "sublist", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"Assert", "[", 
        RowBox[{
         RowBox[{"top", "\[LessEqual]", "bottom"}], ",", 
         "\"\<W ordering\>\""}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"sublist", "=", 
        RowBox[{"allvars", "[", 
         RowBox[{"[", 
          RowBox[{
           RowBox[{"top", "+", "1"}], ";;", 
           RowBox[{"bottom", "+", "1"}]}], "]"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"Fold", "[", 
        RowBox[{"Dot", ",", 
         RowBox[{"Reverse", "@", "sublist"}]}], "]"}]}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{"U", "[", 
     RowBox[{"i", ",", "j"}], "]"}], "=", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"U", "[", "i", "]"}], ".", 
       RowBox[{"U", "[", 
        RowBox[{"i", "+", "1"}], "]"}]}], "..."}], 
     RowBox[{"U", "[", "j", "]"}]}]}], " ", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"U", "[", 
   RowBox[{"bottom_", ",", "top_"}], "]"}], ":=", 
  RowBox[{
   RowBox[{"IdentityMatrix", "[", 
    RowBox[{"f", "[", "top", "]"}], "]"}], "/;", 
   RowBox[{"bottom", ">", "top"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"U", "[", 
     RowBox[{"bottom_", ",", "top_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "sublist", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"Assert", "[", 
        RowBox[{
         RowBox[{"bottom", "\[LessEqual]", "top"}], ",", 
         "\"\<U ordering\>\""}], "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"sublist", "=", 
        RowBox[{"Transpose", "/@", 
         RowBox[{"allvars", "[", 
          RowBox[{"[", 
           RowBox[{
            RowBox[{"bottom", "+", "1"}], ";;", 
            RowBox[{"top", "+", "1"}]}], "]"}], "]"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"Fold", "[", 
        RowBox[{"Dot", ",", "sublist"}], "]"}]}]}], "\[IndentingNewLine]", 
     "]"}]}], ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{"Activation", " ", "at", " ", "layer", " ", 
     RowBox[{"i", ".", " ", "Defines"}], " ", "derivative", " ", "for", " ", 
     "layer", " ", 
     RowBox[{"i", ".", " ", 
      RowBox[{"A", "[", "0", "]"}]}]}], "=", 
    RowBox[{"Identity", "[", "dsize", "]"}]}], " ", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"A", "[", "i_", "]"}], ":=", 
    RowBox[{"W", "[", 
     RowBox[{
      RowBox[{"i", "-", "1"}], ",", "0"}], "]"}]}], ";"}], "          ", 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{"Backprop", " ", "at", " ", "layer", " ", 
     RowBox[{"i", ".", " ", "Defines"}], " ", "derivative", " ", "for", " ", 
     "layer", " ", 
     RowBox[{"i", ".", " ", 
      RowBox[{"B", "[", "n", "]"}]}]}], "=", "d_error"}], " ", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"B", "[", "i_", "]"}], ":=", 
    RowBox[{
     RowBox[{"-", 
      RowBox[{
       RowBox[{"U", "[", 
        RowBox[{
         RowBox[{"i", "+", "1"}], ",", "n"}], "]"}], ".", "errEq"}]}], "/", 
     "dsize"}]}], ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{"Partial", " ", "products", " ", "needed", " ", "for", " ", 
    RowBox[{"Newton", "'"}], "s", " ", "method"}], " ", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Bn", "[", "i_", "]"}], ":=", 
    RowBox[{"-", 
     RowBox[{"U", "[", 
      RowBox[{
       RowBox[{"i", "+", "1"}], ",", "n"}], "]"}]}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"hessBlock", "[", 
     RowBox[{"i_", ",", "j_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"term1", ",", "term2"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"term1", "=", 
        RowBox[{
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            RowBox[{"A", "[", "i", "]"}], ".", 
            RowBox[{
             RowBox[{"A", "[", "j", "]"}], "\[Transpose]"}]}], ")"}], 
          "\[TensorProduct]", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"Bn", "[", "i", "]"}], ".", 
            RowBox[{
             RowBox[{"Bn", "[", "j", "]"}], "\[Transpose]"}]}], ")"}]}], "/", 
         "dsize"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"Assert", "[", 
        RowBox[{
         RowBox[{"Dimensions", "@", "term1"}], "\[Equal]", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{
            RowBox[{"f", "[", "i", "]"}], "*", 
            RowBox[{"f", "[", 
             RowBox[{"i", "-", "1"}], "]"}]}], ",", 
           RowBox[{
            RowBox[{"f", "[", "j", "]"}], "*", 
            RowBox[{"f", "[", 
             RowBox[{"j", "-", "1"}], "]"}]}]}], "}"}]}], "]"}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"term2", "=", 
        RowBox[{"Which", "[", 
         RowBox[{
          RowBox[{"i", ">", "j"}], ",", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{
            RowBox[{"U", "[", 
             RowBox[{
              RowBox[{"j", "+", "1"}], ",", 
              RowBox[{"i", "-", "1"}]}], "]"}], "\[Transpose]"}], 
           "\[TensorProduct]", 
           RowBox[{"(", 
            RowBox[{
             RowBox[{"B", "[", "i", "]"}], ".", 
             RowBox[{
              RowBox[{"A", "[", "j", "]"}], "\[Transpose]"}]}], ")"}]}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"i", "<", "j"}], ",", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             RowBox[{"A", "[", "i", "]"}], ".", 
             RowBox[{
              RowBox[{"B", "[", "j", "]"}], "\[Transpose]"}]}], ")"}], 
           "\[TensorProduct]", 
           RowBox[{"U", "[", 
            RowBox[{
             RowBox[{"i", "+", "1"}], ",", 
             RowBox[{"j", "-", "1"}]}], "]"}]}], ",", "\[IndentingNewLine]", 
          RowBox[{"i", "\[Equal]", "j"}], " ", ",", "\[IndentingNewLine]", 
          RowBox[{"Array", "[", 
           RowBox[{
            RowBox[{"0", "&"}], ",", 
            RowBox[{"Dimensions", "[", "term1", "]"}]}], "]"}]}], 
         "\[IndentingNewLine]", "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"(", 
        RowBox[{"term1", "+", 
         RowBox[{"term2", ".", 
          RowBox[{"Kmat", "[", 
           RowBox[{
            RowBox[{"f", "[", "j", "]"}], ",", 
            RowBox[{"f", "[", 
             RowBox[{"j", "-", "1"}], "]"}]}], "]"}]}]}], ")"}]}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"gradBlock", "[", "i_", "]"}], ":=", 
    RowBox[{"c2v", "@", 
     RowBox[{"vec", "[", 
      RowBox[{
       RowBox[{"B", "[", "i", "]"}], ".", 
       RowBox[{
        RowBox[{"A", "[", "i", "]"}], "\[Transpose]"}]}], "]"}]}]}], ";"}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{"Substitution", " ", "functions"}], " ", "*)"}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
   "substitutes", " ", "1", " ", "to", " ", "every", " ", "variable"}], " ", 
   "*)"}]}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"sub1", ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"everything", "=", 
        RowBox[{
         RowBox[{"Flatten", "[", 
          RowBox[{"vec", "/@", "allvars"}], "]"}], "~", "Join", "~", 
         RowBox[{"c2v", "@", 
          RowBox[{"vec", "@", "Y"}]}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"Thread", "[", 
        RowBox[{"everything", "\[Rule]", 
         RowBox[{"Array", "[", 
          RowBox[{
           RowBox[{"1", "&"}], ",", 
           RowBox[{"Length", "@", "everything"}]}], "]"}]}], "]"}]}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
   "substitutes", " ", "random", " ", "value", " ", "to", " ", "every", " ", 
    "variable"}], " ", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"subr", ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"SeedRandom", "[", "0", "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"everything", "=", 
        RowBox[{
         RowBox[{"Flatten", "[", 
          RowBox[{"vec", "/@", "allvars"}], "]"}], "~", "Join", "~", 
         RowBox[{"c2v", "@", 
          RowBox[{"vec", "@", "Y"}]}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"Thread", "[", 
        RowBox[{"everything", "\[Rule]", 
         RowBox[{"RandomReal", "[", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{"-", "1"}], ",", "1"}], "}"}], ",", 
           RowBox[{"Length", "@", "everything"}]}], "]"}]}], "]"}]}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{"Run", " ", "checks"}], " ", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"grad", "[", "i_", "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "}"}], ",", 
      RowBox[{
       RowBox[{"Assert", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"i", "\[GreaterEqual]", "0"}], " ", "&&", " ", 
          RowBox[{"i", "\[LessEqual]", "n"}]}], ",", "\"\<grad i check\>\""}],
         "]"}], ";", "\n", 
       RowBox[{"D", "[", 
        RowBox[{"lossEq", ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"c2v", "@", 
            RowBox[{"vec", "@", 
             RowBox[{"allvars", "[", 
              RowBox[{"[", 
               RowBox[{"i", "+", "1"}], "]"}], "]"}]}]}], ",", "1"}], "}"}]}],
         "]"}]}]}], "]"}]}], ";"}], "\n"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"hess", "[", 
     RowBox[{"i_", ",", "j_"}], "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "}"}], ",", 
      RowBox[{
       RowBox[{"Assert", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"j", "\[GreaterEqual]", "0"}], "&&", 
          RowBox[{"j", "\[LessEqual]", "n"}]}], ",", "\"\<hess j check\>\""}],
         "]"}], ";", "\n", 
       RowBox[{"D", "[", 
        RowBox[{
         RowBox[{"grad", "[", "i", "]"}], ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"c2v", "@", 
            RowBox[{"vec", "@", 
             RowBox[{"allvars", "[", 
              RowBox[{"[", 
               RowBox[{"j", "+", "1"}], "]"}], "]"}]}]}], ",", "1"}], "}"}]}],
         "]"}]}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"idx", "=", 
    RowBox[{
     RowBox[{"Range", "[", 
      RowBox[{"n", "+", "1"}], "]"}], "-", "1"}]}], ";", " ", 
   RowBox[{"(*", " ", 
    RowBox[{
     RowBox[{"all", " ", "valid", " ", "layer", " ", "indices"}], ",", " ", 
     RowBox[{"including", " ", "W0"}]}], " ", "*)"}], "\[IndentingNewLine]", 
   RowBox[{"blockIdx", "=", 
    RowBox[{"Outer", "[", 
     RowBox[{"List", ",", "idx", ",", "idx"}], "]"}]}], ";"}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{"Checks", " ", "correctness", " ", "of", " ", "block", " ", "i"}],
     ",", "j"}], " ", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"hessCheck", "[", 
    RowBox[{"i_", ",", "j_"}], "]"}], ":=", 
   RowBox[{
    RowBox[{
     RowBox[{"hess", "[", 
      RowBox[{"i", ",", "j"}], "]"}], "\[DotEqual]", 
     RowBox[{"hessBlock", "[", 
      RowBox[{"i", ",", "j"}], "]"}]}], "/.", "subr"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"gradCheck", "[", "i_", "]"}], ":=", 
   RowBox[{
    RowBox[{
     RowBox[{"grad", "[", "i", "]"}], "\[Equal]", 
     RowBox[{"gradBlock", "[", "i", "]"}]}], "/.", "subr"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{"gradCheck", "/@", "idx"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Apply", "[", 
   RowBox[{"hessCheck", ",", " ", "blockIdx", ",", 
    RowBox[{"{", "2", "}"}]}], "]"}], "//", 
  "MatrixForm"}], "\[IndentingNewLine]"}], "Code",
 CellChangeTimes->CompressedData["
1:eJwd0E1IkwEAxvExKGTZwLqY0tywhhMPFVqJiEwmzo3yIyPUmBDqrJimiaC8
MlImc6MsNzDMlrNllLkhiDBG2UFoiHZoK0YGfYB6SHCKmKhg+7+Hh9/heU6P
6lZrVaNUIpGoE0FLeGK2dOivduOtPITBp5c+YpptfhHN2alRNKX8kOgT7rbo
jmDI+u4YJreHU/Cm2ZKGrq86BboHfp9B5XD8AvYP6QyoyC2txGbHwA3s+FJd
hzNGk+jRR2fr8c8nvajHa2pEWdeWaOx9qBulecUC1qb39KHgU7tx3RUYxcFf
+ueY9XDOi2PuHB+qr7dNYVKNzI+GXNk2ThZJD/CnJb2qLOH28Hg1CgtdNRiP
xkQfu4rNuNPiv4OLe+fbUa61vcTm17cnMbKsmMbRwJtZNA02BdGwu76C352F
m+h0BA5R9W9JamAX2zmBUeW3VMzJv5aBDzK3MrHhbokG8+cj5/DUi4k8tK/6
ajHZbq3H1ZnyBty39bbipmdENHz1lYD+kitWLLiod2K3puIZfq68Pyb2Rk8Q
42uqD9i5LMzheHbPcSM/nHbI8bJ3X4n3Cp+o0KeNaNB+cqkA/wMlhC+e
  "]],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{"True", ",", "True", ",", "True"}], "}"}]], "Output",
 CellChangeTimes->{
  3.700577561115596*^9, 3.700577610044908*^9, {3.700577641401713*^9, 
   3.700577660525915*^9}, {3.700577790576459*^9, 3.700577803729385*^9}, 
   3.700578398291752*^9, 3.7005784731085567`*^9, 3.700578533000766*^9, 
   3.700578680223805*^9, 3.70057871493981*^9, {3.700578783337426*^9, 
   3.700578807298435*^9}, {3.7005789296626053`*^9, 3.70057895834097*^9}, 
   3.700579018428493*^9, 3.700579087733685*^9}],

Cell[BoxData[
 TagBox[
  RowBox[{"(", "\[NoBreak]", GridBox[{
     {"True", "True", "True"},
     {"True", "True", "True"},
     {"True", "True", "True"}
    },
    GridBoxAlignment->{
     "Columns" -> {{Center}}, "ColumnsIndexed" -> {}, "Rows" -> {{Baseline}}, 
      "RowsIndexed" -> {}},
    GridBoxSpacings->{"Columns" -> {
        Offset[0.27999999999999997`], {
         Offset[0.7]}, 
        Offset[0.27999999999999997`]}, "ColumnsIndexed" -> {}, "Rows" -> {
        Offset[0.2], {
         Offset[0.4]}, 
        Offset[0.2]}, "RowsIndexed" -> {}}], "\[NoBreak]", ")"}],
  Function[BoxForm`e$, 
   MatrixForm[BoxForm`e$]]]], "Output",
 CellChangeTimes->{
  3.700577561115596*^9, 3.700577610044908*^9, {3.700577641401713*^9, 
   3.700577660525915*^9}, {3.700577790576459*^9, 3.700577803729385*^9}, 
   3.700578398291752*^9, 3.7005784731085567`*^9, 3.700578533000766*^9, 
   3.700578680223805*^9, 3.70057871493981*^9, {3.700578783337426*^9, 
   3.700578807298435*^9}, {3.7005789296626053`*^9, 3.70057895834097*^9}, 
   3.700579018428493*^9, 3.700579087838217*^9}]
}, Open  ]]
}, Open  ]]
}, Open  ]]
},
WindowSize->{808, 1328},
WindowMargins->{{Automatic, 706}, {Automatic, 0}},
FrontEndVersion->"11.0 for Mac OS X x86 (32-bit, 64-bit Kernel) (September \
21, 2016)",
StyleDefinitions->"Default.nb"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[CellGroupData[{
Cell[580, 22, 108, 1, 92, "Title"],
Cell[CellGroupData[{
Cell[713, 27, 91, 1, 64, "Section"],
Cell[807, 30, 21160, 556, 2219, "Code"],
Cell[21970, 588, 145, 2, 32, "Input"]
}, Open  ]],
Cell[CellGroupData[{
Cell[22152, 595, 86, 1, 64, "Section"],
Cell[CellGroupData[{
Cell[22263, 600, 22974, 628, 2219, "Code"],
Cell[45240, 1230, 519, 9, 32, "Output"],
Cell[45762, 1241, 1071, 25, 74, "Output"]
}, Open  ]]
}, Open  ]]
}, Open  ]]
}
]
*)

