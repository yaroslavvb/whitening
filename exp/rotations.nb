(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 11.0' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[     91603,       2444]
NotebookOptionsPosition[     89010,       2348]
NotebookOutlinePosition[     89372,       2364]
CellTagsIndexPosition[     89329,       2361]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{

Cell[CellGroupData[{
Cell[BoxData["deploy"], "Input",
 CellChangeTimes->{{3.700671161191558*^9, 3.700671162248221*^9}}],

Cell[BoxData[
 InterpretationBox[
  RowBox[{"CloudObject", "[", 
   TagBox[
    ButtonBox[
     PaneSelectorBox[{
      False->"\<\"https://www.wolframcloud.com/objects/fd8b6944-ec1a-41a3-\
bb7b-a630c27c234b\"\>", True->
      StyleBox["\<\"https://www.wolframcloud.com/objects/fd8b6944-ec1a-41a3-\
bb7b-a630c27c234b\"\>", "HyperlinkActive"]}, Dynamic[
       CurrentValue["MouseOver"]],
      BaseStyle->{"Hyperlink"},
      FrameMargins->0,
      ImageSize->Automatic],
     BaseStyle->"Hyperlink",
     ButtonData->{
       URL[
       "https://www.wolframcloud.com/objects/fd8b6944-ec1a-41a3-bb7b-\
a630c27c234b"], None},
     ButtonNote->
      "https://www.wolframcloud.com/objects/fd8b6944-ec1a-41a3-bb7b-\
a630c27c234b"],
    Annotation[#, 
     "https://www.wolframcloud.com/objects/fd8b6944-ec1a-41a3-bb7b-\
a630c27c234b", "Hyperlink"]& ], "]"}],
  CloudObject[
  "https://www.wolframcloud.com/objects/fd8b6944-ec1a-41a3-bb7b-a630c27c234b"],
  SelectWithContents->True]], "Output",
 CellChangeTimes->{3.700671163524227*^9}]
}, Open  ]],

Cell[CellGroupData[{

Cell["Rotations", "Title",
 CellChangeTimes->{{3.700500832581313*^9, 3.700500843502058*^9}}],

Cell[CellGroupData[{

Cell[BoxData[""], "Input",
 CellChangeTimes->{3.700605342115081*^9}],

Cell[BoxData[
 InterpretationBox[
  RowBox[{"CloudObject", "[", 
   TagBox[
    ButtonBox[
     PaneSelectorBox[{
      False->"\<\"https://www.wolframcloud.com/objects/df3a2bf4-dcdf-4788-\
bb00-0ad9d00ba582\"\>", True->
      StyleBox["\<\"https://www.wolframcloud.com/objects/df3a2bf4-dcdf-4788-\
bb00-0ad9d00ba582\"\>", "HyperlinkActive"]}, Dynamic[
       CurrentValue["MouseOver"]],
      BaseStyle->{"Hyperlink"},
      FrameMargins->0,
      ImageSize->Automatic],
     BaseStyle->"Hyperlink",
     ButtonData->{
       URL[
       "https://www.wolframcloud.com/objects/df3a2bf4-dcdf-4788-bb00-\
0ad9d00ba582"], None},
     ButtonNote->
      "https://www.wolframcloud.com/objects/df3a2bf4-dcdf-4788-bb00-\
0ad9d00ba582"],
    Annotation[#, 
     "https://www.wolframcloud.com/objects/df3a2bf4-dcdf-4788-bb00-\
0ad9d00ba582", "Hyperlink"]& ], "]"}],
  CloudObject[
  "https://www.wolframcloud.com/objects/df3a2bf4-dcdf-4788-bb00-0ad9d00ba582"],
  SelectWithContents->True]], "Output",
 CellChangeTimes->{3.700602913191538*^9, 3.700602962748694*^9}]
}, Open  ]],

Cell[CellGroupData[{

Cell["Util", "Section",
 CellChangeTimes->{{3.700511269181332*^9, 3.7005112819271708`*^9}}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{
   "Change", " ", "TensorProduct", " ", "to", " ", "act", " ", "like", " ", 
    "Kronecker", " ", "product"}], " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"Unprotect", "[", "TensorProduct", "]"}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"TensorProduct", "=", "KroneckerProduct"}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Protect", "[", "TensorProduct", "]"}], ";"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"On", "[", "Assert", "]"}], ";"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{
     RowBox[{"column", " ", "vectorize"}], ",", " ", 
     RowBox[{"following", " ", "Magnus"}], ",", " ", "1999"}], " ", "*)"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"vec", "[", "W_", "]"}], ":=", 
     RowBox[{"Transpose", "@", 
      RowBox[{"{", 
       RowBox[{"Flatten", "@", 
        RowBox[{"Transpose", "[", "W", "]"}]}], "}"}]}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"unvec", "[", 
      RowBox[{"Wf_", ",", " ", "rows_"}], "]"}], ":=", 
     RowBox[{"Transpose", "[", 
      RowBox[{"Flatten", "/@", 
       RowBox[{"Partition", "[", 
        RowBox[{"Wf", ",", "rows"}], "]"}]}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"toscalar", "[", "v_", "]"}], ":=", 
     RowBox[{"Block", "[", 
      RowBox[{
       RowBox[{"{", "t", "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"t", "=", 
         RowBox[{"Flatten", "@", "v"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"Assert", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"Length", "[", "t", "]"}], "\[Equal]", "1"}], ",", " ", 
          "\"\<scalar assert\>\""}], "]"}], ";", "\[IndentingNewLine]", 
        RowBox[{"First", "@", "t"}]}]}], "\[IndentingNewLine]", "]"}]}], 
    ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"v2c", "[", "c_", "]"}], ":=", 
    RowBox[{"Transpose", "[", 
     RowBox[{"{", "c", "}"}], "]"}]}], " ", 
   RowBox[{"(*", " ", 
    RowBox[{"turns", " ", "vector", " ", "to", " ", "column", " ", "matrix"}],
     " ", "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"v2r", "[", "c_", "]"}], ":=", 
    RowBox[{"{", "c", "}"}]}], " ", 
   RowBox[{"(*", " ", 
    RowBox[{"turns", " ", "vector", " ", "to", " ", "row", " ", "matrix"}], 
    " ", "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"c2v", "[", "c_", "]"}], ":=", 
    RowBox[{"Flatten", "[", "c", "]"}]}], " ", 
   RowBox[{"(*", " ", 
    RowBox[{
    "turns", " ", "column", " ", "matrix", " ", "into", " ", "vector"}], " ", 
    "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{"Partitions", " ", "matrix", " ", "into", " ", "blocks", " ", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"axa", ",", "axb"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"bxa", ",", "bxb"}], "}"}]}], "}"}]}], " ", "*)"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"partitionMatrix", "[", 
      RowBox[{"mat_", ",", 
       RowBox[{"{", 
        RowBox[{"a_", ",", "b_"}], "}"}]}], "]"}], ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"Assert", "[", 
           RowBox[{
            RowBox[{"a", "+", "b"}], "\[Equal]", 
            RowBox[{"Length", "@", "mat"}]}], "]"}], ";", 
          "\[IndentingNewLine]", "Assert", ";"}], "[", 
         RowBox[{
          RowBox[{"a", "+", "b"}], "\[Equal]", 
          RowBox[{
           RowBox[{"Length", "@", "mat"}], "\[Transpose]"}]}], "]"}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"Internal`PartitionRagged", "[", 
         RowBox[{"mat", ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"a", ",", "b"}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"a", ",", "b"}], "}"}]}], "}"}]}], "]"}]}]}], 
      "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{
     RowBox[{"Commutation", " ", "matrix", " ", "m"}], ",", "n"}], " ", 
    "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"Kmat", "[", 
      RowBox[{"m_", ",", "n_"}], "]"}], ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
        "x", ",", "X", ",", "before", ",", "after", ",", "positions", ",", 
         "matrix"}], "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"X", "=", 
         RowBox[{"Array", "[", 
          RowBox[{"x", ",", 
           RowBox[{"{", 
            RowBox[{"m", ",", "n"}], "}"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"before", "=", 
         RowBox[{"Flatten", "@", 
          RowBox[{"vec", "@", "X"}]}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"after", "=", 
         RowBox[{"Flatten", "@", 
          RowBox[{"vec", "@", 
           RowBox[{"Transpose", "[", "X", "]"}]}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"positions", "=", 
         RowBox[{"MapIndexed", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{"First", "@", "#2"}], ",", 
              RowBox[{"First", "@", 
               RowBox[{"Flatten", "@", 
                RowBox[{"Position", "[", 
                 RowBox[{"before", ",", "#"}], "]"}]}]}]}], "}"}], "&"}], ",",
            "after"}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"matrix", "=", 
         RowBox[{"SparseArray", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"#", "\[Rule]", "1"}], "&"}], "/@", "positions"}], 
          "]"}]}]}]}], "\[IndentingNewLine]", "]"}]}], ";"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"take1", "[", "x_", "]"}], ":=", 
     RowBox[{"First", "@", 
      RowBox[{"Flatten", "@", "x"}]}]}], ";"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"robustMin", "[", "x_", "]"}], ":=", 
     RowBox[{"Min", "[", 
      RowBox[{"Select", "[", 
       RowBox[{
        RowBox[{"Flatten", "@", "x"}], ",", 
        RowBox[{
         RowBox[{"#", ">", "1*^-10"}], "&"}]}], "]"}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{"Symmetric", " ", "square", " ", "root"}], " ", "*)"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"symsqrt", "[", "m_", "]"}], ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"U", ",", "S", ",", "W"}], "}"}], ",", "\[IndentingNewLine]", 
       
       RowBox[{
        RowBox[{
         RowBox[{"{", 
          RowBox[{"U", ",", "S", ",", "W"}], "}"}], "=", 
         RowBox[{"SingularValueDecomposition", "[", "m", "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"U", ".", 
         RowBox[{"Sqrt", "[", "S", "]"}], ".", 
         RowBox[{"Transpose", "[", "W", "]"}]}]}]}], "\[IndentingNewLine]", 
      "]"}]}], ";"}], "\n", "\n", 
   RowBox[{"(*", " ", 
    RowBox[{
    "divide", " ", "object", " ", "by", " ", "sum", " ", "of", " ", "its", 
     " ", "elements"}], " ", "*)"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"normalize", "[", "x_", "]"}], ":=", 
     RowBox[{"x", "/", 
      RowBox[{"Total", "[", 
       RowBox[{"x", ",", " ", "10"}], "]"}]}]}], ";"}], "\[IndentingNewLine]",
    "\n", 
   RowBox[{"(*", " ", 
    RowBox[{
    "Random", " ", "uniform", " ", "vector", " ", "normalized", " ", "to", 
     " ", "1"}], " ", "*)"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"randomD", "[", "f_", "]"}], ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", "temp", "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"temp", "=", 
         RowBox[{"RandomReal", "[", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"0", ",", "1"}], "}"}], ",", 
           RowBox[{"{", "f", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"temp", "/", 
         RowBox[{"Total", "[", "temp", "]"}]}]}]}], "\[IndentingNewLine]", 
      "]"}]}], ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{
    "centers", " ", "data", " ", "where", " ", "batch", " ", "dimension", " ",
      "is", " ", "1"}], " ", "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"centerData", "[", "X_", "]"}], ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", "Xc", "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Xc", "=", 
         RowBox[{"Mean", "@", 
          RowBox[{"Transpose", "@", "X"}]}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"Transpose", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"#", "-", "Xc"}], "&"}], "/@", 
          RowBox[{"Transpose", "[", "X", "]"}]}], "]"}]}]}], 
      "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", "\n", 
   RowBox[{
    RowBox[{"khatriRao", "[", 
     RowBox[{"A_", ",", "B_"}], "]"}], ":=", 
    RowBox[{
     RowBox[{"MapThread", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Flatten", "[", 
         RowBox[{
          RowBox[{"{", "#1", "}"}], "\[TensorProduct]", 
          RowBox[{"{", "#2", "}"}]}], "]"}], "&"}], ",", 
       RowBox[{"Transpose", "/@", 
        RowBox[{"{", 
         RowBox[{"A", ",", "B"}], "}"}]}]}], "]"}], "//", "Transpose"}]}], 
   "\n", "\n", 
   RowBox[{"(*", " ", 
    RowBox[{"takes", " ", 
     RowBox[{"sizes", " ", "[", 
      RowBox[{"s1", ",", "s2", ",", ".."}], "]"}], " ", "partitions", " ", 
     "vec", " ", "into", " ", "those", " ", "sizes"}], " ", "*)"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"listPartition", "[", 
      RowBox[{"list_", ",", "sizes_"}], "]"}], ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"offsets", ",", "offsetPairs"}], "}"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Assert", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"Length", "@", "list"}], "\[Equal]", 
           RowBox[{"Total", "@", "sizes"}]}], ",", " ", 
          "\"\<can't partition\>\""}], "]"}], ";", "\[IndentingNewLine]", 
        RowBox[{"offsets", "=", 
         RowBox[{
          RowBox[{"{", "0", "}"}], "~", "Join", "~", 
          RowBox[{"FoldList", "[", 
           RowBox[{"Plus", ",", "sizes"}], "]"}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"offsetPairs", "=", 
         RowBox[{"Partition", "[", 
          RowBox[{"offsets", ",", "2", ",", "1"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"list", "[", 
           RowBox[{"[", 
            RowBox[{
             RowBox[{
              RowBox[{"#", "[", 
               RowBox[{"[", "1", "]"}], "]"}], "+", "1"}], ";;", 
             RowBox[{"#", "[", 
              RowBox[{"[", "2", "]"}], "]"}]}], "]"}], "]"}], "&"}], "/@", 
         "offsetPairs"}]}]}], "\[IndentingNewLine]", "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Assert", "[", 
     RowBox[{
      RowBox[{"listPartition", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"1", ",", "2", ",", "3", ",", "4", ",", "5"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"3", ",", "2"}], "}"}]}], "]"}], "\[Equal]", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"1", ",", "2", ",", "3"}], "}"}], ",", 
        RowBox[{"{", 
         RowBox[{"4", ",", "5"}], "}"}]}], "}"}]}], "]"}], ";"}], "\n", "\n", 
   
   RowBox[{"(*", " ", 
    RowBox[{"approximate", " ", "equality", " ", "testing"}], " ", "*)"}], 
   "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"DotEqual", "[", 
      RowBox[{"a_", ",", "b_"}], "]"}], ":=", 
     RowBox[{
      RowBox[{"Norm", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Flatten", "[", 
          RowBox[{"{", "a", "}"}], "]"}], "-", 
         RowBox[{"Flatten", "[", 
          RowBox[{"{", "b", "}"}], "]"}]}], ",", "\[Infinity]"}], "]"}], "<", 
      "1*^-9"}]}], ";"}], "\[IndentingNewLine]", "\n", 
   RowBox[{
    RowBox[{"Unprotect", "[", "toc", "]"}], ";"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"toc", "[", "nb_", "]"}], ":=", 
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{"Button", "[", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"Mouseover", "[", 
             RowBox[{"#", ",", 
              RowBox[{"Style", "[", 
               RowBox[{"#", ",", "\"\<HyperlinkActive\>\""}], "]"}]}], "]"}], 
            "&"}], "@", 
           RowBox[{"First", "@", 
            RowBox[{"NotebookRead", "@", "#"}]}]}], ",", 
          RowBox[{"SelectionMove", "[", 
           RowBox[{"#", ",", "All", ",", "CellContents"}], "]"}], ",", 
          RowBox[{"Appearance", "\[Rule]", "None"}], ",", 
          RowBox[{"BaseStyle", "\[Rule]", "\"\<Hyperlink\>\""}], ",", 
          RowBox[{"Alignment", "\[Rule]", "Left"}], ",", 
          RowBox[{"ImageSize", "\[Rule]", "100"}]}], "]"}], "&"}], "/@", 
       RowBox[{"Cells", "[", 
        RowBox[{"CellStyle", "\[Rule]", 
         RowBox[{"{", 
          RowBox[{
          "\"\<Title\>\"", ",", "\"\<Chapter\>\"", ",", "\"\<Section\>\"", 
           ",", "\"\<Subsection\>\"", ",", "\"\<Subsubsection\>\""}], "}"}]}],
         "]"}]}], "//", 
      RowBox[{
       RowBox[{"CreatePalette", "[", 
        RowBox[{
         RowBox[{"Panel", "[", 
          RowBox[{
           RowBox[{"Column", "[", 
            RowBox[{"#", ",", 
             RowBox[{"Dividers", "\[Rule]", "Center"}]}], "]"}], ",", 
           RowBox[{"ImageSize", "\[Rule]", "100"}]}], "]"}], ",", 
         RowBox[{"FrontEnd`ClosingSaveDialog", "\[Rule]", "False"}], ",", 
         RowBox[{"WindowTitle", "\[Rule]", "\"\<Table of Contents\>\""}], ",", 
         RowBox[{"Magnification", "\[Rule]", "1.5"}]}], "]"}], "&"}]}]}], 
    ";"}], "\n", 
   RowBox[{
    RowBox[{"toc", "[", 
     RowBox[{"Optional", "[", 
      RowBox[{"Automatic", ",", "Automatic"}], "]"}], "]"}], ":=", 
    RowBox[{"nbTOC", "@", 
     RowBox[{"EvaluationNotebook", "[", "]"}]}]}], "\n", 
   RowBox[{
    RowBox[{"Protect", "[", "toc", "]"}], ";"}], "\n", "\[IndentingNewLine]", 
   "\n", 
   RowBox[{"(*", " ", 
    RowBox[{
    "Things", " ", "more", " ", "specific", " ", "to", " ", "natural", " ", 
     "gradient", " ", "stuff"}], " ", "*)"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{"partitions", " ", "matrix", " ", "into", " ", "blocks"}], " ", 
    "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"partitionMatrix", "[", 
      RowBox[{"mat_", ",", "sizes_"}], "]"}], ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{"Internal`PartitionRagged", "[", 
        RowBox[{"mat", ",", 
         RowBox[{"{", 
          RowBox[{"sizes", ",", "sizes"}], "}"}]}], "]"}]}], 
      "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", "\n", 
   RowBox[{"(*", " ", 
    RowBox[{
     RowBox[{"extracts", " ", "i"}], ",", 
     RowBox[{
      RowBox[{"j", "'"}], "th", " ", "block"}], ",", " ", 
     RowBox[{"taking", " ", "sizes", " ", "from", " ", "fsizes"}]}], " ", 
    "*)"}], "\n", 
   RowBox[{"(*", " ", 
    RowBox[{"TODO", ":", " ", 
     RowBox[{"generalize", " ", "fs"}]}], " ", "*)"}], "\[IndentingNewLine]", 
   
   RowBox[{
    RowBox[{
     RowBox[{"matrixBlock", "[", 
      RowBox[{"i_", ",", "j_", ",", "mat_"}], "]"}], ":=", 
     RowBox[{"(", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"msizes", "=", 
        RowBox[{"Times", "@@@", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"Partition", "[", 
            RowBox[{"fs", ",", "2", ",", "1"}], "]"}], "//", "Rest"}], 
          ")"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"partitionMatrix", "[", 
         RowBox[{"mat", ",", "msizes"}], "]"}], "[", 
        RowBox[{"[", 
         RowBox[{"i", ",", "j"}], "]"}], "]"}]}], "\[IndentingNewLine]", 
      ")"}]}], ";"}], "\n", "\n", 
   RowBox[{"(*", " ", 
    RowBox[{"extracts", " ", 
     RowBox[{"i", "'"}], "th", " ", "block", " ", "from", " ", "vector"}], 
    " ", "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"vectorBlock", "[", 
      RowBox[{"i_", ",", "vec_"}], "]"}], ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", "msize", "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"msizes", "=", 
         RowBox[{"Times", "@@@", 
          RowBox[{"(", 
           RowBox[{
            RowBox[{"Partition", "[", 
             RowBox[{"fs", ",", "2", ",", "1"}], "]"}], "//", "Rest"}], 
           ")"}]}]}], ";", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"listPartition", "[", 
          RowBox[{"vec", ",", "msizes"}], "]"}], "[", 
         RowBox[{"[", "i", "]"}], "]"}]}]}], "\[IndentingNewLine]", "]"}]}], 
    ";"}], "\n", "\n", "\n", 
   RowBox[{"(*", " ", 
    RowBox[{
     RowBox[{"converts", " ", "bool", " ", "to", " ", "0"}], ",", "1"}], " ", 
    "*)"}], "\n", 
   RowBox[{
    RowBox[{"fromBool", "[", "x_", "]"}], ":=", 
    RowBox[{"If", "[", 
     RowBox[{"x", ",", "1", ",", "0"}], "]"}]}], "\n", 
   RowBox[{"SetAttributes", "[", 
    RowBox[{"fromBool", ",", " ", "Listable"}], "]"}], "\n", "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"flatten", "[", "Ws_", "]"}], ":=", 
     RowBox[{"c2v", "[", 
      RowBox[{"vec", "/@", "Ws"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"unflatten", "[", "Wf_", "]"}], ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"flatVars", ",", "sizes"}], "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"sizes", "=", 
         RowBox[{"Rest", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Times", "@@", "#"}], "&"}], "/@", 
           RowBox[{"Partition", "[", 
            RowBox[{"fs", ",", "2", ",", "1"}], "]"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"flatVars", "=", 
         RowBox[{"listPartition", "[", 
          RowBox[{"Wf", ",", "sizes"}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{"unvec", "[", 
           RowBox[{
            RowBox[{"flatVars", "[", 
             RowBox[{"[", "i", "]"}], "]"}], ",", 
            RowBox[{"fs", "[", 
             RowBox[{"[", 
              RowBox[{"i", "+", "2"}], "]"}], "]"}]}], "]"}], ",", 
          RowBox[{"{", 
           RowBox[{"i", ",", "1", ",", 
            RowBox[{"Length", "@", "sizes"}]}], "}"}]}], "]"}]}]}], 
      "\[IndentingNewLine]", "]"}]}], ";"}], "\n", "\n", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{"creates", " ", "column", " ", "of", " ", "ones"}], " ", "*)"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"onesCol", "[", "n_", "]"}], ":=", 
     RowBox[{"v2c", "@", 
      RowBox[{"Table", "[", 
       RowBox[{"1", ",", 
        RowBox[{"{", 
         RowBox[{"i", ",", "n"}], "}"}]}], "]"}]}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"onesRow", "[", "n_", "]"}], ":=", 
     RowBox[{"v2r", "@", 
      RowBox[{"Table", "[", 
       RowBox[{"1", ",", 
        RowBox[{"{", 
         RowBox[{"i", ",", "n"}], "}"}]}], "]"}]}]}], ";"}], "\n", "\n", 
   RowBox[{"(*", " ", 
    RowBox[{
    "Identity", " ", "matrix", " ", "truncated", " ", "to", " ", "fit", " ", 
     "rectangular", " ", "dims"}], " ", "*)"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"truncatedIdentity", "[", 
      RowBox[{"a_", ",", "b_"}], "]"}], ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", "mat", "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"mat", "=", 
         RowBox[{"IdentityMatrix", "[", 
          RowBox[{"Max", "[", 
           RowBox[{"a", ",", "b"}], "]"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"mat", "[", 
         RowBox[{"[", 
          RowBox[{
           RowBox[{";;", "a"}], ",", 
           RowBox[{";;", "b"}]}], "]"}], "]"}]}]}], "\[IndentingNewLine]", 
      "]"}]}], ";"}], "\n", "\n", 
   RowBox[{"(*", " ", 
    RowBox[{
     RowBox[{"Deploys", " ", "current", " ", "notebook"}], ",", " ", 
     RowBox[{"returns", " ", "URL", " ", "object"}]}], " ", "*)"}], "\n", 
   RowBox[{
    RowBox[{"deploy", ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", "result", "}"}], ",", "\n", 
       RowBox[{
        RowBox[{"result", "=", 
         RowBox[{"CloudDeploy", "[", 
          RowBox[{
           RowBox[{"SelectedNotebook", "[", "]"}], ",", 
           RowBox[{"Permissions", "\[Rule]", "\"\<Public\>\""}]}], "]"}]}], 
        ";", "\n", 
        RowBox[{"CopyToClipboard", "[", 
         RowBox[{
         "result", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], 
         "]"}], ";", "\n", "result"}]}], "\n", "]"}]}], ";"}], "\n", "\n", 
   "\n", 
   RowBox[{"(*", " ", 
    RowBox[{
    "Generate", " ", "correlated", " ", "data", " ", "in", " ", "many", " ", 
     "dimensions"}], " ", "*)"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"generateX", "[", 
      RowBox[{"n_", ",", "e_", ",", "dsize_"}], "]"}], ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"wt", ",", "mean", ",", "cov", ",", "normal", ",", "X"}], 
        "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"mean", "=", 
         RowBox[{"Table", "[", 
          RowBox[{"0", ",", 
           RowBox[{"{", "n", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"cov", "=", 
         RowBox[{
          RowBox[{
           RowBox[{"IdentityMatrix", "[", "n", "]"}], "*", "e"}], "+", 
          RowBox[{"Array", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"1", "-", "e"}], "&"}], ",", 
            RowBox[{"{", 
             RowBox[{"n", ",", "n"}], "}"}]}], "]"}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"normal", "=", 
         RowBox[{"MultinormalDistribution", "[", 
          RowBox[{"mean", ",", "cov"}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"X", "=", 
         RowBox[{
          RowBox[{"RandomVariate", "[", 
           RowBox[{"normal", ",", 
            RowBox[{"{", "dsize", "}"}]}], "]"}], "//", "Transpose"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"centerData", "[", "X", "]"}]}]}], "\[IndentingNewLine]", 
      "]"}]}], ";"}], "\n", "\n", 
   RowBox[{"(*", " ", 
    RowBox[{
     RowBox[{"Takes", " ", "table", " ", "of", " ", "matrix", " ", "blocks"}],
      ",", " ", 
     RowBox[{"inverts", " ", "diagonal", " ", "ones"}]}], " ", "*)"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"blockDiagonalInverse", "[", "blocks_", "]"}], ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", "invertMaybe", "}"}], ",", "\n", 
       RowBox[{
        RowBox[{
         RowBox[{"invertMaybe", "[", 
          RowBox[{"block_", ",", 
           RowBox[{"{", 
            RowBox[{"i_", ",", "j_"}], "}"}]}], "]"}], ":=", 
         "\[IndentingNewLine]", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"i", "\[Equal]", "j"}], ",", 
           RowBox[{"PseudoInverse", "@", "block"}], ",", 
           RowBox[{"Array", "[", 
            RowBox[{
             RowBox[{"0", "&"}], ",", 
             RowBox[{"Dimensions", "[", "block", "]"}]}], "]"}]}], "]"}]}], 
        ";", "\[IndentingNewLine]", 
        RowBox[{"MapIndexed", "[", 
         RowBox[{"invertMaybe", ",", "blocks", ",", 
          RowBox[{"{", "2", "}"}]}], "]"}]}]}], "]"}]}], ";"}]}]}]], "Code",
 InitializationCell->False,
 CellChangeTimes->{{3.699549275986102*^9, 3.699549339228649*^9}, {
   3.69954975851676*^9, 3.699549786585791*^9}, {3.699561457247508*^9, 
   3.699561462172862*^9}, {3.699561822851487*^9, 3.6995618491288643`*^9}, 
   3.699562247517115*^9, {3.699642980523972*^9, 3.69964299840254*^9}, {
   3.699644247442046*^9, 3.6996442478015223`*^9}, {3.699644437416765*^9, 
   3.699644439279387*^9}, {3.699644576378022*^9, 3.699644579002046*^9}, 
   3.6996447162861023`*^9, {3.699713696139348*^9, 3.699713810756341*^9}, {
   3.699713948671307*^9, 3.6997139545810328`*^9}, {3.699807236268237*^9, 
   3.699807257598522*^9}, {3.699914522898534*^9, 3.699914524151675*^9}, {
   3.699917185751142*^9, 3.6999171972468967`*^9}, {3.6999701127397823`*^9, 
   3.6999701331862917`*^9}, {3.699970892851284*^9, 3.699970894407498*^9}, {
   3.699981470677924*^9, 3.6999815023713007`*^9}, {3.699982800717115*^9, 
   3.6999828013169413`*^9}, {3.7003253038948174`*^9, 3.700325323290061*^9}, {
   3.7003348374800997`*^9, 3.700334845173471*^9}, {3.7004002920265636`*^9, 
   3.700400308205324*^9}, {3.700400342763562*^9, 3.700400375040761*^9}, {
   3.700400475010377*^9, 3.700400476181603*^9}, {3.70040080525524*^9, 
   3.700400821679696*^9}, 3.700404956189498*^9, {3.7004201525093603`*^9, 
   3.700420198954833*^9}, {3.700420234510708*^9, 3.700420237805414*^9}, {
   3.70042084544526*^9, 3.7004208532301483`*^9}, {3.700422054701887*^9, 
   3.700422075220457*^9}, {3.700423609457384*^9, 3.700423612955349*^9}, {
   3.7005180876775427`*^9, 3.700518096763232*^9}, {3.70057883811094*^9, 
   3.700578845749639*^9}, {3.700578877519827*^9, 3.700578901189155*^9}, {
   3.700578937212184*^9, 3.700578951325708*^9}, {3.7005822499572763`*^9, 
   3.700582255440817*^9}, {3.70058832427227*^9, 3.7005883255559883`*^9}, {
   3.700590075897201*^9, 3.70059009660647*^9}, 3.7005926232952414`*^9, {
   3.70059288078299*^9, 3.700592890254765*^9}, {3.700605357540572*^9, 
   3.70060538406542*^9}, {3.700670608852241*^9, 3.700670622787674*^9}, {
   3.700670704273325*^9, 3.700670741411263*^9}, {3.7006708135583897`*^9, 
   3.700670835077026*^9}, {3.7006787344241533`*^9, 3.700678750330009*^9}, {
   3.7006812992673693`*^9, 3.700681318468444*^9}, {3.700681481112795*^9, 
   3.700681505489416*^9}}],

Cell[BoxData[
 TemplateBox[{
  "SetDelayed","write",
   "\"Tag \\!\\(\\*RowBox[{\\\"flatten\\\"}]\\) in \
\\!\\(\\*RowBox[{\\\"flatten\\\", \\\"[\\\", \\\"Ws_\\\", \\\"]\\\"}]\\) is \
Protected.\"",2,281,27,32445828165209010849,"Local"},
  "MessageTemplate"]], "Message", "MSG",
 CellChangeTimes->{3.700680438048574*^9, 3.700681319740093*^9, 
  3.700681482527783*^9}],

Cell[BoxData[
 TemplateBox[{
  "SetDelayed","write",
   "\"Tag \\!\\(\\*RowBox[{\\\"unflatten\\\"}]\\) in \
\\!\\(\\*RowBox[{\\\"unflatten\\\", \\\"[\\\", \\\"Wf_\\\", \\\"]\\\"}]\\) is \
Protected.\"",2,282,28,32445828165209010849,"Local"},
  "MessageTemplate"]], "Message", "MSG",
 CellChangeTimes->{3.700680438048574*^9, 3.700681319740093*^9, 
  3.7006814825575857`*^9}]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["Equation setup", "Section",
 CellChangeTimes->{{3.70058838253695*^9, 3.700588388907529*^9}, {
  3.700588452805987*^9, 3.700588455548293*^9}}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{"Convention", ",", " ", 
    RowBox[{"equations", " ", "end", " ", "with", " ", "\"\<Eq\>\""}], ",", 
    " ", 
    RowBox[{"functions", " ", "end", " ", "with", " ", "capital", " ", 
     RowBox[{"F", ".", " ", "Filenames"}], " ", "all", " ", "lowercase", " ", 
     "and", " ", "separated", " ", "with", " ", "_.", "\n", "Own", " ", 
     "symbols", " ", "start", " ", "with", " ", "lower", " ", 
     RowBox[{"letter", ".", "\n", "\n", 
      RowBox[{"Globals", ":", "\[IndentingNewLine]", "lossEq", ":", " ", 
       RowBox[{"equation", " ", "for", " ", "loss", "\[IndentingNewLine]", 
        RowBox[{"errEq", ":", " ", 
         RowBox[{"equation", " ", "for", " ", "error", "\n", "gradEq"}], ":", 
         " ", 
         RowBox[{"equation", " ", "for", " ", "gradient", "\n", 
          RowBox[{"hessEq", ":", " ", 
           RowBox[{"equation", " ", "for", " ", "Hessian", "\n", "pre0"}], 
           ":", " ", 
           RowBox[{"dummy", " ", "preconditioner", "\n", 
            RowBox[{"n", ":", " ", 
             RowBox[{"number", " ", "of", " ", "layers", "\n", "dsize"}], ":",
              " ", 
             RowBox[{
             "number", " ", "of", " ", "datapoints"}]}]}]}]}]}]}]}]}]}], ",", 
    " ", 
    RowBox[{"aka", " ", 
     RowBox[{"f", "[", 
      RowBox[{"-", "1"}], "]"}], "\n", 
     RowBox[{"fs", ":", " ", 
      RowBox[{"list", " ", "of", " ", "sizes", "\n", 
       RowBox[{"f", "[", "i", "]"}]}], ":", " ", 
      RowBox[{"gives", " ", "dims"}]}]}], ",", " ", 
    RowBox[{"f", "[", "i", "]"}], ",", 
    RowBox[{
     RowBox[{
      RowBox[{"f", "[", 
       RowBox[{"i", "-", "1"}], "]"}], " ", "is", " ", "dimension", " ", "of",
       " ", "layer", " ", "i", "\n", 
      RowBox[{"W", "[", 
       RowBox[{"i", ",", "j"}], "]"}]}], ":", " ", 
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{"W", "[", "i", "]"}], ".", 
        RowBox[{"W", "[", 
         RowBox[{"i", "-", "1"}], "]"}]}], ".."}], 
      RowBox[{"W", "[", "j", "]"}], "\n", 
      RowBox[{"U", "[", 
       RowBox[{"i", ",", "j"}], "]"}]}], ":", " ", 
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{"U", "[", "i", "]"}], ".", 
        RowBox[{"U", "[", 
         RowBox[{"i", "+", "1"}], "]"}]}], "..."}], 
      RowBox[{"U", "[", "j", "]"}], "\n", 
      RowBox[{"makeW", "[", "i", "]"}]}], ":", " ", 
     RowBox[{"creates", " ", "matrix", " ", "of", " ", "form", " ", 
      RowBox[{"{", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{
          RowBox[{"W", "[", "i", "]"}], "[", 
          RowBox[{"1", ",", "1"}], "]"}], ",", 
         RowBox[{
          RowBox[{"W", "[", "i", "]"}], "[", 
          RowBox[{"1", ",", "2"}], "]"}], ",", 
         RowBox[{"...", "\n", 
          RowBox[{"Y", ":", " ", 
           RowBox[{
           "contains", " ", "array", " ", "of", " ", "outputs", "\n", 
            "vars"}], ":", " ", 
           RowBox[{"contains", " ", "all", " ", 
            RowBox[{"W", "'"}], "s", " ", "except", " ", "W0", " ", 
            RowBox[{"(", 
             RowBox[{"same", " ", "as", " ", "X"}], ")"}], "\n", 
            RowBox[{"allvars", ":", " ", 
             RowBox[{"contains", " ", "all", " ", 
              RowBox[{"W", "'"}], "s", "\n", 
              RowBox[{"A", "[", "i", "]"}]}]}]}]}]}], ",", 
         RowBox[{"B", "[", "i", "]"}], ",", 
         RowBox[{
          RowBox[{
           RowBox[{"B", "[", "i", "]"}], ".", 
           RowBox[{
            RowBox[{"A", "[", "i", "]"}], "\[Transpose]"}]}], " ", "define", 
          " ", "activation"}], ",", " ", "backprop", ",", " ", 
         RowBox[{
          RowBox[{"gradient", " ", "for", " ", "layer", " ", "i", "\n", 
           RowBox[{"Bn", "[", "i", "]"}], " ", "truncated", " ", "backprop", 
           " ", "for", " ", 
           RowBox[{"Newton", "'"}], "s", " ", "method", "\n", 
           RowBox[{"hessBlock", "[", 
            RowBox[{"i", ",", "j"}], "]"}], " ", "gives", " ", "Hessian", " ",
            "of", " ", "layer", " ", "i", " ", "with", " ", "respect", " ", 
           "to", " ", "layer", " ", "j", "\n", 
           RowBox[{"hess", "[", 
            RowBox[{"i", ",", "j"}], "]"}], " ", "gives", " ", "Mathematica", 
           " ", "derived", " ", "Hessian", " ", "of", " ", "layer", " ", "i", 
           " ", "with", " ", "respect", " ", "to", " ", "layer", " ", "j", 
           "\n", 
           RowBox[{"gradBlock", "[", "i", "]"}], " ", "gives", " ", 
           "gradient", " ", "at", " ", "layer", " ", "i", "\n", 
           RowBox[{"grad", "[", "i", "]"}]}], ":", " ", 
          RowBox[{
          "gives", " ", "Mathematica", " ", "gradient", " ", "of", " ", 
           "layer", " ", "i", "\n", "sub1"}], ":", " ", 
          RowBox[{"replaces", " ", "all", " ", 
           RowBox[{"W", "'"}], "s", " ", "and", " ", 
           RowBox[{"Y", "'"}], "s", " ", "with", " ", 
           RowBox[{"1", "'"}], "s", "\n", 
           RowBox[{"subr", ":", " ", 
            RowBox[{
             RowBox[{"replaces", " ", "all", " ", 
              RowBox[{"W", "'"}], "s", " ", "and", " ", 
              RowBox[{"Y", "'"}], "s", " ", "with", " ", "fixed", " ", 
              "random"}], "-", 
             RowBox[{"looking", " ", "number"}]}]}]}]}]}], "\n"}]}]}]}]}], 
   "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{"Number", " ", "of", " ", "features", " ", "per", " ", "layer"}], 
   " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{"Number", " ", "of", " ", "layers"}], ",", " ", 
    RowBox[{"aka", " ", "number", " ", "of", " ", "matmuls"}]}], " ", "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{
     RowBox[{"f", "[", "i", "]"}], " ", "shorthand", " ", "for", " ", 
     "shape"}], ",", " ", 
    RowBox[{
     RowBox[{"W", "[", "i", "]"}], " ", "has", " ", "dimensions", " ", 
     RowBox[{"f", "[", "i", "]"}], 
     RowBox[{"xf", "[", 
      RowBox[{"i", "-", "1"}], "]"}]}]}], " ", "*)"}], "\n", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{"f", "[", 
     RowBox[{"-", "1"}], "]"}], " ", "is", " ", "shorthand", " ", "for", " ", 
    "dsize"}], " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"Unprotect", "[", 
     RowBox[{
     "lossEq", ",", "errEq", ",", "gradEq", ",", "hessEq", ",", "errF", ",", 
      "lossF", ",", "gradF", ",", "hessF", ",", "pre0", ",", "n", ",", 
      "dsize", ",", "W", ",", "U", ",", "makeW", ",", "Y", ",", "X", ",", 
      "vars", ",", "Wf", ",", "allvars", ",", "A", ",", "B", ",", "Bn", ",", 
      "hessBlock", ",", "hess", ",", "gradBlock", ",", "grad", ",", "sub1", 
      ",", "subr", ",", "y", ",", "f"}], "]"}], ";"}], "\[IndentingNewLine]", 
   
   RowBox[{
    RowBox[{"Clear", "[", 
     RowBox[{
     "lossEq", ",", "errEq", ",", "gradEq", ",", "hessEq", ",", "n", ",", 
      "dsize", ",", "W", ",", "U", ",", "makeW", ",", "Y", ",", "X", ",", 
      "vars", ",", "allvars", ",", "A", ",", "B", ",", "Bn", ",", "hessBlock",
       ",", "hess", ",", "gradBlock", ",", "grad", ",", "sub1", ",", "subr", 
      ",", "y", ",", "f"}], "]"}], ";"}], "\n", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"fs", "=", 
     RowBox[{"{", 
      RowBox[{"10", ",", "2", ",", "2", ",", "2"}], "}"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"n", "=", 
     RowBox[{
      RowBox[{"Length", "[", "fs", "]"}], "-", "2"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Block", "[", 
     RowBox[{
      RowBox[{"{", "i", "}"}], ",", 
      RowBox[{"For", "[", 
       RowBox[{
        RowBox[{"i", "=", "1"}], ",", " ", 
        RowBox[{"i", "\[LessEqual]", 
         RowBox[{"Length", "[", "fs", "]"}]}], ",", 
        RowBox[{"i", "++"}], ",", 
        RowBox[{
         RowBox[{"f", "[", 
          RowBox[{"i", "-", "2"}], "]"}], "=", 
         RowBox[{"fs", "[", 
          RowBox[{"[", "i", "]"}], "]"}]}]}], "]"}]}], "]"}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"dsize", "=", 
     RowBox[{"f", "[", 
      RowBox[{"-", "1"}], "]"}]}], ";"}], "\n", "\n", 
   RowBox[{"(*", " ", 
    RowBox[{"TODO", ":", " ", 
     RowBox[{"seal", " ", 
      RowBox[{"flatten", "/", "unflatten"}]}]}], " ", "*)"}], "\n", 
   RowBox[{
    RowBox[{"Unprotect", "[", 
     RowBox[{"flatten", ",", "unflatten"}], "]"}], ";"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"flatten", "[", "Ws_", "]"}], ":=", 
     RowBox[{"c2v", "[", 
      RowBox[{"vec", "/@", "Ws"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"unflatten", "[", "Wf_", "]"}], ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"flatVars", ",", "sizes"}], "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"sizes", "=", 
         RowBox[{"Rest", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Times", "@@", "#"}], "&"}], "/@", 
           RowBox[{"Partition", "[", 
            RowBox[{"fs", ",", "2", ",", "1"}], "]"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"flatVars", "=", 
         RowBox[{"listPartition", "[", 
          RowBox[{"Wf", ",", "sizes"}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{"unvec", "[", 
           RowBox[{
            RowBox[{"flatVars", "[", 
             RowBox[{"[", "i", "]"}], "]"}], ",", 
            RowBox[{"fs", "[", 
             RowBox[{"[", 
              RowBox[{"i", "+", "2"}], "]"}], "]"}]}], "]"}], ",", 
          RowBox[{"{", 
           RowBox[{"i", ",", "1", ",", 
            RowBox[{"Length", "@", "sizes"}]}], "}"}]}], "]"}]}]}], 
      "\[IndentingNewLine]", "]"}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{"Protect", "[", 
     RowBox[{"flatten", ",", "unflatten"}], "]"}], ";"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"makeW", "[", "k_", "]"}], ":=", 
     RowBox[{"Array", "[", 
      RowBox[{
       RowBox[{"W", "[", "k", "]"}], ",", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"f", "[", "k", "]"}], ",", 
         RowBox[{"f", "[", 
          RowBox[{"k", "-", "1"}], "]"}]}], "}"}]}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"vars", "=", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{"makeW", "[", "k", "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"k", ",", "1", ",", "n"}], "}"}]}], "]"}]}], ";", " ", 
    RowBox[{"(*", " ", 
     RowBox[{"W1", ",", " ", "W2", ",", " ", "...", ",", " ", "Wn"}], " ", 
     "*)"}], "\[IndentingNewLine]", 
    RowBox[{"Wf", "=", 
     RowBox[{"flatten", "@", "vars"}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{"allvars", "=", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{"makeW", "[", "k", "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"k", ",", "0", ",", "n"}], "}"}]}], "]"}]}], ";", " ", 
    RowBox[{"(*", " ", 
     RowBox[{
     "W0", ",", " ", "W1", ",", " ", "W2", ",", " ", "...", ",", " ", "Wn"}], 
     " ", "*)"}], "\n", "\n", 
    RowBox[{"Y", "=", 
     RowBox[{"Array", "[", 
      RowBox[{"y", ",", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"f", "[", "n", "]"}], ",", 
         RowBox[{"f", "[", 
          RowBox[{"-", "1"}], "]"}]}], "}"}]}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"X", "=", 
     RowBox[{"makeW", "[", "0", "]"}]}], ";"}], "\n", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"errEq", "=", 
     RowBox[{"Y", "-", 
      RowBox[{"Fold", "[", 
       RowBox[{"Dot", ",", 
        RowBox[{"Reverse", "@", "allvars"}]}], "]"}]}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"lossEq", "=", 
     RowBox[{
      RowBox[{"1", "/", "2"}], 
      RowBox[{
       RowBox[{"Tr", "[", 
        RowBox[{
         RowBox[{"errEq", "\[Transpose]"}], ".", "errEq"}], "]"}], "/", 
       "dsize"}]}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"gradEq", "=", 
     RowBox[{"D", "[", 
      RowBox[{"lossEq", ",", 
       RowBox[{"{", 
        RowBox[{"Wf", ",", "1"}], "}"}]}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"hessEq", "=", 
     RowBox[{"D", "[", 
      RowBox[{"lossEq", ",", 
       RowBox[{"{", 
        RowBox[{"Wf", ",", "2"}], "}"}]}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"pre0", "=", 
     RowBox[{"IdentityMatrix", "[", 
      RowBox[{"Length", "@", "Wf"}], "]"}]}], ";"}], "\n", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{"Partial", " ", 
     RowBox[{"products", ".", " ", "Shorthand"}], " ", "notation", " ", "for",
      " ", "doing", " ", "product", " ", "of", " ", "all", " ", "layers", " ",
      "between", " ", "j", " ", "and", " ", "i", " ", 
     RowBox[{
      RowBox[{"(", "inclusive", ")"}], ".", " ", "W"}], " ", "refers", " ", 
     "to", " ", "original", " ", "sums", " ", "and", " ", "U", " ", "is", " ",
      "transpose"}], " ", "*)"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{
     RowBox[{"W", "[", 
      RowBox[{"i", ",", "j"}], "]"}], "=", 
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{"W", "[", "j", "]"}], ".", 
        RowBox[{"W", "[", 
         RowBox[{"j", "-", "1"}], "]"}]}], "..."}], 
      RowBox[{"W", "[", "i", "]"}]}]}], " ", "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"W", "[", 
      RowBox[{"bottom_", ",", "top_"}], "]"}], ":=", 
     RowBox[{
      RowBox[{"IdentityMatrix", "[", 
       RowBox[{"f", "[", "bottom", "]"}], "]"}], "/;", 
      RowBox[{"bottom", "<", "top"}]}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"W", "[", 
      RowBox[{"bottom_", ",", "top_"}], "]"}], ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", "sublist", "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Assert", "[", 
         RowBox[{
          RowBox[{"top", "\[LessEqual]", "bottom"}], ",", 
          "\"\<W ordering\>\""}], "]"}], ";", "\[IndentingNewLine]", 
        RowBox[{"sublist", "=", 
         RowBox[{"allvars", "[", 
          RowBox[{"[", 
           RowBox[{
            RowBox[{"top", "+", "1"}], ";;", 
            RowBox[{"bottom", "+", "1"}]}], "]"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"Fold", "[", 
         RowBox[{"Dot", ",", 
          RowBox[{"Reverse", "@", "sublist"}]}], "]"}]}]}], 
      "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{
     RowBox[{"U", "[", 
      RowBox[{"i", ",", "j"}], "]"}], "=", 
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{"U", "[", "i", "]"}], ".", 
        RowBox[{"U", "[", 
         RowBox[{"i", "+", "1"}], "]"}]}], "..."}], 
      RowBox[{"U", "[", "j", "]"}]}]}], " ", "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"U", "[", 
     RowBox[{"bottom_", ",", "top_"}], "]"}], ":=", 
    RowBox[{
     RowBox[{"IdentityMatrix", "[", 
      RowBox[{"f", "[", "top", "]"}], "]"}], "/;", 
     RowBox[{"bottom", ">", "top"}]}]}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"U", "[", 
      RowBox[{"bottom_", ",", "top_"}], "]"}], ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", "sublist", "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Assert", "[", 
         RowBox[{
          RowBox[{"bottom", "\[LessEqual]", "top"}], ",", 
          "\"\<U ordering\>\""}], "]"}], ";", "\[IndentingNewLine]", 
        RowBox[{"sublist", "=", 
         RowBox[{"Transpose", "/@", 
          RowBox[{"allvars", "[", 
           RowBox[{"[", 
            RowBox[{
             RowBox[{"bottom", "+", "1"}], ";;", 
             RowBox[{"top", "+", "1"}]}], "]"}], "]"}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"Fold", "[", 
         RowBox[{"Dot", ",", "sublist"}], "]"}]}]}], "\[IndentingNewLine]", 
      "]"}]}], ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{
     RowBox[{"Activation", " ", "at", " ", "layer", " ", 
      RowBox[{"i", ".", " ", "Defines"}], " ", "derivative", " ", "for", " ", 
      "layer", " ", 
      RowBox[{"i", ".", " ", 
       RowBox[{"A", "[", "0", "]"}]}]}], "=", 
     RowBox[{"Identit", "[", "dsize", "]"}]}], " ", "*)"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"A", "[", "i_", "]"}], ":=", 
     RowBox[{"W", "[", 
      RowBox[{
       RowBox[{"i", "-", "1"}], ",", "0"}], "]"}]}], ";"}], "          ", 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{
     RowBox[{"Backprop", " ", "at", " ", "layer", " ", 
      RowBox[{"i", ".", " ", "Defines"}], " ", "derivative", " ", "for", " ", 
      "layer", " ", 
      RowBox[{"i", ".", " ", 
       RowBox[{"B", "[", "n", "]"}]}]}], "=", "d_error"}], " ", "*)"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"B", "[", "i_", "]"}], ":=", 
     RowBox[{
      RowBox[{"-", 
       RowBox[{
        RowBox[{"U", "[", 
         RowBox[{
          RowBox[{"i", "+", "1"}], ",", "n"}], "]"}], ".", "errEq"}]}], "/", 
      "dsize"}]}], ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{"Partial", " ", "products", " ", "needed", " ", "for", " ", 
     RowBox[{"Newton", "'"}], "s", " ", "method"}], " ", "*)"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"Bn", "[", "i_", "]"}], ":=", 
     RowBox[{"U", "[", 
      RowBox[{
       RowBox[{"i", "+", "1"}], ",", "n"}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"hessBlock", "[", 
      RowBox[{"i_", ",", "j_"}], "]"}], ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"term1", ",", "term2"}], "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"term1", "=", 
         RowBox[{
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             RowBox[{"A", "[", "i", "]"}], ".", 
             RowBox[{
              RowBox[{"A", "[", "j", "]"}], "\[Transpose]"}]}], ")"}], 
           "\[TensorProduct]", 
           RowBox[{"(", 
            RowBox[{
             RowBox[{"Bn", "[", "i", "]"}], ".", 
             RowBox[{
              RowBox[{"Bn", "[", "j", "]"}], "\[Transpose]"}]}], ")"}]}], "/",
           "dsize"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"Assert", "[", 
         RowBox[{
          RowBox[{"Dimensions", "@", "term1"}], "\[Equal]", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{
             RowBox[{"f", "[", "i", "]"}], "*", 
             RowBox[{"f", "[", 
              RowBox[{"i", "-", "1"}], "]"}]}], ",", 
            RowBox[{
             RowBox[{"f", "[", "j", "]"}], "*", 
             RowBox[{"f", "[", 
              RowBox[{"j", "-", "1"}], "]"}]}]}], "}"}]}], "]"}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"term2", "=", 
         RowBox[{"Which", "[", "\n", 
          RowBox[{
           RowBox[{"i", "\[Equal]", "j"}], ",", 
           RowBox[{"Array", "[", 
            RowBox[{
             RowBox[{"0", "&"}], ",", 
             RowBox[{"Dimensions", "[", "term1", "]"}]}], "]"}], ",", "\n", 
           RowBox[{"i", "<", "j"}], ",", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{
              RowBox[{"A", "[", "i", "]"}], ".", 
              RowBox[{
               RowBox[{"B", "[", "j", "]"}], "\[Transpose]"}]}], ")"}], 
            "\[TensorProduct]", 
            RowBox[{"U", "[", 
             RowBox[{
              RowBox[{"i", "+", "1"}], ",", 
              RowBox[{"j", "-", "1"}]}], "]"}]}], ",", "\[IndentingNewLine]", 
           
           RowBox[{"i", ">", "j"}], ",", 
           RowBox[{
            RowBox[{
             RowBox[{"U", "[", 
              RowBox[{
               RowBox[{"j", "+", "1"}], ",", 
               RowBox[{"i", "-", "1"}]}], "]"}], "\[Transpose]"}], 
            "\[TensorProduct]", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{"B", "[", "i", "]"}], ".", 
              RowBox[{
               RowBox[{"A", "[", "j", "]"}], "\[Transpose]"}]}], ")"}]}]}], 
          "\[IndentingNewLine]", "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"(", 
         RowBox[{"term1", "+", 
          RowBox[{"term2", ".", 
           RowBox[{"Kmat", "[", 
            RowBox[{
             RowBox[{"f", "[", "j", "]"}], ",", 
             RowBox[{"f", "[", 
              RowBox[{"j", "-", "1"}], "]"}]}], "]"}]}]}], ")"}]}]}], 
      "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"gradBlock", "[", "i_", "]"}], ":=", 
     RowBox[{"c2v", "@", 
      RowBox[{"vec", "[", 
       RowBox[{
        RowBox[{"B", "[", "i", "]"}], ".", 
        RowBox[{
         RowBox[{"A", "[", "i", "]"}], "\[Transpose]"}]}], "]"}]}]}], ";"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{
    "substitutes", " ", "1", " ", "to", " ", "every", " ", "variable"}], " ", 
    "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"sub1", ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"everything", "=", 
         RowBox[{
          RowBox[{"Flatten", "[", 
           RowBox[{"vec", "/@", "allvars"}], "]"}], "~", "Join", "~", 
          RowBox[{"c2v", "@", 
           RowBox[{"vec", "@", "Y"}]}]}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"Thread", "[", 
         RowBox[{"everything", "\[Rule]", 
          RowBox[{"Array", "[", 
           RowBox[{
            RowBox[{"1", "&"}], ",", 
            RowBox[{"Length", "@", "everything"}]}], "]"}]}], "]"}]}]}], 
      "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{
    "substitutes", " ", "random", " ", "value", " ", "to", " ", "every", " ", 
     "variable"}], " ", "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"subr", ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"SeedRandom", "[", "0", "]"}], ";", "\[IndentingNewLine]", 
        RowBox[{"everything", "=", 
         RowBox[{
          RowBox[{"Flatten", "[", 
           RowBox[{"vec", "/@", "allvars"}], "]"}], "~", "Join", "~", 
          RowBox[{"c2v", "@", 
           RowBox[{"vec", "@", "Y"}]}]}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"Thread", "[", 
         RowBox[{"everything", "\[Rule]", 
          RowBox[{"RandomReal", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{"-", "1"}], ",", "1"}], "}"}], ",", 
            RowBox[{"Length", "@", "everything"}]}], "]"}]}], "]"}]}]}], 
      "\[IndentingNewLine]", "]"}]}], ";"}], "\n", "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{"Functional", " ", "versions", " ", "of", " ", "equations"}], " ",
     "*)"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"errF", "[", "W_", "]"}], ":=", 
     RowBox[{
      RowBox[{
       RowBox[{"errEq", "/.", "subX"}], "/.", "subY"}], "/.", 
      RowBox[{"subW", "[", "W", "]"}]}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"lossF", "[", "W_", "]"}], ":=", 
     RowBox[{
      RowBox[{
       RowBox[{"lossEq", "/.", "subX"}], "/.", "subY"}], "/.", 
      RowBox[{"subW", "[", "W", "]"}]}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"gradF", "[", "W_", "]"}], ":=", 
     RowBox[{
      RowBox[{
       RowBox[{"gradEq", "/.", "subX"}], "/.", "subY"}], "/.", 
      RowBox[{"subW", "[", "W", "]"}]}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"hessF", "[", "W_", "]"}], ":=", 
     RowBox[{
      RowBox[{
       RowBox[{"hessEq", "/.", "subX"}], "/.", "subY"}], "/.", 
      RowBox[{"subW", "[", "W", "]"}]}]}], ";"}], "\n", "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{"Run", " ", "checks"}], " ", "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"grad", "[", "i_", "]"}], ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", "}"}], ",", 
       RowBox[{
        RowBox[{"Assert", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"i", "\[GreaterEqual]", "0"}], " ", "&&", " ", 
           RowBox[{"i", "\[LessEqual]", "n"}]}], ",", 
          "\"\<grad i check\>\""}], "]"}], ";", "\n", 
        RowBox[{"D", "[", 
         RowBox[{"lossEq", ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"c2v", "@", 
             RowBox[{"vec", "@", 
              RowBox[{"allvars", "[", 
               RowBox[{"[", 
                RowBox[{"i", "+", "1"}], "]"}], "]"}]}]}], ",", "1"}], 
           "}"}]}], "]"}]}]}], "]"}]}], ";"}], "\n", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"hess", "[", 
      RowBox[{"i_", ",", "j_"}], "]"}], ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", "}"}], ",", 
       RowBox[{
        RowBox[{"Assert", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"j", "\[GreaterEqual]", "0"}], "&&", 
           RowBox[{"j", "\[LessEqual]", "n"}]}], ",", 
          "\"\<hess j check\>\""}], "]"}], ";", "\n", 
        RowBox[{"D", "[", 
         RowBox[{
          RowBox[{"grad", "[", "i", "]"}], ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"c2v", "@", 
             RowBox[{"vec", "@", 
              RowBox[{"allvars", "[", 
               RowBox[{"[", 
                RowBox[{"j", "+", "1"}], "]"}], "]"}]}]}], ",", "1"}], 
           "}"}]}], "]"}]}]}], "]"}]}], ";"}], "\[IndentingNewLine]", "\n", 
   RowBox[{
    RowBox[{"Protect", "[", 
     RowBox[{
     "lossEq", ",", "errEq", ",", "gradEq", ",", "hessEq", ",", "errF", ",", 
      "lossF", ",", "gradF", ",", "hessF", ",", "pre0", ",", "n", ",", 
      "dsize", ",", "W", ",", "U", ",", "makeW", ",", "Y", ",", "X", ",", 
      "vars", ",", "Wf", ",", "allvars", ",", "A", ",", "B", ",", "Bn", ",", 
      "hessBlock", ",", "hess", ",", "gradBlock", ",", "grad", ",", "sub1", 
      ",", "subr", ",", "y", ",", "f"}], "]"}], ";"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"idx", "=", 
     RowBox[{
      RowBox[{"Range", "[", 
       RowBox[{"n", "+", "1"}], "]"}], "-", "1"}]}], ";", " ", 
    RowBox[{"(*", " ", 
     RowBox[{
      RowBox[{"all", " ", "valid", " ", "layer", " ", "indices"}], ",", " ", 
      RowBox[{"including", " ", "W0"}]}], " ", "*)"}], "\[IndentingNewLine]", 
    
    RowBox[{"blockIdx", "=", 
     RowBox[{"Outer", "[", 
      RowBox[{"List", ",", "idx", ",", "idx"}], "]"}]}], ";"}], "\n", "\n", 
   RowBox[{"(*", " ", 
    RowBox[{
     RowBox[{
     "Checks", " ", "correctness", " ", "of", " ", "block", " ", "i"}], ",", 
     "j"}], " ", "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"hessCheck", "[", 
      RowBox[{"i_", ",", "j_"}], "]"}], ":=", 
     RowBox[{
      RowBox[{
       RowBox[{"hess", "[", 
        RowBox[{"i", ",", "j"}], "]"}], "\[DotEqual]", 
       RowBox[{"hessBlock", "[", 
        RowBox[{"i", ",", "j"}], "]"}]}], "/.", "subr"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"gradCheck", "[", "i_", "]"}], ":=", 
     RowBox[{
      RowBox[{
       RowBox[{"grad", "[", "i", "]"}], "\[Equal]", 
       RowBox[{"gradBlock", "[", "i", "]"}]}], "/.", "subr"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{"gradCheck", "/@", "idx"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Apply", "[", 
     RowBox[{"hessCheck", ",", " ", "blockIdx", ",", 
      RowBox[{"{", "2", "}"}]}], "]"}], "//", "MatrixForm"}]}]}]], "Code",
 InitializationCell->False,
 CellChangeTimes->{{3.700571573211966*^9, 3.700571608458366*^9}, {
   3.700571649737393*^9, 3.7005717501412477`*^9}, {3.700571808755176*^9, 
   3.70057216687712*^9}, {3.700572202138546*^9, 3.700572253390592*^9}, {
   3.7005723022639217`*^9, 3.700572371418867*^9}, {3.700572402151071*^9, 
   3.700572455048044*^9}, {3.700572567518448*^9, 3.700572754142886*^9}, {
   3.700572810225112*^9, 3.7005728602981453`*^9}, {3.70057289065069*^9, 
   3.700572890946741*^9}, {3.700572921173587*^9, 3.7005729222743998`*^9}, {
   3.7005729709572287`*^9, 3.7005729755772753`*^9}, {3.7005731418669243`*^9, 
   3.7005731540689707`*^9}, {3.700573211909589*^9, 3.7005733452075787`*^9}, {
   3.700573413486807*^9, 3.700573418277412*^9}, {3.700573453985981*^9, 
   3.7005734733931427`*^9}, {3.700573547541644*^9, 3.700573552323368*^9}, {
   3.700574112318883*^9, 3.700574176070272*^9}, {3.700574864857162*^9, 
   3.700574885081049*^9}, {3.7005749238059673`*^9, 3.7005749267759933`*^9}, {
   3.700575034080513*^9, 3.700575061451045*^9}, {3.700575121561865*^9, 
   3.7005755161641912`*^9}, {3.7005755793016853`*^9, 3.700575624964334*^9}, {
   3.7005756693026867`*^9, 3.700575691205001*^9}, {3.7005760474053087`*^9, 
   3.7005761379233217`*^9}, {3.700576253485662*^9, 3.700576278436417*^9}, {
   3.700576407713912*^9, 3.7005764546915073`*^9}, {3.700576506600729*^9, 
   3.700576543566834*^9}, {3.700576586169359*^9, 3.700576646617703*^9}, {
   3.700576685206921*^9, 3.700576981153141*^9}, {3.7005770199853573`*^9, 
   3.7005770584908323`*^9}, {3.700577148078855*^9, 3.700577148831902*^9}, {
   3.700577253165867*^9, 3.700577274414756*^9}, {3.70057737025662*^9, 
   3.700577498505063*^9}, {3.700577539603736*^9, 3.7005777409467382`*^9}, {
   3.7005777770595627`*^9, 3.7005777879017897`*^9}, {3.700578411911454*^9, 
   3.7005784203161087`*^9}, {3.70057856786343*^9, 3.7005785725387497`*^9}, {
   3.700578638601763*^9, 3.700578782408634*^9}, {3.700585037878829*^9, 
   3.700585100910795*^9}, 3.700586926693211*^9, {3.700586958033395*^9, 
   3.70058696380774*^9}, {3.700587190730864*^9, 3.700587223683158*^9}, {
   3.700588395690563*^9, 3.7005883962178793`*^9}, {3.700589262843753*^9, 
   3.7005892953804197`*^9}, {3.700589340806072*^9, 3.700589529030208*^9}, {
   3.700589577767243*^9, 3.7005896184034777`*^9}, {3.700589650418445*^9, 
   3.700589670793825*^9}, {3.700590294957735*^9, 3.700590410091864*^9}, {
   3.700590536272386*^9, 3.700590562788404*^9}, {3.70059068797968*^9, 
   3.700590757345798*^9}, {3.7005911381735783`*^9, 3.7005911755436497`*^9}, {
   3.700591407599194*^9, 3.7005914335770597`*^9}, {3.7005915203038473`*^9, 
   3.7005915528941317`*^9}, 3.700597059725874*^9, {3.700680329044541*^9, 
   3.7006803291681147`*^9}, {3.700681936539171*^9, 3.7006819501607656`*^9}, {
   3.700682201747089*^9, 3.7006822380821037`*^9}}],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{"True", ",", "True", ",", "True"}], "}"}]], "Output",
 CellChangeTimes->{{3.7005892880258904`*^9, 3.70058930006528*^9}, 
   3.700589396288341*^9, 3.700589493544114*^9, 3.700589532502977*^9, 
   3.700589673773287*^9, 3.700590328481139*^9, 3.7005903813033257`*^9, 
   3.700590411707672*^9, 3.700590563362154*^9, 3.700590759337379*^9, 
   3.700591176129065*^9, 3.7005914346844263`*^9, 3.700591554267022*^9, 
   3.7005970625599537`*^9, 3.700680255710085*^9, {3.700680432347402*^9, 
   3.700680442037443*^9}}],

Cell[BoxData[
 TagBox[
  RowBox[{"(", "\[NoBreak]", GridBox[{
     {"True", "True", "True"},
     {"True", "True", "True"},
     {"True", "True", "True"}
    },
    GridBoxAlignment->{
     "Columns" -> {{Center}}, "ColumnsIndexed" -> {}, "Rows" -> {{Baseline}}, 
      "RowsIndexed" -> {}},
    GridBoxSpacings->{"Columns" -> {
        Offset[0.27999999999999997`], {
         Offset[0.7]}, 
        Offset[0.27999999999999997`]}, "ColumnsIndexed" -> {}, "Rows" -> {
        Offset[0.2], {
         Offset[0.4]}, 
        Offset[0.2]}, "RowsIndexed" -> {}}], "\[NoBreak]", ")"}],
  Function[BoxForm`e$, 
   MatrixForm[BoxForm`e$]]]], "Output",
 CellChangeTimes->{{3.7005892880258904`*^9, 3.70058930006528*^9}, 
   3.700589396288341*^9, 3.700589493544114*^9, 3.700589532502977*^9, 
   3.700589673773287*^9, 3.700590328481139*^9, 3.7005903813033257`*^9, 
   3.700590411707672*^9, 3.700590563362154*^9, 3.700590759337379*^9, 
   3.700591176129065*^9, 3.7005914346844263`*^9, 3.700591554267022*^9, 
   3.7005970625599537`*^9, 3.700680255710085*^9, {3.700680432347402*^9, 
   3.70068044215489*^9}}]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["Data setup", "Section",
 CellChangeTimes->{{3.700588463106616*^9, 3.700588465240594*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"generateX", "[", 
    RowBox[{"n_", ",", "e_", ",", "dsize_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"wt", ",", "mean", ",", "cov", ",", "normal", ",", "X"}], "}"}],
      ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"SeedRandom", "[", "0", "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"mean", "=", 
       RowBox[{"Table", "[", 
        RowBox[{"0", ",", 
         RowBox[{"{", "n", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"cov", "=", 
       RowBox[{
        RowBox[{
         RowBox[{"IdentityMatrix", "[", "n", "]"}], "*", "e"}], "+", 
        RowBox[{"Array", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"1", "-", "e"}], "&"}], ",", 
          RowBox[{"{", 
           RowBox[{"n", ",", "n"}], "}"}]}], "]"}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"normal", "=", 
       RowBox[{"MultinormalDistribution", "[", 
        RowBox[{"mean", ",", "cov"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"X", "=", 
       RowBox[{
        RowBox[{"RandomVariate", "[", 
         RowBox[{"normal", ",", 
          RowBox[{"{", "dsize", "}"}]}], "]"}], "//", "Transpose"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"centerData", "[", "X", "]"}]}]}], "\[IndentingNewLine]", 
    "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"SeedRandom", "[", "0", "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"X0", "=", 
   RowBox[{"generateX", "[", 
    RowBox[{
     RowBox[{"f", "[", "0", "]"}], ",", "0.01", ",", "dsize"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"\[Theta]0", "=", 
   RowBox[{"Pi", "/", "20"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Y0", "=", 
    RowBox[{
     RowBox[{"RotationMatrix", "[", "\[Theta]0", "]"}], ".", "X0"}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"Export", "[", 
     RowBox[{
     "\"\<~/git/whitening/exp/data/rotations_simple_X0.csv\>\"", ",", "X0"}], 
     "]"}], ";"}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"Export", "[", 
     RowBox[{
     "\"\<~/git/whitening/exp/data/rotations_simple_Y0.csv\>\"", ",", "Y0"}], 
     "]"}], ";"}], "*)"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"makeInitializer", "[", "k_", "]"}], ":=", 
   RowBox[{"truncatedIdentity", "[", 
    RowBox[{
     RowBox[{"f", "[", "k", "]"}], ",", 
     RowBox[{"f", "[", 
      RowBox[{"k", "-", "1"}], "]"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"W0s", "=", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{"makeInitializer", "[", "k", "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"k", ",", "1", ",", "n"}], "}"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"W0f", "=", 
    RowBox[{"flatten", "@", "W0s"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"Export", "[", 
     RowBox[{
     "\"\<~/git/whitening/exp/data/rotations_simple_W0f.csv\>\"", ",", 
      "W0f"}], "]"}], ";"}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"Export", "[", 
     RowBox[{
     "\"\<~/git/whitening/exp/data/rotations_simple_fs.csv\>\"", ",", "fs"}], 
     "]"}], ";"}], "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{"Todo", ":", " ", 
    RowBox[{"refactor", " ", "into", " ", "helper", " ", "functions"}]}], " ",
    "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"subX", ":=", 
   RowBox[{"Thread", "[", 
    RowBox[{
     RowBox[{"Flatten", "@", "X"}], "\[Rule]", 
     RowBox[{"Flatten", "@", "X0"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"subY", ":=", 
   RowBox[{"Thread", "[", 
    RowBox[{
     RowBox[{"Flatten", "@", "Y"}], "\[Rule]", 
     RowBox[{"Flatten", "@", "Y0"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"subW", "[", "Wfval_", "]"}], ":=", 
   RowBox[{"(", 
    RowBox[{
     RowBox[{"Assert", "[", 
      RowBox[{
       RowBox[{"Length", "@", "Wfval"}], "\[Equal]", 
       RowBox[{"Length", "@", "Wf"}]}], "]"}], ";", 
     RowBox[{"Thread", "[", 
      RowBox[{"Wf", "\[Rule]", "Wfval"}], "]"}]}], ")"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"subW0", ":=", 
   RowBox[{"subW", "[", "W0f", "]"}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.7005884883669167`*^9, 3.7005885599733353`*^9}, {
   3.700588869596386*^9, 3.700588874321349*^9}, {3.70058894512924*^9, 
   3.700588948425765*^9}, {3.700589117053347*^9, 3.700589176620331*^9}, {
   3.700589309833583*^9, 3.700589311238286*^9}, 3.70058954865143*^9, 
   3.70058970202309*^9, {3.700589831106209*^9, 3.700589855392948*^9}, {
   3.700590138211431*^9, 3.700590142777382*^9}, {3.700597118558473*^9, 
   3.700597140406551*^9}, {3.7005971809615917`*^9, 3.70059718967113*^9}, {
   3.700597260681491*^9, 3.7005972658562202`*^9}, {3.700597452507214*^9, 
   3.700597463314937*^9}, {3.700597843277192*^9, 3.700597846224703*^9}, {
   3.7005982955634117`*^9, 3.7005982973735123`*^9}, {3.7006060307518682`*^9, 
   3.70060604191295*^9}}],

Cell[BoxData[""], "Input",
 CellChangeTimes->{{3.700589916818342*^9, 3.700589973243835*^9}, {
   3.700590103086852*^9, 3.700590253106618*^9}, {3.7005904213609667`*^9, 
   3.700590432103702*^9}, {3.700590512801*^9, 3.7005905308022118`*^9}, {
   3.7005905713129263`*^9, 3.700590625224907*^9}, {3.700597091751734*^9, 
   3.700597093269944*^9}, 3.7005971795343447`*^9}]
}, Open  ]],

Cell[CellGroupData[{

Cell["Optimizer setup", "Section",
 CellChangeTimes->{{3.700591671252442*^9, 3.700591674329764*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{
   "Applies", " ", "single", " ", "step", " ", "of", " ", "optimization"}], 
   " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"step", "[", 
      RowBox[{"x_", ",", "lr_", ",", "pre_", ",", "grad_", ",", "lossFunc_"}],
       "]"}], ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"pointsList", "=", 
         RowBox[{"pointList", "~", "Append", "~", "x"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"gradList", "=", 
         RowBox[{"gradList", "~", "Append", "~", "grad"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"preList", "=", 
         RowBox[{"preList", "~", "Append", "~", "pre"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"lossList", "=", 
         RowBox[{"lossList", "~", "Append", "~", 
          RowBox[{"lossFunc", "[", "x", "]"}]}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"x", "-", 
         RowBox[{"lr", "*", 
          RowBox[{"pre", ".", "grad"}]}]}]}]}], "\[IndentingNewLine]", 
      "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"resetStep", ":=", 
     RowBox[{"(", 
      RowBox[{
       RowBox[{
        RowBox[{"{", 
         RowBox[{
         "pointList", ",", " ", "gradList", ",", "preList", ",", " ", 
          "lossList"}], "}"}], "=", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", "}"}], ",", 
          RowBox[{"{", "}"}], ",", 
          RowBox[{"{", "}"}], ",", 
          RowBox[{"{", "}"}]}], "}"}]}], ";", "W0f"}], ")"}]}], 
    ";"}]}]}]], "Input",
 CellChangeTimes->{{3.700591706849535*^9, 3.700591714014675*^9}, 
   3.700607943668601*^9}]
}, Open  ]],

Cell[CellGroupData[{

Cell["Optimizer experiments", "Section",
 CellChangeTimes->{{3.700591718660655*^9, 3.700591721084391*^9}}],

Cell[CellGroupData[{

Cell["Gradient Descent", "Subsection",
 CellChangeTimes->{{3.7005917502542553`*^9, 3.700591760953086*^9}}],

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"optimizeGradient", "[", 
    RowBox[{"lr_", ",", "iters_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", "w", "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"w", "=", "resetStep"}], ";", "\[IndentingNewLine]", 
      RowBox[{"For", "[", 
       RowBox[{
        RowBox[{"iter", "=", "1"}], ",", 
        RowBox[{"iter", "\[LessEqual]", "iters"}], ",", 
        RowBox[{"iter", "++"}], ",", "\[IndentingNewLine]", 
        RowBox[{"w", "=", 
         RowBox[{"step", "[", 
          RowBox[{"w", ",", "lr", ",", "pre0", ",", 
           RowBox[{"gradF", "[", "w", "]"}], ",", "lossF"}], "]"}]}]}], 
       "\[IndentingNewLine]", "]"}], ";"}]}], "\[IndentingNewLine]", "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"optimizeGradient", "[", 
    RowBox[{"1.", ",", "20"}], "]"}], ";"}], "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"Export", "[", 
     RowBox[{
     "\"\<~/git/whitening/exp/data/rotations_simple_gradient_losses.csv\>\"", 
      ",", "lossList"}], "]"}], ";"}], "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{"ListPlot", "[", 
  RowBox[{"lossList", ",", 
   RowBox[{"PlotRange", "\[Rule]", "All"}]}], "]"}]}], "Input",
 CellChangeTimes->{{3.700591723522081*^9, 3.7005917343542852`*^9}, {
  3.700596999916737*^9, 3.700597043318482*^9}, {3.700598151854013*^9, 
  3.7005981808563557`*^9}, {3.700606015555622*^9, 3.700606016464902*^9}}],

Cell[BoxData[
 GraphicsBox[{{}, {{}, 
    {RGBColor[0.368417, 0.506779, 0.709798], PointSize[0.012833333333333334`],
      AbsoluteThickness[1.6], PointBox[CompressedData["
1:eJxTTMoPSmViYGAQAWIQDQEf7G9MLr2582qbPVTAoem2sfnq0hoon8Ph8eoY
NcfphVC+gMNbz4RdO0NToHwRhx9B9kpSMlFQvoTDouUKLqXx/lC+jIP6qVrz
sihXKF/Bwb5jyjqzY9ZQvpLDI9OoI6lSJlC+isMvIYvZ1Z06UL6ag3Q7Xxg7
sxqUr+FwaM7Wu02cilC+loPuseJPC/lkoHwdh3JxPt8JNeJQvp6D/f1p251b
RaB8A4fD4euNDZyEoHxDh9cic547rReA8o0clsyMF85+xQflGzt8Lz7MnCjM
C+WbOPx1X+g7fQq3PQBzzEvs
      "]]}, {}}, {}, {}, {{}, {}}},
  AspectRatio->NCache[GoldenRatio^(-1), 0.6180339887498948],
  Axes->{True, True},
  AxesLabel->{None, None},
  AxesOrigin->{0.703125, 0},
  DisplayFunction->Identity,
  Frame->{{False, False}, {False, False}},
  FrameLabel->{{None, None}, {None, None}},
  FrameTicks->{{Automatic, Automatic}, {Automatic, Automatic}},
  GridLines->{None, None},
  GridLinesStyle->Directive[
    GrayLevel[0.5, 0.4]],
  ImagePadding->All,
  Method->{"CoordinatesToolOptions" -> {"DisplayFunction" -> ({
        (Part[{{Identity, Identity}, {Identity, Identity}}, 1, 2][#]& )[
         Part[#, 1]], 
        (Part[{{Identity, Identity}, {Identity, Identity}}, 2, 2][#]& )[
         Part[#, 2]]}& ), "CopiedValueFunction" -> ({
        (Part[{{Identity, Identity}, {Identity, Identity}}, 1, 2][#]& )[
         Part[#, 1]], 
        (Part[{{Identity, Identity}, {Identity, Identity}}, 2, 2][#]& )[
         Part[#, 2]]}& )}},
  PlotRange->{{1., 20.}, {0, 0.011149837445097718`}},
  PlotRangeClipping->True,
  PlotRangePadding->{{
     Scaled[0.02], 
     Scaled[0.02]}, {
     Scaled[0.02], 
     Scaled[0.05]}},
  Ticks->{Automatic, Automatic}]], "Output",
 CellChangeTimes->{
  3.700591734918679*^9, {3.7005970012360163`*^9, 3.70059700763542*^9}, 
   3.700597044679034*^9, 3.7005972062987432`*^9, 3.7005978647959433`*^9, {
   3.70059815383001*^9, 3.7005981816485786`*^9}, 3.700680268710886*^9, 
   3.700680451234383*^9}]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData["lossList"], "Input",
 CellChangeTimes->{{3.7005985289134893`*^9, 3.7005985301687193`*^9}}],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{
  "0.011149837445097718`", ",", "0.006948155222963661`", ",", 
   "0.0042946381488872835`", ",", "0.002482283353864681`", ",", 
   "0.0015936141216929527`", ",", "0.0009574244106762451`", ",", 
   "0.0006516530256546791`", ",", "0.0004238017559875552`", ",", 
   "0.00030674919649062275`", ",", "0.00021772035471214602`", ",", 
   "0.00016793694069599453`", ",", "0.00012998316274634962`", ",", 
   "0.00010702956625487847`", ",", "0.00008959418052087257`", ",", 
   "0.00007827974140794685`", ",", "0.00006965083313956095`", ",", 
   "0.00006364675382649106`", ",", "0.00005896701115641896`", ",", 
   "0.00005545749488231743`", ",", "0.00005260550251819094`"}], 
  "}"}]], "Output",
 CellChangeTimes->{3.700598530402996*^9}]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["Newton's method", "Subsection",
 CellChangeTimes->{{3.700591766048594*^9, 3.700591774395926*^9}, 
   3.700591894576791*^9}],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"Export", "[", 
     RowBox[{
     "\"\<~/git/whitening/exp/data/rotations_simple_newton_hess0.csv\>\"", 
      ",", 
      RowBox[{"hessF", "[", "W0f", "]"}]}], "]"}], ";"}], "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"Export", "[", 
     RowBox[{
     "\"\<~/git/whitening/exp/data/rotations_simple_newton_ihess0.csv\>\"", 
      ",", 
      RowBox[{"ihessF", "[", "W0f", "]"}]}], "]"}], ";"}], "*)"}]}]], "Input",\

 CellChangeTimes->{{3.700600978282961*^9, 3.7006009928159943`*^9}, {
  3.7006013457762957`*^9, 3.7006013509175863`*^9}, {3.700606048707678*^9, 
  3.700606052217361*^9}}],

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"ihessF", "[", "W_", "]"}], ":=", 
   RowBox[{"PseudoInverse", "@", 
    RowBox[{"hessF", "@", "W"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"optimizeNewton", "[", 
    RowBox[{"lr_", ",", "iters_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", "w", "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"w", "=", "resetStep"}], ";", "\[IndentingNewLine]", 
      RowBox[{"For", "[", 
       RowBox[{
        RowBox[{"iter", "=", "1"}], ",", 
        RowBox[{"iter", "\[LessEqual]", "iters"}], ",", 
        RowBox[{"iter", "++"}], ",", "\[IndentingNewLine]", 
        RowBox[{"w", "=", 
         RowBox[{"step", "[", 
          RowBox[{"w", ",", "lr", ",", 
           RowBox[{"ihessF", "[", "w", "]"}], ",", 
           RowBox[{"gradF", "[", "w", "]"}], ",", "lossF"}], "]"}]}]}], 
       "\[IndentingNewLine]", "]"}], ";"}]}], "\[IndentingNewLine]", "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"optimizeNewton", "[", 
    RowBox[{"1.", ",", "10"}], "]"}], ";"}], "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"Export", "[", 
     RowBox[{
     "\"\<~/git/whitening/exp/data/rotations_simple_newton_losses.csv\>\"", 
      ",", "lossList"}], "]"}], ";"}], "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{"ListPlot", "[", 
  RowBox[{"lossList", ",", 
   RowBox[{"PlotRange", "\[Rule]", "All"}]}], "]"}]}], "Input",
 CellChangeTimes->{{3.7005917804920893`*^9, 3.7005918720000153`*^9}, {
  3.7006024990293427`*^9, 3.700602501934108*^9}, {3.700602665069687*^9, 
  3.700602671156176*^9}, {3.700606021887569*^9, 3.700606023090884*^9}}],

Cell[BoxData[
 GraphicsBox[{{}, {{}, 
    {RGBColor[0.368417, 0.506779, 0.709798], PointSize[0.012833333333333334`],
      AbsoluteThickness[1.6], 
     PointBox[{{1., 0.011149837445097718`}, {2., 0.030865770418542694`}, {3., 
      0.004625711296960099}, {4., 0.00002512293544325525}, {5., 
      1.3850774798914361`*^-9}, {6., 1.3238274753020383`*^-17}, {7., 
      2.3911924892336586`*^-31}, {8., 2.055749659701088*^-32}, {9., 
      1.7888578991265507`*^-33}, {10., 
      1.7888578991265507`*^-33}}]}, {}}, {}, {}, {{}, {}}},
  AspectRatio->NCache[GoldenRatio^(-1), 0.6180339887498948],
  Axes->{True, True},
  AxesLabel->{None, None},
  AxesOrigin->{0.8593750000000001, 0},
  DisplayFunction->Identity,
  Frame->{{False, False}, {False, False}},
  FrameLabel->{{None, None}, {None, None}},
  FrameTicks->{{Automatic, Automatic}, {Automatic, Automatic}},
  GridLines->{None, None},
  GridLinesStyle->Directive[
    GrayLevel[0.5, 0.4]],
  ImagePadding->All,
  Method->{"CoordinatesToolOptions" -> {"DisplayFunction" -> ({
        (Part[{{Identity, Identity}, {Identity, Identity}}, 1, 2][#]& )[
         Part[#, 1]], 
        (Part[{{Identity, Identity}, {Identity, Identity}}, 2, 2][#]& )[
         Part[#, 2]]}& ), "CopiedValueFunction" -> ({
        (Part[{{Identity, Identity}, {Identity, Identity}}, 1, 2][#]& )[
         Part[#, 1]], 
        (Part[{{Identity, Identity}, {Identity, Identity}}, 2, 2][#]& )[
         Part[#, 2]]}& )}},
  PlotRange->{{1., 10.}, {0, 0.030865770418542694`}},
  PlotRangeClipping->True,
  PlotRangePadding->{{
     Scaled[0.02], 
     Scaled[0.02]}, {
     Scaled[0.02], 
     Scaled[0.05]}},
  Ticks->{Automatic, Automatic}]], "Output",
 CellChangeTimes->{{3.700591842653554*^9, 3.7005918970893784`*^9}, {
   3.700602488125052*^9, 3.700602502801003*^9}, 3.700602672172426*^9, 
   3.700680272389578*^9, 3.700680454452467*^9}]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData["lossList"], "Input",
 CellChangeTimes->{{3.7006024835998173`*^9, 3.700602485686352*^9}}],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{
  "0.011149837445097718`", ",", "0.030865770418542694`", ",", 
   "0.004625711296960099`", ",", "0.00002512293544325525`", ",", 
   "1.3850774798914361`*^-9", ",", "1.3238274753020383`*^-17", ",", 
   "2.3911924892336586`*^-31", ",", "2.055749659701088`*^-32", ",", 
   "1.7888578991265507`*^-33", ",", "1.7888578991265507`*^-33"}], 
  "}"}]], "Output",
 CellChangeTimes->{3.700602489446802*^9}]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["Newton' s method with own implementation", "Subsection",
 CellChangeTimes->{{3.700591918979187*^9, 3.700591933272175*^9}}],

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{
  RowBox[{"myHess0", "=", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{"hessBlock", "[", 
      RowBox[{"i", ",", "j"}], "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"i", ",", "1", ",", "n"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"j", ",", "1", ",", "n"}], "}"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"myhessF", "[", "W_", "]"}], ":=", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{"ArrayFlatten", "[", "myHess0", "]"}], "/.", "subX"}], "/.", 
     "subY"}], "/.", 
    RowBox[{"subW", "[", "W", "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"myihessF", "[", "W_", "]"}], ":=", 
   RowBox[{"PseudoInverse", "[", 
    RowBox[{"myhessF", "[", "W", "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ihessF", "[", "W0f", "]"}], "\[DotEqual]", 
  RowBox[{"myihessF", "[", "W0f", "]"}]}]}], "Input",
 CellChangeTimes->{{3.7005923670631723`*^9, 3.700592374583638*^9}, {
  3.700592493690999*^9, 3.70059256557535*^9}, {3.700592901650091*^9, 
  3.700592901851243*^9}, {3.700680296626075*^9, 3.700680296839879*^9}}],

Cell[BoxData["True"], "Output",
 CellChangeTimes->{
  3.70059290403487*^9, {3.70068029084685*^9, 3.700680298349897*^9}, 
   3.700680417509596*^9, {3.700681515339896*^9, 3.700681519234227*^9}}]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"optimizeNewton2", "[", 
    RowBox[{"lr_", ",", "iters_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", "w", "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"w", "=", "resetStep"}], ";", "\[IndentingNewLine]", 
      RowBox[{"For", "[", 
       RowBox[{
        RowBox[{"iter", "=", "1"}], ",", 
        RowBox[{"iter", "\[LessEqual]", "iters"}], ",", 
        RowBox[{"iter", "++"}], ",", "\[IndentingNewLine]", 
        RowBox[{"w", "=", 
         RowBox[{"step", "[", 
          RowBox[{"w", ",", "lr", ",", 
           RowBox[{"myihessF", "[", "w", "]"}], ",", 
           RowBox[{"gradF", "[", "w", "]"}], ",", "lossF"}], "]"}]}]}], 
       "\[IndentingNewLine]", "]"}], ";"}]}], "\[IndentingNewLine]", "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"optimizeNewton2", "[", 
   RowBox[{"1.", ",", "10"}], "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"ListPlot", "[", 
  RowBox[{"lossList", ",", 
   RowBox[{"PlotRange", "\[Rule]", "All"}]}], "]"}]}], "Input",
 CellChangeTimes->{{3.700592914058037*^9, 3.7005929234848413`*^9}, {
  3.700682084552697*^9, 3.700682106319232*^9}}],

Cell[BoxData[
 GraphicsBox[{{}, {{}, 
    {RGBColor[0.368417, 0.506779, 0.709798], PointSize[0.012833333333333334`],
      AbsoluteThickness[1.6], 
     PointBox[{{1., 0.011149837445097718`}, {2., 0.030865770418544075`}, {3., 
      0.004625711296960005}, {4., 0.00002512293544326222}, {5., 
      1.3850774801436398`*^-9}, {6., 1.3238273763299354`*^-17}, {7., 
      2.0737450676189564`*^-32}, {8., 3.9317408424834706`*^-32}, {9., 
      1.0358644298542129`*^-32}, {10., 
      3.21705532351121*^-33}}]}, {}}, {}, {}, {{}, {}}},
  AspectRatio->NCache[GoldenRatio^(-1), 0.6180339887498948],
  Axes->{True, True},
  AxesLabel->{None, None},
  AxesOrigin->{0.8593750000000001, 0},
  DisplayFunction->Identity,
  Frame->{{False, False}, {False, False}},
  FrameLabel->{{None, None}, {None, None}},
  FrameTicks->{{Automatic, Automatic}, {Automatic, Automatic}},
  GridLines->{None, None},
  GridLinesStyle->Directive[
    GrayLevel[0.5, 0.4]],
  ImagePadding->All,
  Method->{"CoordinatesToolOptions" -> {"DisplayFunction" -> ({
        (Part[{{Identity, Identity}, {Identity, Identity}}, 1, 2][#]& )[
         Part[#, 1]], 
        (Part[{{Identity, Identity}, {Identity, Identity}}, 2, 2][#]& )[
         Part[#, 2]]}& ), "CopiedValueFunction" -> ({
        (Part[{{Identity, Identity}, {Identity, Identity}}, 1, 2][#]& )[
         Part[#, 1]], 
        (Part[{{Identity, Identity}, {Identity, Identity}}, 2, 2][#]& )[
         Part[#, 2]]}& )}},
  PlotRange->{{1., 10.}, {0, 0.030865770418544075`}},
  PlotRangeClipping->True,
  PlotRangePadding->{{
     Scaled[0.02], 
     Scaled[0.02]}, {
     Scaled[0.02], 
     Scaled[0.05]}},
  Ticks->{Automatic, Automatic}]], "Output",
 CellChangeTimes->{
  3.700592924455564*^9, {3.700680287140772*^9, 3.700680300425325*^9}, 
   3.70068152315376*^9, {3.7006820825596046`*^9, 3.700682107249094*^9}}]
}, Open  ]]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["Block-diagonal Newton", "Section",
 CellChangeTimes->{{3.700680357296043*^9, 3.700680362122609*^9}, {
  3.700681873782058*^9, 3.7006818750749807`*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"myHess0", "=", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{"hessBlock", "[", 
      RowBox[{"i", ",", "j"}], "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"i", ",", "1", ",", "n"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"j", ",", "1", ",", "n"}], "}"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ihessBdF", "[", "W_", "]"}], ":=", 
   RowBox[{"ArrayFlatten", "[", 
    RowBox[{"blockDiagonalInverse", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"myHess0", "/.", "subX"}], "/.", "subY"}], "/.", 
      RowBox[{"subW", "[", "W", "]"}]}], "]"}], "]"}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.700681549187145*^9, 3.7006816679386663`*^9}, {
   3.700681749324808*^9, 3.700681772631887*^9}, 3.7006818784412394`*^9, {
   3.700681928850766*^9, 3.7006819292102633`*^9}}],

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"optimizeNewtonBd", "[", 
    RowBox[{"lr_", ",", "iters_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", "w", "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"w", "=", "resetStep"}], ";", "\[IndentingNewLine]", 
      RowBox[{"For", "[", 
       RowBox[{
        RowBox[{"iter", "=", "1"}], ",", 
        RowBox[{"iter", "\[LessEqual]", "iters"}], ",", 
        RowBox[{"iter", "++"}], ",", "\[IndentingNewLine]", 
        RowBox[{"w", "=", 
         RowBox[{"step", "[", 
          RowBox[{"w", ",", "lr", ",", 
           RowBox[{"ihessBdF", "[", "w", "]"}], ",", 
           RowBox[{"gradF", "[", "w", "]"}], ",", "lossF"}], "]"}]}]}], 
       "\[IndentingNewLine]", "]"}], ";"}]}], "\[IndentingNewLine]", "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"optimizeNewtonBd", "[", 
   RowBox[{".5", ",", "10"}], "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Export", "[", 
   RowBox[{
   "\"\<~/git/whitening/exp/data/rotations_simple_newtonbd_losses.csv\>\"", 
    ",", "lossList"}], "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"ListPlot", "[", 
  RowBox[{"lossList", ",", 
   RowBox[{"PlotRange", "\[Rule]", "All"}]}], "]"}]}], "Input",
 CellChangeTimes->{{3.700681912694003*^9, 3.7006819131340303`*^9}, {
  3.700681961959177*^9, 3.7006820624783907`*^9}, {3.7006821538196898`*^9, 
  3.700682165595706*^9}}],

Cell[BoxData[
 GraphicsBox[{{}, {{}, 
    {RGBColor[0.368417, 0.506779, 0.709798], PointSize[0.012833333333333334`],
      AbsoluteThickness[1.6], 
     PointBox[{{1., 0.011149837445097718`}, {2., 0.000017159125130450004`}, {
      3., 4.114449754470587*^-11}, {4., 2.336524218518533*^-22}, {5., 
      1.2145546175068912`*^-32}, {6., 2.408164746868571*^-33}, {7., 
      5.220022465673936*^-33}, {8., 5.86520899704366*^-33}, {9., 
      4.2955760923680624`*^-33}, {10., 
      3.361500069340253*^-33}}]}, {}}, {}, {}, {{}, {}}},
  AspectRatio->NCache[GoldenRatio^(-1), 0.6180339887498948],
  Axes->{True, True},
  AxesLabel->{None, None},
  AxesOrigin->{0.8593750000000001, 0},
  DisplayFunction->Identity,
  Frame->{{False, False}, {False, False}},
  FrameLabel->{{None, None}, {None, None}},
  FrameTicks->{{Automatic, Automatic}, {Automatic, Automatic}},
  GridLines->{None, None},
  GridLinesStyle->Directive[
    GrayLevel[0.5, 0.4]],
  ImagePadding->All,
  Method->{"CoordinatesToolOptions" -> {"DisplayFunction" -> ({
        (Part[{{Identity, Identity}, {Identity, Identity}}, 1, 2][#]& )[
         Part[#, 1]], 
        (Part[{{Identity, Identity}, {Identity, Identity}}, 2, 2][#]& )[
         Part[#, 2]]}& ), "CopiedValueFunction" -> ({
        (Part[{{Identity, Identity}, {Identity, Identity}}, 1, 2][#]& )[
         Part[#, 1]], 
        (Part[{{Identity, Identity}, {Identity, Identity}}, 2, 2][#]& )[
         Part[#, 2]]}& )}},
  PlotRange->{{1., 10.}, {0, 0.011149837445097718`}},
  PlotRangeClipping->True,
  PlotRangePadding->{{
     Scaled[0.02], 
     Scaled[0.02]}, {
     Scaled[0.02], 
     Scaled[0.05]}},
  Ticks->{Automatic, Automatic}]], "Output",
 CellChangeTimes->{{3.700681992764299*^9, 3.700682068229167*^9}, 
   3.700682126081962*^9, 3.700682269639689*^9}]
}, Open  ]]
}, Open  ]]
}, Open  ]]
},
WindowSize->{816, 851},
WindowMargins->{{Automatic, 1351}, {Automatic, 573}},
FrontEndVersion->"11.0 for Mac OS X x86 (32-bit, 64-bit Kernel) (September \
21, 2016)",
StyleDefinitions->"Default.nb"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[CellGroupData[{
Cell[580, 22, 98, 1, 32, "Input"],
Cell[681, 25, 1033, 28, 35, "Output"]
}, Open  ]],
Cell[CellGroupData[{
Cell[1751, 58, 92, 1, 92, "Title"],
Cell[CellGroupData[{
Cell[1868, 63, 68, 1, 32, "Input"],
Cell[1939, 66, 1055, 28, 35, "Output"]
}, Open  ]],
Cell[CellGroupData[{
Cell[3031, 99, 91, 1, 64, "Section"],
Cell[CellGroupData[{
Cell[3147, 104, 26260, 685, 2792, "Code",
 InitializationCell->False],
Cell[29410, 791, 367, 8, 24, "Message"],
Cell[29780, 801, 373, 8, 24, "Message"]
}, Open  ]]
}, Open  ]],
Cell[CellGroupData[{
Cell[30202, 815, 147, 2, 64, "Section"],
Cell[CellGroupData[{
Cell[30374, 821, 30739, 776, 2716, "Code",
 InitializationCell->False],
Cell[61116, 1599, 543, 9, 32, "Output"],
Cell[61662, 1610, 1094, 25, 74, "Output"]
}, Open  ]]
}, Open  ]],
Cell[CellGroupData[{
Cell[62805, 1641, 95, 1, 64, "Section"],
Cell[62903, 1644, 5193, 141, 558, "Input"],
Cell[68099, 1787, 365, 5, 32, "Input"]
}, Open  ]],
Cell[CellGroupData[{
Cell[68501, 1797, 100, 1, 64, "Section"],
Cell[68604, 1800, 1759, 49, 222, "Input"]
}, Open  ]],
Cell[CellGroupData[{
Cell[70400, 1854, 106, 1, 64, "Section"],
Cell[CellGroupData[{
Cell[70531, 1859, 106, 1, 44, "Subsection"],
Cell[CellGroupData[{
Cell[70662, 1864, 1485, 36, 201, "Input"],
Cell[72150, 1902, 1943, 44, 234, "Output"]
}, Open  ]],
Cell[CellGroupData[{
Cell[74130, 1951, 104, 1, 32, "Input"],
Cell[74237, 1954, 766, 14, 96, "Output"]
}, Open  ]]
}, Open  ]],
Cell[CellGroupData[{
Cell[75052, 1974, 129, 2, 44, "Subsection"],
Cell[75184, 1978, 686, 20, 54, "Input"],
Cell[CellGroupData[{
Cell[75895, 2002, 1689, 42, 222, "Input"],
Cell[77587, 2046, 1866, 41, 234, "Output"]
}, Open  ]],
Cell[CellGroupData[{
Cell[79490, 2092, 102, 1, 32, "Input"],
Cell[79595, 2095, 435, 9, 58, "Output"]
}, Open  ]]
}, Open  ]],
Cell[CellGroupData[{
Cell[80079, 2110, 128, 1, 44, "Subsection"],
Cell[CellGroupData[{
Cell[80232, 2115, 1141, 31, 96, "Input"],
Cell[81376, 2148, 192, 3, 32, "Output"]
}, Open  ]],
Cell[CellGroupData[{
Cell[81605, 2156, 1191, 29, 180, "Input"],
Cell[82799, 2187, 1841, 41, 234, "Output"]
}, Open  ]]
}, Open  ]]
}, Open  ]],
Cell[CellGroupData[{
Cell[84701, 2235, 157, 2, 64, "Section"],
Cell[84861, 2239, 858, 23, 54, "Input"],
Cell[CellGroupData[{
Cell[85744, 2266, 1432, 35, 201, "Input"],
Cell[87179, 2303, 1791, 40, 268, "Output"]
}, Open  ]]
}, Open  ]]
}, Open  ]]
}
]
*)

