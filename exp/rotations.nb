(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 11.0' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[     71203,       1900]
NotebookOptionsPosition[     68676,       1806]
NotebookOutlinePosition[     69039,       1822]
CellTagsIndexPosition[     68996,       1819]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{

Cell[CellGroupData[{
Cell[BoxData["deploy"], "Input",
 CellChangeTimes->{{3.700671161191558*^9, 3.700671162248221*^9}}],

Cell[BoxData[
 InterpretationBox[
  RowBox[{"CloudObject", "[", 
   TagBox[
    ButtonBox[
     PaneSelectorBox[{
      False->"\<\"https://www.wolframcloud.com/objects/387abe72-50b1-421f-\
924d-0ccdc2e3366b\"\>", True->
      StyleBox["\<\"https://www.wolframcloud.com/objects/387abe72-50b1-421f-\
924d-0ccdc2e3366b\"\>", "HyperlinkActive"]}, Dynamic[
       CurrentValue["MouseOver"]],
      BaseStyle->{"Hyperlink"},
      FrameMargins->0,
      ImageSize->Automatic],
     BaseStyle->"Hyperlink",
     ButtonData->{
       URL[
       "https://www.wolframcloud.com/objects/387abe72-50b1-421f-924d-\
0ccdc2e3366b"], None},
     ButtonNote->
      "https://www.wolframcloud.com/objects/387abe72-50b1-421f-924d-\
0ccdc2e3366b"],
    Annotation[#, 
     "https://www.wolframcloud.com/objects/387abe72-50b1-421f-924d-\
0ccdc2e3366b", "Hyperlink"]& ], "]"}],
  CloudObject[
  "https://www.wolframcloud.com/objects/387abe72-50b1-421f-924d-0ccdc2e3366b"],
  SelectWithContents->True]], "Output",
 CellChangeTimes->{3.700671163524227*^9, 3.700685315202612*^9, 
  3.700688622316287*^9}]
}, Open  ]],

Cell[CellGroupData[{

Cell["Rotations", "Title",
 CellChangeTimes->{{3.700500832581313*^9, 3.700500843502058*^9}}],

Cell[CellGroupData[{

Cell[BoxData[""], "Input",
 CellChangeTimes->{3.700605342115081*^9}],

Cell[BoxData[
 InterpretationBox[
  RowBox[{"CloudObject", "[", 
   TagBox[
    ButtonBox[
     PaneSelectorBox[{
      False->"\<\"https://www.wolframcloud.com/objects/df3a2bf4-dcdf-4788-\
bb00-0ad9d00ba582\"\>", True->
      StyleBox["\<\"https://www.wolframcloud.com/objects/df3a2bf4-dcdf-4788-\
bb00-0ad9d00ba582\"\>", "HyperlinkActive"]}, Dynamic[
       CurrentValue["MouseOver"]],
      BaseStyle->{"Hyperlink"},
      FrameMargins->0,
      ImageSize->Automatic],
     BaseStyle->"Hyperlink",
     ButtonData->{
       URL[
       "https://www.wolframcloud.com/objects/df3a2bf4-dcdf-4788-bb00-\
0ad9d00ba582"], None},
     ButtonNote->
      "https://www.wolframcloud.com/objects/df3a2bf4-dcdf-4788-bb00-\
0ad9d00ba582"],
    Annotation[#, 
     "https://www.wolframcloud.com/objects/df3a2bf4-dcdf-4788-bb00-\
0ad9d00ba582", "Hyperlink"]& ], "]"}],
  CloudObject[
  "https://www.wolframcloud.com/objects/df3a2bf4-dcdf-4788-bb00-0ad9d00ba582"],
  SelectWithContents->True]], "Output",
 CellChangeTimes->{3.700602913191538*^9, 3.700602962748694*^9}]
}, Open  ]],

Cell[CellGroupData[{

Cell["Equation setup", "Section",
 CellChangeTimes->{{3.70058838253695*^9, 3.700588388907529*^9}, {
  3.700588452805987*^9, 3.700588455548293*^9}}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{"Convention", ",", " ", 
    RowBox[{"equations", " ", "end", " ", "with", " ", "\"\<Eq\>\""}], ",", 
    " ", 
    RowBox[{"functions", " ", "end", " ", "with", " ", "capital", " ", 
     RowBox[{"F", ".", " ", "Filenames"}], " ", "all", " ", "lowercase", " ", 
     "and", " ", "separated", " ", "with", " ", "_.", "\n", "Own", " ", 
     "symbols", " ", "start", " ", "with", " ", "lower", " ", 
     RowBox[{"letter", ".", "\n", "\n", 
      RowBox[{"Globals", ":", "\[IndentingNewLine]", "lossEq", ":", " ", 
       RowBox[{"equation", " ", "for", " ", "loss", "\[IndentingNewLine]", 
        RowBox[{"errEq", ":", " ", 
         RowBox[{"equation", " ", "for", " ", "error", "\n", "gradEq"}], ":", 
         " ", 
         RowBox[{"equation", " ", "for", " ", "gradient", "\n", 
          RowBox[{"hessEq", ":", " ", 
           RowBox[{"equation", " ", "for", " ", "Hessian", "\n", "pre0"}], 
           ":", " ", 
           RowBox[{"dummy", " ", "preconditioner", "\n", 
            RowBox[{"n", ":", " ", 
             RowBox[{"number", " ", "of", " ", "layers", "\n", "dsize"}], ":",
              " ", 
             RowBox[{
             "number", " ", "of", " ", "datapoints"}]}]}]}]}]}]}]}]}]}], ",", 
    " ", 
    RowBox[{"aka", " ", 
     RowBox[{"f", "[", 
      RowBox[{"-", "1"}], "]"}], "\n", 
     RowBox[{"fs", ":", " ", 
      RowBox[{"list", " ", "of", " ", "sizes", "\n", 
       RowBox[{"f", "[", "i", "]"}]}], ":", " ", 
      RowBox[{"gives", " ", "dims"}]}]}], ",", " ", 
    RowBox[{"f", "[", "i", "]"}], ",", 
    RowBox[{
     RowBox[{
      RowBox[{"f", "[", 
       RowBox[{"i", "-", "1"}], "]"}], " ", "is", " ", "dimension", " ", "of",
       " ", "layer", " ", "i", "\n", 
      RowBox[{"W", "[", 
       RowBox[{"i", ",", "j"}], "]"}]}], ":", " ", 
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{"W", "[", "i", "]"}], ".", 
        RowBox[{"W", "[", 
         RowBox[{"i", "-", "1"}], "]"}]}], ".."}], 
      RowBox[{"W", "[", "j", "]"}], "\n", 
      RowBox[{"U", "[", 
       RowBox[{"i", ",", "j"}], "]"}]}], ":", " ", 
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{"U", "[", "i", "]"}], ".", 
        RowBox[{"U", "[", 
         RowBox[{"i", "+", "1"}], "]"}]}], "..."}], 
      RowBox[{"U", "[", "j", "]"}], "\n", 
      RowBox[{"makeW", "[", "i", "]"}]}], ":", " ", 
     RowBox[{"creates", " ", "matrix", " ", "of", " ", "form", " ", 
      RowBox[{"{", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{
          RowBox[{"W", "[", "i", "]"}], "[", 
          RowBox[{"1", ",", "1"}], "]"}], ",", 
         RowBox[{
          RowBox[{"W", "[", "i", "]"}], "[", 
          RowBox[{"1", ",", "2"}], "]"}], ",", 
         RowBox[{"...", "\n", 
          RowBox[{"Y", ":", " ", 
           RowBox[{
           "contains", " ", "array", " ", "of", " ", "outputs", "\n", 
            "vars"}], ":", " ", 
           RowBox[{"contains", " ", "all", " ", 
            RowBox[{"W", "'"}], "s", " ", "except", " ", "W0", " ", 
            RowBox[{"(", 
             RowBox[{"same", " ", "as", " ", "X"}], ")"}], "\n", 
            RowBox[{"allvars", ":", " ", 
             RowBox[{"contains", " ", "all", " ", 
              RowBox[{"W", "'"}], "s", "\n", 
              RowBox[{"A", "[", "i", "]"}]}]}]}]}]}], ",", 
         RowBox[{"B", "[", "i", "]"}], ",", 
         RowBox[{
          RowBox[{
           RowBox[{"B", "[", "i", "]"}], ".", 
           RowBox[{
            RowBox[{"A", "[", "i", "]"}], "\[Transpose]"}]}], " ", "define", 
          " ", "activation"}], ",", " ", "backprop", ",", " ", 
         RowBox[{
          RowBox[{"gradient", " ", "for", " ", "layer", " ", "i", "\n", 
           RowBox[{"Bn", "[", "i", "]"}], " ", "truncated", " ", "backprop", 
           " ", "for", " ", 
           RowBox[{"Newton", "'"}], "s", " ", "method", "\n", 
           RowBox[{"hessBlock", "[", 
            RowBox[{"i", ",", "j"}], "]"}], " ", "gives", " ", "Hessian", " ",
            "of", " ", "layer", " ", "i", " ", "with", " ", "respect", " ", 
           "to", " ", "layer", " ", "j", "\n", 
           RowBox[{"hess", "[", 
            RowBox[{"i", ",", "j"}], "]"}], " ", "gives", " ", "Mathematica", 
           " ", "derived", " ", "Hessian", " ", "of", " ", "layer", " ", "i", 
           " ", "with", " ", "respect", " ", "to", " ", "layer", " ", "j", 
           "\n", 
           RowBox[{"gradBlock", "[", "i", "]"}], " ", "gives", " ", 
           "gradient", " ", "at", " ", "layer", " ", "i", "\n", 
           RowBox[{"grad", "[", "i", "]"}]}], ":", " ", 
          RowBox[{
          "gives", " ", "Mathematica", " ", "gradient", " ", "of", " ", 
           "layer", " ", "i", "\n", "sub1"}], ":", " ", 
          RowBox[{"replaces", " ", "all", " ", 
           RowBox[{"W", "'"}], "s", " ", "and", " ", 
           RowBox[{"Y", "'"}], "s", " ", "with", " ", 
           RowBox[{"1", "'"}], "s", "\n", 
           RowBox[{"subr", ":", " ", 
            RowBox[{
             RowBox[{"replaces", " ", "all", " ", 
              RowBox[{"W", "'"}], "s", " ", "and", " ", 
              RowBox[{"Y", "'"}], "s", " ", "with", " ", "fixed", " ", 
              "random"}], "-", 
             RowBox[{"looking", " ", "number"}]}]}]}]}]}], "\n"}]}]}]}]}], 
   "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{"Number", " ", "of", " ", "features", " ", "per", " ", "layer"}], 
   " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{"Number", " ", "of", " ", "layers"}], ",", " ", 
    RowBox[{"aka", " ", "number", " ", "of", " ", "matmuls"}]}], " ", "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{
     RowBox[{"f", "[", "i", "]"}], " ", "shorthand", " ", "for", " ", 
     "shape"}], ",", " ", 
    RowBox[{
     RowBox[{"W", "[", "i", "]"}], " ", "has", " ", "dimensions", " ", 
     RowBox[{"f", "[", "i", "]"}], 
     RowBox[{"xf", "[", 
      RowBox[{"i", "-", "1"}], "]"}]}]}], " ", "*)"}], "\n", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{"f", "[", 
     RowBox[{"-", "1"}], "]"}], " ", "is", " ", "shorthand", " ", "for", " ", 
    "dsize"}], " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"Unprotect", "[", 
     RowBox[{
     "lossEq", ",", "errEq", ",", "gradEq", ",", "hessEq", ",", "errF", ",", 
      "lossF", ",", "gradF", ",", "hessF", ",", "pre0", ",", "n", ",", 
      "dsize", ",", "W", ",", "U", ",", "makeW", ",", "Y", ",", "X", ",", 
      "vars", ",", "Wf", ",", "allvars", ",", "A", ",", "B", ",", "Bn", ",", 
      "hessBlock", ",", "hess", ",", "gradBlock", ",", "grad", ",", "sub1", 
      ",", "subr", ",", "y", ",", "f"}], "]"}], ";"}], "\[IndentingNewLine]", 
   
   RowBox[{
    RowBox[{"Clear", "[", 
     RowBox[{
     "lossEq", ",", "errEq", ",", "gradEq", ",", "hessEq", ",", "n", ",", 
      "dsize", ",", "W", ",", "U", ",", "makeW", ",", "Y", ",", "X", ",", 
      "vars", ",", "allvars", ",", "A", ",", "B", ",", "Bn", ",", "hessBlock",
       ",", "hess", ",", "gradBlock", ",", "grad", ",", "sub1", ",", "subr", 
      ",", "y", ",", "f"}], "]"}], ";"}], "\n", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"fs", "=", 
     RowBox[{"{", 
      RowBox[{"10", ",", "2", ",", "2", ",", "2"}], "}"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"n", "=", 
     RowBox[{
      RowBox[{"Length", "[", "fs", "]"}], "-", "2"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Block", "[", 
     RowBox[{
      RowBox[{"{", "i", "}"}], ",", 
      RowBox[{"For", "[", 
       RowBox[{
        RowBox[{"i", "=", "1"}], ",", " ", 
        RowBox[{"i", "\[LessEqual]", 
         RowBox[{"Length", "[", "fs", "]"}]}], ",", 
        RowBox[{"i", "++"}], ",", 
        RowBox[{
         RowBox[{"f", "[", 
          RowBox[{"i", "-", "2"}], "]"}], "=", 
         RowBox[{"fs", "[", 
          RowBox[{"[", "i", "]"}], "]"}]}]}], "]"}]}], "]"}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"dsize", "=", 
     RowBox[{"f", "[", 
      RowBox[{"-", "1"}], "]"}]}], ";"}], "\n", "\n", 
   RowBox[{"(*", " ", 
    RowBox[{"TODO", ":", " ", 
     RowBox[{"seal", " ", 
      RowBox[{"flatten", "/", "unflatten"}]}]}], " ", "*)"}], "\n", 
   RowBox[{
    RowBox[{"Unprotect", "[", 
     RowBox[{"flatten", ",", "unflatten"}], "]"}], ";"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"flatten", "[", "Ws_", "]"}], ":=", 
     RowBox[{"c2v", "[", 
      RowBox[{"vec", "/@", "Ws"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"unflatten", "[", "Wf_", "]"}], ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"flatVars", ",", "sizes"}], "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"sizes", "=", 
         RowBox[{"Rest", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Times", "@@", "#"}], "&"}], "/@", 
           RowBox[{"Partition", "[", 
            RowBox[{"fs", ",", "2", ",", "1"}], "]"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"flatVars", "=", 
         RowBox[{"listPartition", "[", 
          RowBox[{"Wf", ",", "sizes"}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{"unvec", "[", 
           RowBox[{
            RowBox[{"flatVars", "[", 
             RowBox[{"[", "i", "]"}], "]"}], ",", 
            RowBox[{"fs", "[", 
             RowBox[{"[", 
              RowBox[{"i", "+", "2"}], "]"}], "]"}]}], "]"}], ",", 
          RowBox[{"{", 
           RowBox[{"i", ",", "1", ",", 
            RowBox[{"Length", "@", "sizes"}]}], "}"}]}], "]"}]}]}], 
      "\[IndentingNewLine]", "]"}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{"Protect", "[", 
     RowBox[{"flatten", ",", "unflatten"}], "]"}], ";"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"makeW", "[", "k_", "]"}], ":=", 
     RowBox[{"Array", "[", 
      RowBox[{
       RowBox[{"W", "[", "k", "]"}], ",", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"f", "[", "k", "]"}], ",", 
         RowBox[{"f", "[", 
          RowBox[{"k", "-", "1"}], "]"}]}], "}"}]}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"vars", "=", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{"makeW", "[", "k", "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"k", ",", "1", ",", "n"}], "}"}]}], "]"}]}], ";", " ", 
    RowBox[{"(*", " ", 
     RowBox[{"W1", ",", " ", "W2", ",", " ", "...", ",", " ", "Wn"}], " ", 
     "*)"}], "\[IndentingNewLine]", 
    RowBox[{"Wf", "=", 
     RowBox[{"flatten", "@", "vars"}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{"allvars", "=", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{"makeW", "[", "k", "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"k", ",", "0", ",", "n"}], "}"}]}], "]"}]}], ";", " ", 
    RowBox[{"(*", " ", 
     RowBox[{
     "W0", ",", " ", "W1", ",", " ", "W2", ",", " ", "...", ",", " ", "Wn"}], 
     " ", "*)"}], "\n", "\n", 
    RowBox[{"Y", "=", 
     RowBox[{"Array", "[", 
      RowBox[{"y", ",", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"f", "[", "n", "]"}], ",", 
         RowBox[{"f", "[", 
          RowBox[{"-", "1"}], "]"}]}], "}"}]}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"X", "=", 
     RowBox[{"makeW", "[", "0", "]"}]}], ";"}], "\n", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"errEq", "=", 
     RowBox[{"Y", "-", 
      RowBox[{"Fold", "[", 
       RowBox[{"Dot", ",", 
        RowBox[{"Reverse", "@", "allvars"}]}], "]"}]}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"lossEq", "=", 
     RowBox[{
      RowBox[{"1", "/", "2"}], 
      RowBox[{
       RowBox[{"Tr", "[", 
        RowBox[{
         RowBox[{"errEq", "\[Transpose]"}], ".", "errEq"}], "]"}], "/", 
       "dsize"}]}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"gradEq", "=", 
     RowBox[{"D", "[", 
      RowBox[{"lossEq", ",", 
       RowBox[{"{", 
        RowBox[{"Wf", ",", "1"}], "}"}]}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"hessEq", "=", 
     RowBox[{"D", "[", 
      RowBox[{"lossEq", ",", 
       RowBox[{"{", 
        RowBox[{"Wf", ",", "2"}], "}"}]}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"pre0", "=", 
     RowBox[{"IdentityMatrix", "[", 
      RowBox[{"Length", "@", "Wf"}], "]"}]}], ";"}], "\n", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{"Partial", " ", 
     RowBox[{"products", ".", " ", "Shorthand"}], " ", "notation", " ", "for",
      " ", "doing", " ", "product", " ", "of", " ", "all", " ", "layers", " ",
      "between", " ", "j", " ", "and", " ", "i", " ", 
     RowBox[{
      RowBox[{"(", "inclusive", ")"}], ".", " ", "W"}], " ", "refers", " ", 
     "to", " ", "original", " ", "sums", " ", "and", " ", "U", " ", "is", " ",
      "transpose"}], " ", "*)"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{
     RowBox[{"W", "[", 
      RowBox[{"i", ",", "j"}], "]"}], "=", 
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{"W", "[", "j", "]"}], ".", 
        RowBox[{"W", "[", 
         RowBox[{"j", "-", "1"}], "]"}]}], "..."}], 
      RowBox[{"W", "[", "i", "]"}]}]}], " ", "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"W", "[", 
      RowBox[{"bottom_", ",", "top_"}], "]"}], ":=", 
     RowBox[{
      RowBox[{"IdentityMatrix", "[", 
       RowBox[{"f", "[", "bottom", "]"}], "]"}], "/;", 
      RowBox[{"bottom", "<", "top"}]}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"W", "[", 
      RowBox[{"bottom_", ",", "top_"}], "]"}], ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", "sublist", "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Assert", "[", 
         RowBox[{
          RowBox[{"top", "\[LessEqual]", "bottom"}], ",", 
          "\"\<W ordering\>\""}], "]"}], ";", "\[IndentingNewLine]", 
        RowBox[{"sublist", "=", 
         RowBox[{"allvars", "[", 
          RowBox[{"[", 
           RowBox[{
            RowBox[{"top", "+", "1"}], ";;", 
            RowBox[{"bottom", "+", "1"}]}], "]"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"Fold", "[", 
         RowBox[{"Dot", ",", 
          RowBox[{"Reverse", "@", "sublist"}]}], "]"}]}]}], 
      "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{
     RowBox[{"U", "[", 
      RowBox[{"i", ",", "j"}], "]"}], "=", 
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{"U", "[", "i", "]"}], ".", 
        RowBox[{"U", "[", 
         RowBox[{"i", "+", "1"}], "]"}]}], "..."}], 
      RowBox[{"U", "[", "j", "]"}]}]}], " ", "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"U", "[", 
     RowBox[{"bottom_", ",", "top_"}], "]"}], ":=", 
    RowBox[{
     RowBox[{"IdentityMatrix", "[", 
      RowBox[{"f", "[", "top", "]"}], "]"}], "/;", 
     RowBox[{"bottom", ">", "top"}]}]}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"U", "[", 
      RowBox[{"bottom_", ",", "top_"}], "]"}], ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", "sublist", "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Assert", "[", 
         RowBox[{
          RowBox[{"bottom", "\[LessEqual]", "top"}], ",", 
          "\"\<U ordering\>\""}], "]"}], ";", "\[IndentingNewLine]", 
        RowBox[{"sublist", "=", 
         RowBox[{"Transpose", "/@", 
          RowBox[{"allvars", "[", 
           RowBox[{"[", 
            RowBox[{
             RowBox[{"bottom", "+", "1"}], ";;", 
             RowBox[{"top", "+", "1"}]}], "]"}], "]"}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"Fold", "[", 
         RowBox[{"Dot", ",", "sublist"}], "]"}]}]}], "\[IndentingNewLine]", 
      "]"}]}], ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{
     RowBox[{"Activation", " ", "at", " ", "layer", " ", 
      RowBox[{"i", ".", " ", "Defines"}], " ", "derivative", " ", "for", " ", 
      "layer", " ", 
      RowBox[{"i", ".", " ", 
       RowBox[{"A", "[", "0", "]"}]}]}], "=", 
     RowBox[{"Identit", "[", "dsize", "]"}]}], " ", "*)"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"A", "[", "i_", "]"}], ":=", 
     RowBox[{"W", "[", 
      RowBox[{
       RowBox[{"i", "-", "1"}], ",", "0"}], "]"}]}], ";"}], "          ", 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{
     RowBox[{"Backprop", " ", "at", " ", "layer", " ", 
      RowBox[{"i", ".", " ", "Defines"}], " ", "derivative", " ", "for", " ", 
      "layer", " ", 
      RowBox[{"i", ".", " ", 
       RowBox[{"B", "[", "n", "]"}]}]}], "=", "d_error"}], " ", "*)"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"B", "[", "i_", "]"}], ":=", 
     RowBox[{
      RowBox[{"-", 
       RowBox[{
        RowBox[{"U", "[", 
         RowBox[{
          RowBox[{"i", "+", "1"}], ",", "n"}], "]"}], ".", "errEq"}]}], "/", 
      "dsize"}]}], ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{"Partial", " ", "products", " ", "needed", " ", "for", " ", 
     RowBox[{"Newton", "'"}], "s", " ", "method"}], " ", "*)"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"Bn", "[", "i_", "]"}], ":=", 
     RowBox[{"U", "[", 
      RowBox[{
       RowBox[{"i", "+", "1"}], ",", "n"}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"hessBlock", "[", 
      RowBox[{"i_", ",", "j_"}], "]"}], ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"term1", ",", "term2"}], "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"term1", "=", 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{
              RowBox[{"A", "[", "i", "]"}], ".", 
              RowBox[{
               RowBox[{"A", "[", "j", "]"}], "\[Transpose]"}]}], ")"}], 
            "\[TensorProduct]", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{"Bn", "[", "i", "]"}], ".", 
              RowBox[{
               RowBox[{"Bn", "[", "j", "]"}], "\[Transpose]"}]}], ")"}]}], 
           ")"}], "/", "dsize"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"Assert", "[", 
         RowBox[{
          RowBox[{"Dimensions", "@", "term1"}], "\[Equal]", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{
             RowBox[{"f", "[", "i", "]"}], "*", 
             RowBox[{"f", "[", 
              RowBox[{"i", "-", "1"}], "]"}]}], ",", 
            RowBox[{
             RowBox[{"f", "[", "j", "]"}], "*", 
             RowBox[{"f", "[", 
              RowBox[{"j", "-", "1"}], "]"}]}]}], "}"}]}], "]"}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"term2", "=", 
         RowBox[{"Which", "[", "\n", 
          RowBox[{
           RowBox[{"i", "\[Equal]", "j"}], ",", 
           RowBox[{"Array", "[", 
            RowBox[{
             RowBox[{"0", "&"}], ",", 
             RowBox[{"Dimensions", "[", "term1", "]"}]}], "]"}], ",", "\n", 
           RowBox[{"i", "<", "j"}], ",", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{
              RowBox[{"A", "[", "i", "]"}], ".", 
              RowBox[{
               RowBox[{"B", "[", "j", "]"}], "\[Transpose]"}]}], ")"}], 
            "\[TensorProduct]", 
            RowBox[{"U", "[", 
             RowBox[{
              RowBox[{"i", "+", "1"}], ",", 
              RowBox[{"j", "-", "1"}]}], "]"}]}], ",", "\[IndentingNewLine]", 
           
           RowBox[{"i", ">", "j"}], ",", 
           RowBox[{
            RowBox[{
             RowBox[{"U", "[", 
              RowBox[{
               RowBox[{"j", "+", "1"}], ",", 
               RowBox[{"i", "-", "1"}]}], "]"}], "\[Transpose]"}], 
            "\[TensorProduct]", 
            RowBox[{"(", 
             RowBox[{
              RowBox[{"B", "[", "i", "]"}], ".", 
              RowBox[{
               RowBox[{"A", "[", "j", "]"}], "\[Transpose]"}]}], ")"}]}]}], 
          "\[IndentingNewLine]", "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"(", 
         RowBox[{"term1", "+", 
          RowBox[{"term2", ".", 
           RowBox[{"Kmat", "[", 
            RowBox[{
             RowBox[{"f", "[", "j", "]"}], ",", 
             RowBox[{"f", "[", 
              RowBox[{"j", "-", "1"}], "]"}]}], "]"}]}]}], ")"}]}]}], 
      "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"gradBlock", "[", "i_", "]"}], ":=", 
     RowBox[{"c2v", "@", 
      RowBox[{"vec", "[", 
       RowBox[{
        RowBox[{"B", "[", "i", "]"}], ".", 
        RowBox[{
         RowBox[{"A", "[", "i", "]"}], "\[Transpose]"}]}], "]"}]}]}], ";"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{
    "substitutes", " ", "1", " ", "to", " ", "every", " ", "variable"}], " ", 
    "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"sub1", ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"everything", "=", 
         RowBox[{
          RowBox[{"Flatten", "[", 
           RowBox[{"vec", "/@", "allvars"}], "]"}], "~", "Join", "~", 
          RowBox[{"c2v", "@", 
           RowBox[{"vec", "@", "Y"}]}]}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"Thread", "[", 
         RowBox[{"everything", "\[Rule]", 
          RowBox[{"Array", "[", 
           RowBox[{
            RowBox[{"1", "&"}], ",", 
            RowBox[{"Length", "@", "everything"}]}], "]"}]}], "]"}]}]}], 
      "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{
    "substitutes", " ", "random", " ", "value", " ", "to", " ", "every", " ", 
     "variable"}], " ", "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"subr", ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"SeedRandom", "[", "0", "]"}], ";", "\[IndentingNewLine]", 
        RowBox[{"everything", "=", 
         RowBox[{
          RowBox[{"Flatten", "[", 
           RowBox[{"vec", "/@", "allvars"}], "]"}], "~", "Join", "~", 
          RowBox[{"c2v", "@", 
           RowBox[{"vec", "@", "Y"}]}]}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"Thread", "[", 
         RowBox[{"everything", "\[Rule]", 
          RowBox[{"RandomReal", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{"-", "1"}], ",", "1"}], "}"}], ",", 
            RowBox[{"Length", "@", "everything"}]}], "]"}]}], "]"}]}]}], 
      "\[IndentingNewLine]", "]"}]}], ";"}], "\n", "\n", 
   RowBox[{"(*", " ", 
    RowBox[{"Functional", " ", "versions", " ", "of", " ", "equations"}], " ",
     "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"errF", "[", "W_", "]"}], ":=", 
     RowBox[{
      RowBox[{
       RowBox[{"errEq", "/.", "subX"}], "/.", "subY"}], "/.", 
      RowBox[{"subW", "[", "W", "]"}]}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"lossF", "[", "W_", "]"}], ":=", 
     RowBox[{
      RowBox[{
       RowBox[{"lossEq", "/.", "subX"}], "/.", "subY"}], "/.", 
      RowBox[{"subW", "[", "W", "]"}]}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"gradF", "[", "W_", "]"}], ":=", 
     RowBox[{
      RowBox[{
       RowBox[{"gradEq", "/.", "subX"}], "/.", "subY"}], "/.", 
      RowBox[{"subW", "[", "W", "]"}]}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"hessF", "[", "W_", "]"}], ":=", 
     RowBox[{
      RowBox[{
       RowBox[{"hessEq", "/.", "subX"}], "/.", "subY"}], "/.", 
      RowBox[{"subW", "[", "W", "]"}]}]}], ";"}], "\[IndentingNewLine]", "\n", 
   RowBox[{"(*", " ", 
    RowBox[{"Run", " ", "checks"}], " ", "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"grad", "[", "i_", "]"}], ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", "}"}], ",", 
       RowBox[{
        RowBox[{"Assert", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"i", "\[GreaterEqual]", "0"}], " ", "&&", " ", 
           RowBox[{"i", "\[LessEqual]", "n"}]}], ",", 
          "\"\<grad i check\>\""}], "]"}], ";", "\n", 
        RowBox[{"D", "[", 
         RowBox[{"lossEq", ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"c2v", "@", 
             RowBox[{"vec", "@", 
              RowBox[{"allvars", "[", 
               RowBox[{"[", 
                RowBox[{"i", "+", "1"}], "]"}], "]"}]}]}], ",", "1"}], 
           "}"}]}], "]"}]}]}], "]"}]}], ";"}], "\n", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"hess", "[", 
      RowBox[{"i_", ",", "j_"}], "]"}], ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", "}"}], ",", 
       RowBox[{
        RowBox[{"Assert", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"j", "\[GreaterEqual]", "0"}], "&&", 
           RowBox[{"j", "\[LessEqual]", "n"}]}], ",", 
          "\"\<hess j check\>\""}], "]"}], ";", "\n", 
        RowBox[{"D", "[", 
         RowBox[{
          RowBox[{"grad", "[", "i", "]"}], ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"c2v", "@", 
             RowBox[{"vec", "@", 
              RowBox[{"allvars", "[", 
               RowBox[{"[", 
                RowBox[{"j", "+", "1"}], "]"}], "]"}]}]}], ",", "1"}], 
           "}"}]}], "]"}]}]}], "]"}]}], ";"}], "\[IndentingNewLine]", "\n", 
   RowBox[{
    RowBox[{"Protect", "[", 
     RowBox[{
     "lossEq", ",", "errEq", ",", "gradEq", ",", "hessEq", ",", "errF", ",", 
      "lossF", ",", "gradF", ",", "hessF", ",", "pre0", ",", "n", ",", 
      "dsize", ",", "W", ",", "U", ",", "makeW", ",", "Y", ",", "X", ",", 
      "vars", ",", "Wf", ",", "allvars", ",", "A", ",", "B", ",", "Bn", ",", 
      "hessBlock", ",", "hess", ",", "gradBlock", ",", "grad", ",", "sub1", 
      ",", "subr", ",", "y", ",", "f"}], "]"}], ";"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"idx", "=", 
     RowBox[{
      RowBox[{"Range", "[", 
       RowBox[{"n", "+", "1"}], "]"}], "-", "1"}]}], ";", " ", 
    RowBox[{"(*", " ", 
     RowBox[{
      RowBox[{"all", " ", "valid", " ", "layer", " ", "indices"}], ",", " ", 
      RowBox[{"including", " ", "W0"}]}], " ", "*)"}], "\[IndentingNewLine]", 
    
    RowBox[{"blockIdx", "=", 
     RowBox[{"Outer", "[", 
      RowBox[{"List", ",", "idx", ",", "idx"}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", "\n", 
   RowBox[{"(*", " ", 
    RowBox[{
     RowBox[{
     "Checks", " ", "correctness", " ", "of", " ", "block", " ", "i"}], ",", 
     "j"}], " ", "*)"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"hessCheck", "[", 
      RowBox[{"i_", ",", "j_"}], "]"}], ":=", 
     RowBox[{
      RowBox[{
       RowBox[{"hess", "[", 
        RowBox[{"i", ",", "j"}], "]"}], "\[DotEqual]", 
       RowBox[{"hessBlock", "[", 
        RowBox[{"i", ",", "j"}], "]"}]}], "/.", "subr"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"gradCheck", "[", "i_", "]"}], ":=", 
     RowBox[{
      RowBox[{
       RowBox[{"grad", "[", "i", "]"}], "\[Equal]", 
       RowBox[{"gradBlock", "[", "i", "]"}]}], "/.", "subr"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{"gradCheck", "/@", "idx"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Apply", "[", 
     RowBox[{"hessCheck", ",", " ", "blockIdx", ",", 
      RowBox[{"{", "2", "}"}]}], "]"}], "//", "MatrixForm"}]}]}]], "Code",
 InitializationCell->False,
 CellChangeTimes->{{3.700571573211966*^9, 3.700571608458366*^9}, {
   3.700571649737393*^9, 3.7005717501412477`*^9}, {3.700571808755176*^9, 
   3.70057216687712*^9}, {3.700572202138546*^9, 3.700572253390592*^9}, {
   3.7005723022639217`*^9, 3.700572371418867*^9}, {3.700572402151071*^9, 
   3.700572455048044*^9}, {3.700572567518448*^9, 3.700572754142886*^9}, {
   3.700572810225112*^9, 3.7005728602981453`*^9}, {3.70057289065069*^9, 
   3.700572890946741*^9}, {3.700572921173587*^9, 3.7005729222743998`*^9}, {
   3.7005729709572287`*^9, 3.7005729755772753`*^9}, {3.7005731418669243`*^9, 
   3.7005731540689707`*^9}, {3.700573211909589*^9, 3.7005733452075787`*^9}, {
   3.700573413486807*^9, 3.700573418277412*^9}, {3.700573453985981*^9, 
   3.7005734733931427`*^9}, {3.700573547541644*^9, 3.700573552323368*^9}, {
   3.700574112318883*^9, 3.700574176070272*^9}, {3.700574864857162*^9, 
   3.700574885081049*^9}, {3.7005749238059673`*^9, 3.7005749267759933`*^9}, {
   3.700575034080513*^9, 3.700575061451045*^9}, {3.700575121561865*^9, 
   3.7005755161641912`*^9}, {3.7005755793016853`*^9, 3.700575624964334*^9}, {
   3.7005756693026867`*^9, 3.700575691205001*^9}, {3.7005760474053087`*^9, 
   3.7005761379233217`*^9}, {3.700576253485662*^9, 3.700576278436417*^9}, {
   3.700576407713912*^9, 3.7005764546915073`*^9}, {3.700576506600729*^9, 
   3.700576543566834*^9}, {3.700576586169359*^9, 3.700576646617703*^9}, {
   3.700576685206921*^9, 3.700576981153141*^9}, {3.7005770199853573`*^9, 
   3.7005770584908323`*^9}, {3.700577148078855*^9, 3.700577148831902*^9}, {
   3.700577253165867*^9, 3.700577274414756*^9}, {3.70057737025662*^9, 
   3.700577498505063*^9}, {3.700577539603736*^9, 3.7005777409467382`*^9}, {
   3.7005777770595627`*^9, 3.7005777879017897`*^9}, {3.700578411911454*^9, 
   3.7005784203161087`*^9}, {3.70057856786343*^9, 3.7005785725387497`*^9}, {
   3.700578638601763*^9, 3.700578782408634*^9}, {3.700585037878829*^9, 
   3.700585100910795*^9}, 3.700586926693211*^9, {3.700586958033395*^9, 
   3.70058696380774*^9}, {3.700587190730864*^9, 3.700587223683158*^9}, {
   3.700588395690563*^9, 3.7005883962178793`*^9}, {3.700589262843753*^9, 
   3.7005892953804197`*^9}, {3.700589340806072*^9, 3.700589529030208*^9}, {
   3.700589577767243*^9, 3.7005896184034777`*^9}, {3.700589650418445*^9, 
   3.700589670793825*^9}, {3.700590294957735*^9, 3.700590410091864*^9}, {
   3.700590536272386*^9, 3.700590562788404*^9}, {3.70059068797968*^9, 
   3.700590757345798*^9}, {3.7005911381735783`*^9, 3.7005911755436497`*^9}, {
   3.700591407599194*^9, 3.7005914335770597`*^9}, {3.7005915203038473`*^9, 
   3.7005915528941317`*^9}, 3.700597059725874*^9, {3.700680329044541*^9, 
   3.7006803291681147`*^9}, {3.700681936539171*^9, 3.7006819501607656`*^9}, {
   3.700682201747089*^9, 3.7006822380821037`*^9}, {3.7007704095770693`*^9, 
   3.700770411689818*^9}}],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{"True", ",", "True", ",", "True"}], "}"}]], "Output",
 CellChangeTimes->{{3.7005892880258904`*^9, 3.70058930006528*^9}, 
   3.700589396288341*^9, 3.700589493544114*^9, 3.700589532502977*^9, 
   3.700589673773287*^9, 3.700590328481139*^9, 3.7005903813033257`*^9, 
   3.700590411707672*^9, 3.700590563362154*^9, 3.700590759337379*^9, 
   3.700591176129065*^9, 3.7005914346844263`*^9, 3.700591554267022*^9, 
   3.7005970625599537`*^9, 3.700680255710085*^9, {3.700680432347402*^9, 
   3.700680442037443*^9}, {3.700770404437522*^9, 3.700770412883275*^9}}],

Cell[BoxData[
 TagBox[
  RowBox[{"(", "\[NoBreak]", GridBox[{
     {"True", "True", "True"},
     {"True", "True", "True"},
     {"True", "True", "True"}
    },
    GridBoxAlignment->{
     "Columns" -> {{Center}}, "ColumnsIndexed" -> {}, "Rows" -> {{Baseline}}, 
      "RowsIndexed" -> {}},
    GridBoxSpacings->{"Columns" -> {
        Offset[0.27999999999999997`], {
         Offset[0.7]}, 
        Offset[0.27999999999999997`]}, "ColumnsIndexed" -> {}, "Rows" -> {
        Offset[0.2], {
         Offset[0.4]}, 
        Offset[0.2]}, "RowsIndexed" -> {}}], "\[NoBreak]", ")"}],
  Function[BoxForm`e$, 
   MatrixForm[BoxForm`e$]]]], "Output",
 CellChangeTimes->{{3.7005892880258904`*^9, 3.70058930006528*^9}, 
   3.700589396288341*^9, 3.700589493544114*^9, 3.700589532502977*^9, 
   3.700589673773287*^9, 3.700590328481139*^9, 3.7005903813033257`*^9, 
   3.700590411707672*^9, 3.700590563362154*^9, 3.700590759337379*^9, 
   3.700591176129065*^9, 3.7005914346844263`*^9, 3.700591554267022*^9, 
   3.7005970625599537`*^9, 3.700680255710085*^9, {3.700680432347402*^9, 
   3.700680442037443*^9}, {3.700770404437522*^9, 3.7007704129774933`*^9}}]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["Data setup", "Section",
 CellChangeTimes->{{3.700588463106616*^9, 3.700588465240594*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"generateX", "[", 
    RowBox[{"n_", ",", "e_", ",", "dsize_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"wt", ",", "mean", ",", "cov", ",", "normal", ",", "X"}], "}"}],
      ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"SeedRandom", "[", "0", "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"mean", "=", 
       RowBox[{"Table", "[", 
        RowBox[{"0", ",", 
         RowBox[{"{", "n", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"cov", "=", 
       RowBox[{
        RowBox[{
         RowBox[{"IdentityMatrix", "[", "n", "]"}], "*", "e"}], "+", 
        RowBox[{"Array", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"1", "-", "e"}], "&"}], ",", 
          RowBox[{"{", 
           RowBox[{"n", ",", "n"}], "}"}]}], "]"}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"normal", "=", 
       RowBox[{"MultinormalDistribution", "[", 
        RowBox[{"mean", ",", "cov"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"X", "=", 
       RowBox[{
        RowBox[{"RandomVariate", "[", 
         RowBox[{"normal", ",", 
          RowBox[{"{", "dsize", "}"}]}], "]"}], "//", "Transpose"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"centerData", "[", "X", "]"}]}]}], "\[IndentingNewLine]", 
    "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"SeedRandom", "[", "0", "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"X0", "=", 
   RowBox[{"generateX", "[", 
    RowBox[{
     RowBox[{"f", "[", "0", "]"}], ",", "0.01", ",", "dsize"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"\[Theta]0", "=", 
   RowBox[{"Pi", "/", "20"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Y0", "=", 
    RowBox[{
     RowBox[{"RotationMatrix", "[", "\[Theta]0", "]"}], ".", "X0"}]}], ";"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"Export", "[", 
     RowBox[{
     "\"\<~/git/whitening/exp/data/rotations_simple_X0.csv\>\"", ",", "X0"}], 
     "]"}], ";"}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"Export", "[", 
     RowBox[{
     "\"\<~/git/whitening/exp/data/rotations_simple_Y0.csv\>\"", ",", "Y0"}], 
     "]"}], ";"}], "*)"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"makeInitializer", "[", "k_", "]"}], ":=", 
   RowBox[{"truncatedIdentity", "[", 
    RowBox[{
     RowBox[{"f", "[", "k", "]"}], ",", 
     RowBox[{"f", "[", 
      RowBox[{"k", "-", "1"}], "]"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"W0s", "=", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{"makeInitializer", "[", "k", "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"k", ",", "1", ",", "n"}], "}"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"W0f", "=", 
    RowBox[{"flatten", "@", "W0s"}]}], ";"}], "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"Export", "[", 
     RowBox[{
     "\"\<~/git/whitening/exp/data/rotations_simple_W0f.csv\>\"", ",", 
      "W0f"}], "]"}], ";"}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"Export", "[", 
     RowBox[{
     "\"\<~/git/whitening/exp/data/rotations_simple_fs.csv\>\"", ",", "fs"}], 
     "]"}], ";"}], "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{"Todo", ":", " ", 
    RowBox[{"refactor", " ", "into", " ", "helper", " ", "functions"}]}], " ",
    "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"subX", ":=", 
   RowBox[{"Thread", "[", 
    RowBox[{
     RowBox[{"Flatten", "@", "X"}], "\[Rule]", 
     RowBox[{"Flatten", "@", "X0"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"subY", ":=", 
   RowBox[{"Thread", "[", 
    RowBox[{
     RowBox[{"Flatten", "@", "Y"}], "\[Rule]", 
     RowBox[{"Flatten", "@", "Y0"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"subW", "[", "Wfval_", "]"}], ":=", 
   RowBox[{"(", 
    RowBox[{
     RowBox[{"Assert", "[", 
      RowBox[{
       RowBox[{"Length", "@", "Wfval"}], "\[Equal]", 
       RowBox[{"Length", "@", "Wf"}]}], "]"}], ";", 
     RowBox[{"Thread", "[", 
      RowBox[{"Wf", "\[Rule]", "Wfval"}], "]"}]}], ")"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"subW0", ":=", 
   RowBox[{"subW", "[", "W0f", "]"}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.7005884883669167`*^9, 3.7005885599733353`*^9}, {
   3.700588869596386*^9, 3.700588874321349*^9}, {3.70058894512924*^9, 
   3.700588948425765*^9}, {3.700589117053347*^9, 3.700589176620331*^9}, {
   3.700589309833583*^9, 3.700589311238286*^9}, 3.70058954865143*^9, 
   3.70058970202309*^9, {3.700589831106209*^9, 3.700589855392948*^9}, {
   3.700590138211431*^9, 3.700590142777382*^9}, {3.700597118558473*^9, 
   3.700597140406551*^9}, {3.7005971809615917`*^9, 3.70059718967113*^9}, {
   3.700597260681491*^9, 3.7005972658562202`*^9}, {3.700597452507214*^9, 
   3.700597463314937*^9}, {3.700597843277192*^9, 3.700597846224703*^9}, {
   3.7005982955634117`*^9, 3.7005982973735123`*^9}, {3.7006060307518682`*^9, 
   3.70060604191295*^9}}],

Cell[BoxData[""], "Input",
 CellChangeTimes->{{3.700589916818342*^9, 3.700589973243835*^9}, {
   3.700590103086852*^9, 3.700590253106618*^9}, {3.7005904213609667`*^9, 
   3.700590432103702*^9}, {3.700590512801*^9, 3.7005905308022118`*^9}, {
   3.7005905713129263`*^9, 3.700590625224907*^9}, {3.700597091751734*^9, 
   3.700597093269944*^9}, 3.7005971795343447`*^9}]
}, Open  ]],

Cell[CellGroupData[{

Cell["Optimizer setup", "Section",
 CellChangeTimes->{{3.700591671252442*^9, 3.700591674329764*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{
   "Applies", " ", "single", " ", "step", " ", "of", " ", "optimization"}], 
   " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"step", "[", 
      RowBox[{"x_", ",", "lr_", ",", "pre_", ",", "grad_", ",", "lossFunc_"}],
       "]"}], ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"pointsList", "=", 
         RowBox[{"pointsList", "~", "Append", "~", "x"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"gradList", "=", 
         RowBox[{"gradList", "~", "Append", "~", "grad"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"preList", "=", 
         RowBox[{"preList", "~", "Append", "~", "pre"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"lossList", "=", 
         RowBox[{"lossList", "~", "Append", "~", 
          RowBox[{"lossFunc", "[", "x", "]"}]}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"x", "-", 
         RowBox[{"lr", "*", 
          RowBox[{"pre", ".", "grad"}]}]}]}]}], "\[IndentingNewLine]", 
      "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"resetStep", ":=", 
     RowBox[{"(", 
      RowBox[{
       RowBox[{
        RowBox[{"{", 
         RowBox[{
         "pointsList", ",", " ", "gradList", ",", "preList", ",", " ", 
          "lossList"}], "}"}], "=", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", "}"}], ",", 
          RowBox[{"{", "}"}], ",", 
          RowBox[{"{", "}"}], ",", 
          RowBox[{"{", "}"}]}], "}"}]}], ";", "W0f"}], ")"}]}], 
    ";"}]}]}]], "Input",
 CellChangeTimes->{{3.700591706849535*^9, 3.700591714014675*^9}, 
   3.700607943668601*^9, {3.700691600487438*^9, 3.700691608269718*^9}}]
}, Open  ]],

Cell[CellGroupData[{

Cell["Optimizer experiments", "Section",
 CellChangeTimes->{{3.700591718660655*^9, 3.700591721084391*^9}}],

Cell[CellGroupData[{

Cell["Gradient Descent", "Subsection",
 CellChangeTimes->{{3.7005917502542553`*^9, 3.700591760953086*^9}}],

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"optimizeGradient", "[", 
    RowBox[{"lr_", ",", "iters_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", "w", "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"w", "=", "resetStep"}], ";", "\[IndentingNewLine]", 
      RowBox[{"For", "[", 
       RowBox[{
        RowBox[{"iter", "=", "1"}], ",", 
        RowBox[{"iter", "\[LessEqual]", "iters"}], ",", 
        RowBox[{"iter", "++"}], ",", "\[IndentingNewLine]", 
        RowBox[{"w", "=", 
         RowBox[{"step", "[", 
          RowBox[{"w", ",", "lr", ",", "pre0", ",", 
           RowBox[{"gradF", "[", "w", "]"}], ",", "lossF"}], "]"}]}]}], 
       "\[IndentingNewLine]", "]"}], ";"}]}], "\[IndentingNewLine]", "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"optimizeGradient", "[", 
    RowBox[{"1.", ",", "20"}], "]"}], ";"}], "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"Export", "[", 
     RowBox[{
     "\"\<~/git/whitening/exp/data/rotations_simple_gradient_losses.csv\>\"", 
      ",", "lossList"}], "]"}], ";"}], "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{"ListPlot", "[", 
  RowBox[{"lossList", ",", 
   RowBox[{"PlotRange", "\[Rule]", "All"}]}], "]"}]}], "Input",
 CellChangeTimes->{{3.700591723522081*^9, 3.7005917343542852`*^9}, {
  3.700596999916737*^9, 3.700597043318482*^9}, {3.700598151854013*^9, 
  3.7005981808563557`*^9}, {3.700606015555622*^9, 3.700606016464902*^9}}],

Cell[BoxData[
 GraphicsBox[{{}, {{}, 
    {RGBColor[0.368417, 0.506779, 0.709798], PointSize[0.012833333333333334`],
      AbsoluteThickness[1.6], PointBox[CompressedData["
1:eJxTTMoPSmViYGAQAWIQDQEf7G9MLr2582qbPVTAoem2sfnq0hoon8Ph8eoY
NcfphVC+gMNbz4RdO0NToHwRhx9B9kpSMlFQvoTDouUKLqXx/lC+jIP6qVrz
sihXKF/Bwb5jyjqzY9ZQvpLDI9OoI6lSJlC+isMvIYvZ1Z06UL6ag3Q7Xxg7
sxqUr+FwaM7Wu02cilC+loPuseJPC/lkoHwdh3JxPt8JNeJQvp6D/f1p251b
RaB8A4fD4euNDZyEoHxDh9cic547rReA8o0clsyMF85+xQflGzt8Lz7MnCjM
C+WbOPx1X+g7fQq3PQBzzEvs
      "]]}, {}}, {}, {}, {{}, {}}},
  AspectRatio->NCache[GoldenRatio^(-1), 0.6180339887498948],
  Axes->{True, True},
  AxesLabel->{None, None},
  AxesOrigin->{0.703125, 0},
  DisplayFunction->Identity,
  Frame->{{False, False}, {False, False}},
  FrameLabel->{{None, None}, {None, None}},
  FrameTicks->{{Automatic, Automatic}, {Automatic, Automatic}},
  GridLines->{None, None},
  GridLinesStyle->Directive[
    GrayLevel[0.5, 0.4]],
  ImagePadding->All,
  Method->{"CoordinatesToolOptions" -> {"DisplayFunction" -> ({
        (Part[{{Identity, Identity}, {Identity, Identity}}, 1, 2][#]& )[
         Part[#, 1]], 
        (Part[{{Identity, Identity}, {Identity, Identity}}, 2, 2][#]& )[
         Part[#, 2]]}& ), "CopiedValueFunction" -> ({
        (Part[{{Identity, Identity}, {Identity, Identity}}, 1, 2][#]& )[
         Part[#, 1]], 
        (Part[{{Identity, Identity}, {Identity, Identity}}, 2, 2][#]& )[
         Part[#, 2]]}& )}},
  PlotRange->{{1., 20.}, {0, 0.011149837445097718`}},
  PlotRangeClipping->True,
  PlotRangePadding->{{
     Scaled[0.02], 
     Scaled[0.02]}, {
     Scaled[0.02], 
     Scaled[0.05]}},
  Ticks->{Automatic, Automatic}]], "Output",
 CellChangeTimes->{
  3.700591734918679*^9, {3.7005970012360163`*^9, 3.70059700763542*^9}, 
   3.700597044679034*^9, 3.7005972062987432`*^9, 3.7005978647959433`*^9, {
   3.70059815383001*^9, 3.7005981816485786`*^9}, 3.700680268710886*^9, 
   3.700680451234383*^9}]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData["lossList"], "Input",
 CellChangeTimes->{{3.7005985289134893`*^9, 3.7005985301687193`*^9}}],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{
  "0.011149837445097718`", ",", "0.006948155222963661`", ",", 
   "0.0042946381488872835`", ",", "0.002482283353864681`", ",", 
   "0.0015936141216929527`", ",", "0.0009574244106762451`", ",", 
   "0.0006516530256546791`", ",", "0.0004238017559875552`", ",", 
   "0.00030674919649062275`", ",", "0.00021772035471214602`", ",", 
   "0.00016793694069599453`", ",", "0.00012998316274634962`", ",", 
   "0.00010702956625487847`", ",", "0.00008959418052087257`", ",", 
   "0.00007827974140794685`", ",", "0.00006965083313956095`", ",", 
   "0.00006364675382649106`", ",", "0.00005896701115641896`", ",", 
   "0.00005545749488231743`", ",", "0.00005260550251819094`"}], 
  "}"}]], "Output",
 CellChangeTimes->{3.700598530402996*^9}]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["Newton's method", "Subsection",
 CellChangeTimes->{{3.700591766048594*^9, 3.700591774395926*^9}, 
   3.700591894576791*^9}],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"Export", "[", 
     RowBox[{
     "\"\<~/git/whitening/exp/data/rotations_simple_newton_hess0.csv\>\"", 
      ",", 
      RowBox[{"hessF", "[", "W0f", "]"}]}], "]"}], ";"}], "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"Export", "[", 
     RowBox[{
     "\"\<~/git/whitening/exp/data/rotations_simple_newton_ihess0.csv\>\"", 
      ",", 
      RowBox[{"ihessF", "[", "W0f", "]"}]}], "]"}], ";"}], "*)"}]}]], "Input",\

 CellChangeTimes->{{3.700600978282961*^9, 3.7006009928159943`*^9}, {
  3.7006013457762957`*^9, 3.7006013509175863`*^9}, {3.700606048707678*^9, 
  3.700606052217361*^9}}],

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"ihessF", "[", "W_", "]"}], ":=", 
   RowBox[{"PseudoInverse", "@", 
    RowBox[{"hessF", "@", "W"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"optimizeNewton", "[", 
    RowBox[{"lr_", ",", "iters_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", "w", "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"w", "=", "resetStep"}], ";", "\[IndentingNewLine]", 
      RowBox[{"For", "[", 
       RowBox[{
        RowBox[{"iter", "=", "1"}], ",", 
        RowBox[{"iter", "\[LessEqual]", "iters"}], ",", 
        RowBox[{"iter", "++"}], ",", "\[IndentingNewLine]", 
        RowBox[{"w", "=", 
         RowBox[{"step", "[", 
          RowBox[{"w", ",", "lr", ",", 
           RowBox[{"ihessF", "[", "w", "]"}], ",", 
           RowBox[{"gradF", "[", "w", "]"}], ",", "lossF"}], "]"}]}]}], 
       "\[IndentingNewLine]", "]"}], ";"}]}], "\[IndentingNewLine]", "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"optimizeNewton", "[", 
    RowBox[{"1.", ",", "10"}], "]"}], ";"}], "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"Export", "[", 
     RowBox[{
     "\"\<~/git/whitening/exp/data/rotations_simple_newton_losses.csv\>\"", 
      ",", "lossList"}], "]"}], ";"}], "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{"ListPlot", "[", 
  RowBox[{"lossList", ",", 
   RowBox[{"PlotRange", "\[Rule]", "All"}]}], "]"}]}], "Input",
 CellChangeTimes->{{3.7005917804920893`*^9, 3.7005918720000153`*^9}, {
  3.7006024990293427`*^9, 3.700602501934108*^9}, {3.700602665069687*^9, 
  3.700602671156176*^9}, {3.700606021887569*^9, 3.700606023090884*^9}}],

Cell[BoxData[
 GraphicsBox[{{}, {{}, 
    {RGBColor[0.368417, 0.506779, 0.709798], PointSize[0.012833333333333334`],
      AbsoluteThickness[1.6], 
     PointBox[{{1., 0.011149837445097718`}, {2., 0.030865770418542694`}, {3., 
      0.004625711296960099}, {4., 0.00002512293544325525}, {5., 
      1.3850774798914361`*^-9}, {6., 1.3238274753020383`*^-17}, {7., 
      2.3911924892336586`*^-31}, {8., 2.055749659701088*^-32}, {9., 
      1.7888578991265507`*^-33}, {10., 
      1.7888578991265507`*^-33}}]}, {}}, {}, {}, {{}, {}}},
  AspectRatio->NCache[GoldenRatio^(-1), 0.6180339887498948],
  Axes->{True, True},
  AxesLabel->{None, None},
  AxesOrigin->{0.8593750000000001, 0},
  DisplayFunction->Identity,
  Frame->{{False, False}, {False, False}},
  FrameLabel->{{None, None}, {None, None}},
  FrameTicks->{{Automatic, Automatic}, {Automatic, Automatic}},
  GridLines->{None, None},
  GridLinesStyle->Directive[
    GrayLevel[0.5, 0.4]],
  ImagePadding->All,
  Method->{"CoordinatesToolOptions" -> {"DisplayFunction" -> ({
        (Part[{{Identity, Identity}, {Identity, Identity}}, 1, 2][#]& )[
         Part[#, 1]], 
        (Part[{{Identity, Identity}, {Identity, Identity}}, 2, 2][#]& )[
         Part[#, 2]]}& ), "CopiedValueFunction" -> ({
        (Part[{{Identity, Identity}, {Identity, Identity}}, 1, 2][#]& )[
         Part[#, 1]], 
        (Part[{{Identity, Identity}, {Identity, Identity}}, 2, 2][#]& )[
         Part[#, 2]]}& )}},
  PlotRange->{{1., 10.}, {0, 0.030865770418542694`}},
  PlotRangeClipping->True,
  PlotRangePadding->{{
     Scaled[0.02], 
     Scaled[0.02]}, {
     Scaled[0.02], 
     Scaled[0.05]}},
  Ticks->{Automatic, Automatic}]], "Output",
 CellChangeTimes->{{3.700591842653554*^9, 3.7005918970893784`*^9}, {
   3.700602488125052*^9, 3.700602502801003*^9}, 3.700602672172426*^9, 
   3.700680272389578*^9, 3.700680454452467*^9}]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData["lossList"], "Input",
 CellChangeTimes->{{3.7006024835998173`*^9, 3.700602485686352*^9}}],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{
  "0.011149837445097718`", ",", "0.030865770418542694`", ",", 
   "0.004625711296960099`", ",", "0.00002512293544325525`", ",", 
   "1.3850774798914361`*^-9", ",", "1.3238274753020383`*^-17", ",", 
   "2.3911924892336586`*^-31", ",", "2.055749659701088`*^-32", ",", 
   "1.7888578991265507`*^-33", ",", "1.7888578991265507`*^-33"}], 
  "}"}]], "Output",
 CellChangeTimes->{3.700602489446802*^9}]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["Newton' s method with own implementation", "Subsection",
 CellChangeTimes->{{3.700591918979187*^9, 3.700591933272175*^9}}],

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{
  RowBox[{"myHess0", "=", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{"hessBlock", "[", 
      RowBox[{"i", ",", "j"}], "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"i", ",", "1", ",", "n"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"j", ",", "1", ",", "n"}], "}"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"myhessF", "[", "W_", "]"}], ":=", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{"ArrayFlatten", "[", "myHess0", "]"}], "/.", "subX"}], "/.", 
     "subY"}], "/.", 
    RowBox[{"subW", "[", "W", "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"myihessF", "[", "W_", "]"}], ":=", 
   RowBox[{"PseudoInverse", "[", 
    RowBox[{"myhessF", "[", "W", "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ihessF", "[", "W0f", "]"}], "\[DotEqual]", 
  RowBox[{"myihessF", "[", "W0f", "]"}]}]}], "Input",
 CellChangeTimes->{{3.7005923670631723`*^9, 3.700592374583638*^9}, {
  3.700592493690999*^9, 3.70059256557535*^9}, {3.700592901650091*^9, 
  3.700592901851243*^9}, {3.700680296626075*^9, 3.700680296839879*^9}}],

Cell[BoxData["True"], "Output",
 CellChangeTimes->{
  3.70059290403487*^9, {3.70068029084685*^9, 3.700680298349897*^9}, 
   3.700680417509596*^9, {3.700681515339896*^9, 3.700681519234227*^9}}]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"optimizeNewton2", "[", 
    RowBox[{"lr_", ",", "iters_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", "w", "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"w", "=", "resetStep"}], ";", "\[IndentingNewLine]", 
      RowBox[{"For", "[", 
       RowBox[{
        RowBox[{"iter", "=", "1"}], ",", 
        RowBox[{"iter", "\[LessEqual]", "iters"}], ",", 
        RowBox[{"iter", "++"}], ",", "\[IndentingNewLine]", 
        RowBox[{"w", "=", 
         RowBox[{"step", "[", 
          RowBox[{"w", ",", "lr", ",", 
           RowBox[{"myihessF", "[", "w", "]"}], ",", 
           RowBox[{"gradF", "[", "w", "]"}], ",", "lossF"}], "]"}]}]}], 
       "\[IndentingNewLine]", "]"}], ";"}]}], "\[IndentingNewLine]", "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"optimizeNewton2", "[", 
   RowBox[{"1.", ",", "10"}], "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"ListPlot", "[", 
  RowBox[{"lossList", ",", 
   RowBox[{"PlotRange", "\[Rule]", "All"}]}], "]"}]}], "Input",
 CellChangeTimes->{{3.700592914058037*^9, 3.7005929234848413`*^9}, {
  3.700682084552697*^9, 3.700682106319232*^9}}],

Cell[BoxData[
 GraphicsBox[{{}, {{}, 
    {RGBColor[0.368417, 0.506779, 0.709798], PointSize[0.012833333333333334`],
      AbsoluteThickness[1.6], 
     PointBox[{{1., 0.011149837445097718`}, {2., 0.030865770418544075`}, {3., 
      0.004625711296960005}, {4., 0.00002512293544326222}, {5., 
      1.3850774801436398`*^-9}, {6., 1.3238273763299354`*^-17}, {7., 
      2.0737450676189564`*^-32}, {8., 3.9317408424834706`*^-32}, {9., 
      1.0358644298542129`*^-32}, {10., 
      3.21705532351121*^-33}}]}, {}}, {}, {}, {{}, {}}},
  AspectRatio->NCache[GoldenRatio^(-1), 0.6180339887498948],
  Axes->{True, True},
  AxesLabel->{None, None},
  AxesOrigin->{0.8593750000000001, 0},
  DisplayFunction->Identity,
  Frame->{{False, False}, {False, False}},
  FrameLabel->{{None, None}, {None, None}},
  FrameTicks->{{Automatic, Automatic}, {Automatic, Automatic}},
  GridLines->{None, None},
  GridLinesStyle->Directive[
    GrayLevel[0.5, 0.4]],
  ImagePadding->All,
  Method->{"CoordinatesToolOptions" -> {"DisplayFunction" -> ({
        (Part[{{Identity, Identity}, {Identity, Identity}}, 1, 2][#]& )[
         Part[#, 1]], 
        (Part[{{Identity, Identity}, {Identity, Identity}}, 2, 2][#]& )[
         Part[#, 2]]}& ), "CopiedValueFunction" -> ({
        (Part[{{Identity, Identity}, {Identity, Identity}}, 1, 2][#]& )[
         Part[#, 1]], 
        (Part[{{Identity, Identity}, {Identity, Identity}}, 2, 2][#]& )[
         Part[#, 2]]}& )}},
  PlotRange->{{1., 10.}, {0, 0.030865770418544075`}},
  PlotRangeClipping->True,
  PlotRangePadding->{{
     Scaled[0.02], 
     Scaled[0.02]}, {
     Scaled[0.02], 
     Scaled[0.05]}},
  Ticks->{Automatic, Automatic}]], "Output",
 CellChangeTimes->{
  3.700592924455564*^9, {3.700680287140772*^9, 3.700680300425325*^9}, 
   3.70068152315376*^9, {3.7006820825596046`*^9, 3.700682107249094*^9}}]
}, Open  ]]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["Block-diagonal Newton", "Section",
 CellChangeTimes->{{3.700680357296043*^9, 3.700680362122609*^9}, {
  3.700681873782058*^9, 3.7006818750749807`*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"myHess0", "=", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{"hessBlock", "[", 
      RowBox[{"i", ",", "j"}], "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"i", ",", "1", ",", "n"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"j", ",", "1", ",", "n"}], "}"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ihessBdF", "[", "W_", "]"}], ":=", 
   RowBox[{"ArrayFlatten", "[", 
    RowBox[{"blockDiagonalInverse", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"myHess0", "/.", "subX"}], "/.", "subY"}], "/.", 
      RowBox[{"subW", "[", "W", "]"}]}], "]"}], "]"}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.700681549187145*^9, 3.7006816679386663`*^9}, {
   3.700681749324808*^9, 3.700681772631887*^9}, 3.7006818784412394`*^9, {
   3.700681928850766*^9, 3.7006819292102633`*^9}}],

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"optimizeNewtonBd", "[", 
    RowBox[{"lr_", ",", "iters_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", "w", "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"w", "=", "resetStep"}], ";", "\[IndentingNewLine]", 
      RowBox[{"For", "[", 
       RowBox[{
        RowBox[{"iter", "=", "1"}], ",", 
        RowBox[{"iter", "\[LessEqual]", "iters"}], ",", 
        RowBox[{"iter", "++"}], ",", "\[IndentingNewLine]", 
        RowBox[{"w", "=", 
         RowBox[{"step", "[", 
          RowBox[{"w", ",", "lr", ",", 
           RowBox[{"ihessBdF", "[", "w", "]"}], ",", 
           RowBox[{"gradF", "[", "w", "]"}], ",", "lossF"}], "]"}]}]}], 
       "\[IndentingNewLine]", "]"}], ";"}]}], "\[IndentingNewLine]", "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"optimizeNewtonBd", "[", 
   RowBox[{".5", ",", "10"}], "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Export", "[", 
   RowBox[{
   "\"\<~/git/whitening/exp/data/rotations_simple_newtonbd_losses.csv\>\"", 
    ",", "lossList"}], "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"ListPlot", "[", 
  RowBox[{"lossList", ",", 
   RowBox[{"PlotRange", "\[Rule]", "All"}]}], "]"}]}], "Input",
 CellChangeTimes->{{3.700681912694003*^9, 3.7006819131340303`*^9}, {
  3.700681961959177*^9, 3.7006820624783907`*^9}, {3.7006821538196898`*^9, 
  3.700682165595706*^9}}],

Cell[BoxData[
 GraphicsBox[{{}, {{}, 
    {RGBColor[0.368417, 0.506779, 0.709798], PointSize[0.012833333333333334`],
      AbsoluteThickness[1.6], 
     PointBox[{{1., 0.011149837445097718`}, {2., 0.000017159125130450004`}, {
      3., 4.114449754470587*^-11}, {4., 2.336524218518533*^-22}, {5., 
      1.2145546175068912`*^-32}, {6., 2.408164746868571*^-33}, {7., 
      5.220022465673936*^-33}, {8., 5.86520899704366*^-33}, {9., 
      4.2955760923680624`*^-33}, {10., 
      3.361500069340253*^-33}}]}, {}}, {}, {}, {{}, {}}},
  AspectRatio->NCache[GoldenRatio^(-1), 0.6180339887498948],
  Axes->{True, True},
  AxesLabel->{None, None},
  AxesOrigin->{0.8593750000000001, 0},
  DisplayFunction->Identity,
  Frame->{{False, False}, {False, False}},
  FrameLabel->{{None, None}, {None, None}},
  FrameTicks->{{Automatic, Automatic}, {Automatic, Automatic}},
  GridLines->{None, None},
  GridLinesStyle->Directive[
    GrayLevel[0.5, 0.4]],
  ImagePadding->All,
  Method->{"CoordinatesToolOptions" -> {"DisplayFunction" -> ({
        (Part[{{Identity, Identity}, {Identity, Identity}}, 1, 2][#]& )[
         Part[#, 1]], 
        (Part[{{Identity, Identity}, {Identity, Identity}}, 2, 2][#]& )[
         Part[#, 2]]}& ), "CopiedValueFunction" -> ({
        (Part[{{Identity, Identity}, {Identity, Identity}}, 1, 2][#]& )[
         Part[#, 1]], 
        (Part[{{Identity, Identity}, {Identity, Identity}}, 2, 2][#]& )[
         Part[#, 2]]}& )}},
  PlotRange->{{1., 10.}, {0, 0.011149837445097718`}},
  PlotRangeClipping->True,
  PlotRangePadding->{{
     Scaled[0.02], 
     Scaled[0.02]}, {
     Scaled[0.02], 
     Scaled[0.05]}},
  Ticks->{Automatic, Automatic}]], "Output",
 CellChangeTimes->{{3.700681992764299*^9, 3.700682068229167*^9}, 
   3.700682126081962*^9, 3.700682269639689*^9}]
}, Open  ]]
}, Closed]],

Cell[CellGroupData[{

Cell["Kronecker factored Newton", "Section",
 CellChangeTimes->{{3.700686375284307*^9, 3.700686380849882*^9}}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{
    "Kronecker", " ", "factored", " ", "inverse", " ", "of", " ", "block", 
     " ", "i"}], ",", "i"}], " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"hessKfac", "[", 
      RowBox[{"W_", ",", "i_"}], "]"}], ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"aCov", ",", "bCov"}], "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{
         RowBox[{"Original", " ", 
          RowBox[{"term", ":", " ", 
           RowBox[{
            RowBox[{
             RowBox[{"(", 
              RowBox[{
               RowBox[{"A", "[", "i", "]"}], ".", 
               RowBox[{
                RowBox[{"A", "[", "i", "]"}], "\[Transpose]"}]}], ")"}], 
             "\[TensorProduct]", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{"Bn", "[", "i", "]"}], ".", 
               RowBox[{
                RowBox[{"Bn", "[", "j", "]"}], "\[Transpose]"}]}], ")"}]}], 
            "/", "dsize"}]}]}], ";"}], " ", "*)"}], "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"aCov", "=", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"A", "[", "i", "]"}], ".", 
             RowBox[{
              RowBox[{"A", "[", "i", "]"}], "\[Transpose]"}]}], "/.", 
            RowBox[{"subW", "[", "W", "]"}]}], "/.", "subX"}], "/.", 
          "subY"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"bCov", "=", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{
              RowBox[{"Bn", "[", "i", "]"}], ".", 
              RowBox[{
               RowBox[{"Bn", "[", "i", "]"}], "\[Transpose]"}]}], "/", 
             "dsize"}], "/.", 
            RowBox[{"subW", "[", "W", "]"}]}], "/.", "subX"}], "/.", 
          "subY"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"PseudoInverse", "[", "aCov", "]"}], "\[TensorProduct]", 
         RowBox[{"PseudoInverse", "[", "bCov", "]"}]}]}]}], 
      "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"myHess0", "=", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{"hessBlock", "[", 
        RowBox[{"i", ",", "j"}], "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"i", ",", "1", ",", "n"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"j", ",", "1", ",", "n"}], "}"}]}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"ihessKfacF", "[", "W_", "]"}], ":=", 
     RowBox[{"ArrayFlatten", "[", 
      RowBox[{"blockDiagonalKfacInverse", "[", 
       RowBox[{"W", ",", "myHess0", ",", "hessKfac"}], "]"}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"optimizeNewtonKfac", "[", 
      RowBox[{"lr_", ",", "iters_"}], "]"}], ":=", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", "w", "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"w", "=", "resetStep"}], ";", "\[IndentingNewLine]", 
        RowBox[{"For", "[", 
         RowBox[{
          RowBox[{"iter", "=", "1"}], ",", 
          RowBox[{"iter", "\[LessEqual]", "iters"}], ",", 
          RowBox[{"iter", "++"}], ",", "\[IndentingNewLine]", 
          RowBox[{"w", "=", 
           RowBox[{"step", "[", 
            RowBox[{"w", ",", "lr", ",", 
             RowBox[{"ihessKfacF", "[", "w", "]"}], ",", 
             RowBox[{"gradF", "[", "w", "]"}], ",", "lossF"}], "]"}]}]}], 
         "\[IndentingNewLine]", "]"}], ";"}]}], "\[IndentingNewLine]", 
      "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"optimizeNewtonKfac", "[", 
     RowBox[{".5", ",", "10"}], "]"}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Export", "[", 
     RowBox[{
     "\"\<~/git/whitening/exp/data/rotations_simple_newtonkfac_losses.csv\>\"\
", ",", "lossList"}], "]"}], ";"}], "\[IndentingNewLine]", 
   RowBox[{"ListPlot", "[", 
    RowBox[{"lossList", ",", 
     RowBox[{"PlotRange", "\[Rule]", "All"}]}], "]"}]}]}]], "Input",
 CellChangeTimes->{{3.700686484853498*^9, 3.700686675699067*^9}, {
   3.70068672903651*^9, 3.700686737055945*^9}, {3.700686913501009*^9, 
   3.700686916066022*^9}, {3.7006869830720167`*^9, 3.7006869880663157`*^9}, {
   3.7006870422126017`*^9, 3.7006870441023684`*^9}, {3.7006871254333687`*^9, 
   3.7006871393013353`*^9}, 3.700687199839829*^9, {3.700687697935052*^9, 
   3.7006877973174753`*^9}}],

Cell[BoxData[
 GraphicsBox[{{}, {{}, 
    {RGBColor[0.368417, 0.506779, 0.709798], PointSize[0.012833333333333334`],
      AbsoluteThickness[1.6], 
     PointBox[{{1., 0.011149837445097718`}, {2., 0.000017159125130453663`}, {
      3., 4.114449754491424*^-11}, {4., 2.3365282297080466`*^-22}, {5., 
      6.883544455138411*^-33}, {6., 1.5673759555220185`*^-33}, {7., 
      4.379233674327383*^-33}, {8., 2.9829344646466368`*^-33}, {9., 
      3.4547873010215094`*^-33}, {10., 
      2.4821926791059555`*^-33}}]}, {}}, {}, {}, {{}, {}}},
  AspectRatio->NCache[GoldenRatio^(-1), 0.6180339887498948],
  Axes->{True, True},
  AxesLabel->{None, None},
  AxesOrigin->{0.8593750000000001, 0},
  DisplayFunction->Identity,
  Frame->{{False, False}, {False, False}},
  FrameLabel->{{None, None}, {None, None}},
  FrameTicks->{{Automatic, Automatic}, {Automatic, Automatic}},
  GridLines->{None, None},
  GridLinesStyle->Directive[
    GrayLevel[0.5, 0.4]],
  ImagePadding->All,
  Method->{"CoordinatesToolOptions" -> {"DisplayFunction" -> ({
        (Part[{{Identity, Identity}, {Identity, Identity}}, 1, 2][#]& )[
         Part[#, 1]], 
        (Part[{{Identity, Identity}, {Identity, Identity}}, 2, 2][#]& )[
         Part[#, 2]]}& ), "CopiedValueFunction" -> ({
        (Part[{{Identity, Identity}, {Identity, Identity}}, 1, 2][#]& )[
         Part[#, 1]], 
        (Part[{{Identity, Identity}, {Identity, Identity}}, 2, 2][#]& )[
         Part[#, 2]]}& )}},
  PlotRange->{{1., 10.}, {0, 0.011149837445097718`}},
  PlotRangeClipping->True,
  PlotRangePadding->{{
     Scaled[0.02], 
     Scaled[0.02]}, {
     Scaled[0.02], 
     Scaled[0.05]}},
  Ticks->{Automatic, Automatic}]], "Output",
 CellChangeTimes->{3.700687049273777*^9, 3.7006871412967167`*^9, 
  3.700687200602606*^9, 3.700687830014756*^9}]
}, Open  ]]
}, Open  ]]
}, Open  ]]
},
WindowSize->{883, 1107},
WindowMargins->{{1377, Automatic}, {462, Automatic}},
FrontEndVersion->"11.0 for Mac OS X x86 (32-bit, 64-bit Kernel) (September \
21, 2016)",
StyleDefinitions->"Default.nb"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[CellGroupData[{
Cell[580, 22, 98, 1, 32, "Input"],
Cell[681, 25, 1080, 29, 35, "Output"]
}, Open  ]],
Cell[CellGroupData[{
Cell[1798, 59, 92, 1, 92, "Title"],
Cell[CellGroupData[{
Cell[1915, 64, 68, 1, 32, "Input"],
Cell[1986, 67, 1055, 28, 35, "Output"]
}, Open  ]],
Cell[CellGroupData[{
Cell[3078, 100, 147, 2, 64, "Section"],
Cell[CellGroupData[{
Cell[3250, 106, 30839, 779, 2716, "Code",
 InitializationCell->False],
Cell[34092, 887, 589, 9, 32, "Output"],
Cell[34684, 898, 1143, 25, 74, "Output"]
}, Open  ]]
}, Open  ]],
Cell[CellGroupData[{
Cell[35876, 929, 95, 1, 64, "Section"],
Cell[35974, 932, 5193, 141, 558, "Input"],
Cell[41170, 1075, 365, 5, 32, "Input"]
}, Open  ]],
Cell[CellGroupData[{
Cell[41572, 1085, 100, 1, 64, "Section"],
Cell[41675, 1088, 1807, 49, 222, "Input"]
}, Open  ]],
Cell[CellGroupData[{
Cell[43519, 1142, 106, 1, 64, "Section"],
Cell[CellGroupData[{
Cell[43650, 1147, 106, 1, 44, "Subsection"],
Cell[CellGroupData[{
Cell[43781, 1152, 1485, 36, 201, "Input"],
Cell[45269, 1190, 1943, 44, 234, "Output"]
}, Open  ]],
Cell[CellGroupData[{
Cell[47249, 1239, 104, 1, 32, "Input"],
Cell[47356, 1242, 766, 14, 75, "Output"]
}, Open  ]]
}, Open  ]],
Cell[CellGroupData[{
Cell[48171, 1262, 129, 2, 44, "Subsection"],
Cell[48303, 1266, 686, 20, 54, "Input"],
Cell[CellGroupData[{
Cell[49014, 1290, 1689, 42, 222, "Input"],
Cell[50706, 1334, 1866, 41, 234, "Output"]
}, Open  ]],
Cell[CellGroupData[{
Cell[52609, 1380, 102, 1, 32, "Input"],
Cell[52714, 1383, 435, 9, 58, "Output"]
}, Open  ]]
}, Open  ]],
Cell[CellGroupData[{
Cell[53198, 1398, 128, 1, 44, "Subsection"],
Cell[CellGroupData[{
Cell[53351, 1403, 1141, 31, 96, "Input"],
Cell[54495, 1436, 192, 3, 32, "Output"]
}, Open  ]],
Cell[CellGroupData[{
Cell[54724, 1444, 1191, 29, 180, "Input"],
Cell[55918, 1475, 1841, 41, 234, "Output"]
}, Open  ]]
}, Open  ]]
}, Open  ]],
Cell[CellGroupData[{
Cell[57820, 1523, 157, 2, 64, "Section"],
Cell[57980, 1527, 858, 23, 54, "Input"],
Cell[CellGroupData[{
Cell[58863, 1554, 1432, 35, 201, "Input"],
Cell[60298, 1591, 1791, 40, 234, "Output"]
}, Open  ]]
}, Closed]],
Cell[CellGroupData[{
Cell[62138, 1637, 110, 1, 50, "Section"],
Cell[CellGroupData[{
Cell[62273, 1642, 4563, 117, 432, "Input"],
Cell[66839, 1761, 1797, 40, 234, "Output"]
}, Open  ]]
}, Open  ]]
}, Open  ]]
}
]
*)

