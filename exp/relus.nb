(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 11.0' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[      7761,        228]
NotebookOptionsPosition[      7282,        206]
NotebookOutlinePosition[      7643,        222]
CellTagsIndexPosition[      7600,        219]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{

Cell[CellGroupData[{
Cell["Add ReLU", "Title",
 CellChangeTimes->{{3.700229050241454*^9, 3.700229058879463*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"relu", "[", "A_", "]"}], ":=", 
  RowBox[{"MapThread", "[", 
   RowBox[{"Max", ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"Array", "[", 
       RowBox[{
        RowBox[{"0", "&"}], ",", 
        RowBox[{"Dimensions", "@", "A"}]}], "]"}], ",", "A"}], "}"}], ",", 
    RowBox[{"Length", "[", 
     RowBox[{"Dimensions", "[", "A", "]"}], "]"}]}], "]"}]}]], "Input",
 CellChangeTimes->{{3.7002296880622187`*^9, 3.700229692594705*^9}, {
  3.700229734353146*^9, 3.700229734864191*^9}, {3.700229773069181*^9, 
  3.7002298171377707`*^9}, {3.700229902534886*^9, 3.700229907289122*^9}}],

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"reluDot", "[", 
    RowBox[{"A_", ",", "B_"}], "]"}], ":=", 
   RowBox[{"relu", "[", 
    RowBox[{"A", ".", "B"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"errEq", ":=", 
   RowBox[{"Y", "-", 
    RowBox[{"Fold", "[", 
     RowBox[{"reluDot", ",", 
      RowBox[{
       RowBox[{"Reverse", "[", "vars", "]"}], "~", "Join", "~", 
       RowBox[{"{", 
        RowBox[{"makeW", "[", "0", "]"}], "}"}]}]}], "]"}]}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"lossEq", ":=", 
    RowBox[{"take1", "[", 
     RowBox[{
      FractionBox["1", 
       RowBox[{"2", " ", "dsize"}]], 
      RowBox[{"errEq", ".", 
       RowBox[{"errEq", "\[Transpose]"}]}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"gradEq", "=", 
   RowBox[{"D", "[", 
    RowBox[{
     RowBox[{"lossf", "[", "Wf", "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"Wf", ",", "1"}], "}"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"gradf", "[", "Wf_", "]"}], ":=", 
   RowBox[{"gradEq", "/.", 
    RowBox[{"subW", "[", "Wf", "]"}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"lossf", "[", "Wf_", "]"}], ":=", 
    RowBox[{"(", 
     RowBox[{
      RowBox[{
       RowBox[{"lossEq", "/.", 
        RowBox[{"subW", "[", "Wf", "]"}]}], "/.", "subY"}], "/.", "subX"}], 
     ")"}]}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"optimizeRegular", "[", 
    RowBox[{"lr_", ",", "w0f_", ",", "iters_"}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", "wf", "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"{", 
        RowBox[{
        "pointList", ",", " ", "gradList", ",", "preList", ",", " ", 
         "lossList"}], "}"}], "=", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", "}"}], ",", 
         RowBox[{"{", "}"}], ",", 
         RowBox[{"{", "}"}], ",", 
         RowBox[{"{", "}"}]}], "}"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"wf", "=", "w0f"}], ";", "\[IndentingNewLine]", 
      RowBox[{"For", "[", 
       RowBox[{
        RowBox[{"iter", "=", "1"}], ",", 
        RowBox[{"iter", "\[LessEqual]", "iters"}], ",", 
        RowBox[{"iter", "++"}], ",", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"pointList", "=", 
          RowBox[{"pointList", "~", "Append", "~", "wf"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"gradList", "=", 
          RowBox[{"gradList", "~", "Append", "~", 
           RowBox[{"gradf", "[", "wf", "]"}]}]}], ";", "\[IndentingNewLine]", 
         
         RowBox[{"preList", "=", 
          RowBox[{"preList", "~", "Append", "~", 
           RowBox[{"ihessf", "[", "wf", "]"}]}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"lossList", "=", 
          RowBox[{"lossList", "~", "Append", "~", 
           RowBox[{"lossf", "[", "wf", "]"}]}]}], ";", "\[IndentingNewLine]", 
         
         RowBox[{"wf", "=", 
          RowBox[{"wf", "-", 
           RowBox[{"lr", "*", 
            RowBox[{"gradf", "[", "wf", "]"}]}]}]}]}]}], 
       "\[IndentingNewLine]", "]"}], ";"}]}], "\[IndentingNewLine]", "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"optimizeRegular", "[", 
   RowBox[{".5", ",", "W0f", ",", "5"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{"ListPlot", "[", 
  RowBox[{"lossList", ",", 
   RowBox[{"PlotRange", "\[Rule]", "All"}]}], "]"}]}], "Input",
 CellChangeTimes->{
  3.700229116220747*^9, {3.7002292325905447`*^9, 3.700229239893525*^9}, {
   3.700229288885085*^9, 3.700229327298996*^9}, {3.700229575131907*^9, 
   3.700229587451705*^9}, {3.7002299400050488`*^9, 3.700229944519908*^9}, {
   3.7002299785837507`*^9, 3.700229979619769*^9}, {3.700230569212451*^9, 
   3.700230582276251*^9}, 3.700230635105247*^9, 3.7002308820383177`*^9, {
   3.7002312076441183`*^9, 3.7002312302733793`*^9}}],

Cell[BoxData[
 GraphicsBox[{{}, {{}, 
    {RGBColor[0.368417, 0.506779, 0.709798], PointSize[0.012833333333333334`],
      AbsoluteThickness[1.6], 
     PointBox[{{1., 0.539407238442183}, {2., 0.25602697569303234`}, {3., 
      0.25684007554471705`}, {4., 0.24821162607798586`}, {5., 
      0.2478419509576688}}]}, {}}, {}, {}, {{}, {}}},
  AspectRatio->NCache[GoldenRatio^(-1), 0.6180339887498948],
  Axes->{True, True},
  AxesLabel->{None, None},
  AxesOrigin->{0.9375000000000001, 0},
  DisplayFunction->Identity,
  Frame->{{False, False}, {False, False}},
  FrameLabel->{{None, None}, {None, None}},
  FrameTicks->{{Automatic, Automatic}, {Automatic, Automatic}},
  GridLines->{None, None},
  GridLinesStyle->Directive[
    GrayLevel[0.5, 0.4]],
  ImagePadding->All,
  Method->{"CoordinatesToolOptions" -> {"DisplayFunction" -> ({
        (Part[{{Identity, Identity}, {Identity, Identity}}, 1, 2][#]& )[
         Part[#, 1]], 
        (Part[{{Identity, Identity}, {Identity, Identity}}, 2, 2][#]& )[
         Part[#, 2]]}& ), "CopiedValueFunction" -> ({
        (Part[{{Identity, Identity}, {Identity, Identity}}, 1, 2][#]& )[
         Part[#, 1]], 
        (Part[{{Identity, Identity}, {Identity, Identity}}, 2, 2][#]& )[
         Part[#, 2]]}& )}},
  PlotRange->{{1., 5.}, {0, 0.539407238442183}},
  PlotRangeClipping->True,
  PlotRangePadding->{{
     Scaled[0.02], 
     Scaled[0.02]}, {
     Scaled[0.02], 
     Scaled[0.05]}},
  Ticks->{Automatic, Automatic}]], "Output",
 CellChangeTimes->{
  3.7002292410914087`*^9, {3.700229297585156*^9, 3.7002293283604527`*^9}, {
   3.700229991366096*^9, 3.7002300028361*^9}, 3.700230595294004*^9, 
   3.7002306365557747`*^9, 3.700230730990424*^9, {3.700231220879345*^9, 
   3.700231232485466*^9}}]
}, Open  ]],

Cell[BoxData[
 RowBox[{
  RowBox[{"Export", "[", 
   RowBox[{
   "\"\<~/git/whitening/exp/data/natural_gradient_multilayer_losses_regular.\
csv\>\"", ",", "lossList"}], "]"}], ";"}]], "Input"]
}, Open  ]]
},
WindowSize->{808, 911},
WindowMargins->{{Automatic, 605}, {Automatic, 150}},
FrontEndVersion->"11.0 for Mac OS X x86 (32-bit, 64-bit Kernel) (September \
21, 2016)",
StyleDefinitions->"Default.nb"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[CellGroupData[{
Cell[580, 22, 91, 1, 92, "Title"],
Cell[674, 25, 620, 15, 32, "Input"],
Cell[CellGroupData[{
Cell[1319, 44, 3991, 109, 472, "Input"],
Cell[5313, 155, 1746, 40, 240, "Output"]
}, Open  ]],
Cell[7074, 198, 192, 5, 54, "Input"]
}, Open  ]]
}
]
*)

